\documentclass[a4paper]{amsproc}
\renewcommand\labelenumi{(\roman{enumi})}
\renewcommand\theenumi\labelenumi
\title{An Atomic Topos for Probability Theory}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{fontspec}
\usepackage[hcentering,bindingoffset=0mm]{geometry}
%\usepackage[hyphens]{url} \urlstyle{same}
\usepackage{tikz}
\usepackage{lscape}
\usepackage{mathtools}
\usetikzlibrary{cd}
%\usepackage[dvips]{graphicx} %% Package for inserting illustrations/figures

% I like how the sans serif doesn't stand out as much in this font.
\setmainfont{FreeSerif}

\theoremstyle{plain}
 \newtheorem{theorem}{Theorem}[section]
 \newtheorem{proposition}[theorem]{Proposition}
 \newtheorem{lemma}[theorem]{Lemma}
 \newtheorem{corollary}[theorem]{Corollary}
\theoremstyle{definition}
 \newtheorem{example}[theorem]{Example}
 \newtheorem{definition}[theorem]{Definition}
\theoremstyle{remark}
 \newtheorem{remark}[theorem]{Remark}
 \numberwithin{equation}{section}

% Some shortcuts
% \newcommand{\ob}[1]{ob(#1)}
\newcommand{\id}{\textup{id}}

\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Sh}{Sh}
\newcommand{\y}{\textit{y}}
% The star indicates that subscripts are to be typeset below the operator
% instead of to the right
\DeclareMathOperator*{\limit}{lim}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator{\Lan}{Lan}
\DeclareMathOperator{\eq}{eq}
\newcommand{\s}{\textsf{ }}

\newcommand{\Set}{\textup{\textsf{Set}}}
\newcommand{\FinProb}{\textup{\textsf{FinProb}}}
\newcommand{\BPAlg}{\textup{\textsf{BPAlg}}}
\newcommand{\Ind}{\textsf{Ind}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\Prob}{\mathfrak{Prob}}

\newcommand{\la}{\langle\,}
\newcommand{\ra}{\,\rangle}

\newcommand{\ldoub}{[\![}
\newcommand{\rdoub}{]\!]}
\makeatletter
\newcommand{\rmnum}[1]{\romannumeral #1}
\newcommand{\Rmnum}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother

\author{Adam Dauser, Adrian Marti}

\date{}
\begin{document}

\maketitle

\begin{abstract}
Inspired by probability, we introduce topos $\Prob$. %TODO do this but properly
\end{abstract}

\tableofcontents


\section{Introduction}

Talk about 'bookkeeping' in probability theory. Nobody cares about the choice of base $\sigma$-algebra, as long as it has good properties. Yet, a $\sigma$-algebra must be chosen. Probability theorists always quantify over a good class of $\sigma$-algebras. The domain of a random variable never gets fixed on a particular $\sigma$-algebra. One may try to exploit this by imposing restrictions(of functorial or topological nature) on how statements/sets may depend on the base $\sigma$-algebra. These techniques will lead to an approach to probability theory that works without a choice of $\sigma$-algebra. Outline the standard set up.

First technical improvement: Divide out null sets! (Explain this in detail) Define measure algebras and show how they interact with $\sigma$-algebras.

Step 3:  Intervals model Lebesgue interval. Give the definitions.

%logics
\indent Talk about how this is a substantial application justifying the use of geometric/infinitary logic, since first order logic doesn't suffice. Talk about how one can't even define probability intervals in first order logics. Completeness, Quantifier elimination.\newline
\indent To do this we use the topos $\Prob$. Shortly explain how models of the theory correspond to intervals and how other structure can be transported along that morphism. Here we give background to topos theory. Completeness comes from an 'open surjection' a map of topoi to $\Set$ that preserves and reflects this infinitary first order logics. Completeness legitimizes the belief that the underlying $\sigma$-algebra does not matter, to a certain extend(in the geometric logic sense). Explain enough to justify simple functions. I.e. the universal model. The simple functions are mapped to each other.
\begin{center}\textbf{ALWAYS EXPLAIN THE REASONING BEHIND ALL THE CONCEPTS WHICH APPEAR HERE}\end{center}
Also say that usual Galois theory a la SGA1 does not suffice to capture the group action flavour. The group is simple but profinite groups are completely determined by their closed normal subgroups (or smth. similar). State the main result (group of automorphisms ... commonly called measure preserving dynamical systems).\newline
\indent Combinatorial methods using 'multi-products'. We give a nice calculus of our topos using its "atoms". This also yields a description by a model of ZFA. \newline
\indent Hype!!! $L^p$ spaces and other outlook.

Somewhere in here we should definitely mention Olivia's bridges philosophy and how we give three very distinct site presentations (and the $\infty$-positivization) of $\Prob$.


\section{Conventions} \label{conventions}

When there is need to be completely formal, the $\limit$ and $\colim$ operators in our sheaf toposes will not be defined only 'up to isomorphism', but rather taken the to be canonical constructions in sheaf toposes given by sheafifying the (co-)limit taken pointwise is $\Set$. In case the sheaf topos is a presheaf topos, we will omit the sheafification step. The same will hold for Kan extensions, as in our examples these are always computed as (co-)limits. When considering what is traditionally thought of different 'representatives' of an isomorphism class given by a limit or colimit, we will formalize this as simply claiming that an object (together with a corresponding universal (co-)cone) \emph{has} a universal property.

This explicit approach clears up some of the confusion that arises when one thinks of e.g. a limit $\limit c_i$ simply as some sort of object defined only up to isomorphism that takes the form of the correct representative of the isomorphism class when convenient. Admittedly, this explicit viewpoint will only be taken in the rare occasion where one needs to prove that certain diagrams involving isomorphisms given by universal properties commute.

For a small category $\C$, we will denote the Yoneda embedding by $\y: \C \to \Set^{\C^{op}}$. For a morphism $f$ in $\C$, we will denote $\y(f)$ (also known as postcomposition) by $f_*$.

We will call a diagram
\[
\begin{tikzcd}
\alpha \arrow[r, "f"] & \beta \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \gamma
\end{tikzcd}
\]
in a category $\C$ a fork if $fg = hg$.


\section{A combinatorial construction of $\Prob$}

In this section we will introduce the topos $\Prob$, by exhibiting a site based on the following category of finite probability spaces.

\begin{definition}
\begin{enumerate}
\item A finite probability space is a finite set $X$ equipped with a map (called probability measure) $\mu: X \to \mathbb{R}_{>0}$ such that \\ $\sum_{x \in X} \mu(x) = 1$.
\item For a finite probability space $(X,\mu)$ and a subset $a \subset X$, we define $\mu(a) := \sum_{x \in a} \mu(x)$.
\item A map of finite probability spaces $(X,\mu) \to (Y,\nu)$ is defined as a map of finite sets $f: X \to Y$ that is measure-preserving, i.e. $\mu(f^{-1}(y)) = \nu(y)$. Denote the category of finite probability spaces by $\FinProb$.
\end{enumerate}
\end{definition}

Notice that all maps of finite probability spaces are surjective. Also notice that we do not allow elements of measure zero.

We want to consider the sheaf topos $\Sh(\FinProb, J_{at})$, where $J_{at}$ denotes the atomic topology. The atomic topology is defined by saying that every nonempty sieve is a cover. Checking that this actually yields a Grothendieck topology requires the base category to satisfy the right Ore condition.

\begin{theorem} \label{pullback_measure}
Given a diagram of finite probability spaces
\[
\begin{tikzcd}
                               & {(X_2,\mu_2)} \arrow[d, "g"] \\
{(X_1, \mu_1)} \arrow[r, "f"'] & {(Y,\mu)}
\end{tikzcd},
\]
the pullback of the finite sets carries a probability measure $\nu(x,y) := \frac{\mu_1(x) \mu_2(y)}{\mu(f x)}$ such that the diagram
\[
\begin{tikzcd}
{(X_1 \times_Y X_2, \nu)} \arrow[d, "p_1"'] \arrow[r, "p_2"] & {(X_2,\mu_2)} \arrow[d, "g"] \\
{(X_1, \mu_1)} \arrow[r, "f"']                               & {(Y,\mu)}
\end{tikzcd}
\]
commutes.

In particular, $\FinProb$ satisfies the right Ore condition.
\end{theorem}
\begin{proof}
The only thing to show is that the projections are measure-preserving, since that also implies that $\nu$ is actually a measure. So let $x \in X_1$ and $u := f(x)$.
\begin{align*}
\sum_{(x,y) \in p_1^{-1} x} \nu(x,y) &= \sum_{y \in g^{-1} u} \frac{\mu_1(x)\mu_2(y)}{\mu u} \\
&= \frac{\mu_1 x}{\mu u} \sum_{y \in g^{-1} u} \mu_2 y \\
&= \frac{\mu_2 x}{\mu u} \mu u \\
&= \mu_2 x
\end{align*}
\end{proof}

Now we can introduce the topos that we wish to study in this paper.

\begin{definition}
Define the topos $\Prob$ to be $\Sh(\FinProb, J_{at})$.
\end{definition}

Much of this paper is dedicated to finding other equivalent ways of describing $\Prob$. When we wish to leave the particular description of $\Prob$ vague, we will use the notation $\Prob$.

III.4, Lemma 2 in \cite{sheaves_geometry_logic} gives us a convenient condition for checking whether a presheaf is actually a sheaf over the atomic topology:

A presheaf $\mathcal{F}$ on a $\FinProb$ is a sheaf over the atomic topology if and only if one can check that for any morphism $f: \alpha \to \beta$ and any $a \in \mathcal{F}(\alpha)$: If for all diagrams

\[
\begin{tikzcd}
\gamma \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \alpha \arrow[r, "f"] & \beta
\end{tikzcd}
\]
with $f g = f h$ we have that $\mathcal{F}(g)(a) = \mathcal{F}(h)(a)$, then there is a unique lift $b \in \mathcal{F}(\beta)$ with the property that $\mathcal{F}(f)(b) = a$.

In some cases, one can prove the following condition that is much stronger than being a sheaf. It is especially useful when the sheaf doesn't really use the measure in its definition.

\begin{proposition} \label{sheaf_condition_weak}
Let $\mathcal{F}$ be a presheaf on $\FinProb$. If for all morphisms $f: (X,\mu) \to (Y,\nu)$ the fork
\[
\begin{tikzcd} \mathcal{F} (Y,\nu) \arrow[r, "\mathcal{F}f"] & \mathcal{F} (X,\mu) \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \mathcal{F} (X \times_f X,\bar{\mu})
\end{tikzcd}
\]
is an equalizer, where $\bar{\mu}$ is as in \ref{pullback_measure}, then $\mathcal{F}$ is a sheaf.
\end{proposition}
\begin{proof}
This is the condition from \cite{sheaves_geometry_logic} described above, but weakened by choosing $\gamma = (X \times_f X,\bar{\mu})$.
\end{proof}

We can now check the sheaf condition for the vast majority of sheaves that we are interested in:

\begin{proposition}\label{subcanonical}
    \begin{enumerate}
        \item All morphisms in $\FinProb$ are regular epimorphisms.
        \item The representable functors are sheaves, i.e. $J_{at}$ is a subcanonical topology on $\FinProb$.
        \item All coproducts of representable functors are sheaves.
    \end{enumerate}
\end{proposition}
\begin{proof}
    \begin{enumerate}
        \item We need to show that every morphism $f:(X,\mu)\rightarrow (Y, \nu)$ comes from a coequalizer. Our construction of the measure on the pullback in \ref{pullback_measure} gives us the following fork:
        \[
        \begin{tikzcd}[column sep=large]
        (X \times_Y X, \bar{\mu}) \arrow[r, shift left=2] \arrow[r, shift right] & (X,\mu) \arrow[r, "f", two heads] & (Y,\nu)
        \end{tikzcd}
        \]
        Since this is clearly a coequalizer on the underlying sets, the only thing to check is that the uniquely induced maps are measure-preserving. This is straightforward to verify.

        \item Checking that the representable functors are sheaves by using \ref{sheaf_condition_weak} reduces to the fact that the fork above is a coequalizer diagram.

        \item We check the sheaf condition \ref{sheaf_condition_weak} for a coproduct of representables. But since we already know this sheaf condition holds for representables, we merely need to note that equalizers of coproducts are coproducts of equalizers in presheaf topoi (since this fact can be checked pointwise in set).
    \end{enumerate}
\end{proof}

Note that the second and third part are merely formal consequences of the first one. Any category (satisfying the right Ore condition) such that the first part holds, also satisfies the second and the third part.

The representable functors are atoms in $\Prob$, i.e. objects whose only subobjects are the initial object and the object itself. A crucial property of an atomic topos (a topos of sheaves over a category equipped with the atomic topology) is that every object is a coproduct of atoms. So the natural question arises: Are there more atoms than the representables? In \ref{atoms} we will give a complete list of the atoms and see that the representables are not all of them.


\subsection{Finite Limits}

Our goal in the next section will be to understand the logic of $\Prob$. Successfully doing so requires a very good understanding of what the flat functors on $\FinProb$ are and thus also requires a good understanding of finite limits in this category. This will be our goal in this subsection.

But the situation is not as simple as one may hope: these finite limits only very rarely exist. Naturally, the presheaves $\Set^{\FinProb^{op}}$ actually do have these finite limits, and we will see that they have a straightforward form. This will give rise to a weakened form of the notion of a limit, which we will call multi-limit. It will be essential in all our discussions about logic.

The most surprising part about multi-limits will be their nontrivial combinatorial content and their connection to polytopes. We will see that an many statements in this paper are proved by using computations with multi-limits and polytopes.

We introduce convenient notation to emphazise the combinatorial nature of finite probability spaces.

\begin{definition}[U-notation] \label{U-notation}
\begin{enumerate}
\item For $r_1, \cdots r_n \in [0,1]$ such that $r_1 + \cdots + r_n = 1$, denote by $U_{r_1 \cdots r_n}$ or simply by $U_{r_i}$ the finite probability space on the set
\[
\{i \mid r_i \neq 0 \}
\]
equipped with the measure $\mu(i) = r_i$.
\item We will use the shorthand $U_r := U_{r,r-1}$ for $r \in [0,1]$.
\end{enumerate}
\end{definition}

This is notation for finite probability spaces in the sense that the $U_{r_i}$ form a skeleton of $\FinProb$.

\begin{remark}\label{classifying_partitions}
    Notice that for a finite probability space $(X,\mu)$, $\Hom((X,\mu), U_{r_i})$ precisely consists of partitions $(a_i)$ of the set $X$ with $\mu(a_i) = r_i$. This may seem like quite a harmless observation, but being aware of this fact makes some calculations with $\y U_{r_i}$ much more intuitive. Moreover, we will later see that the $U_{r_i}$ in fact precisely correspond to logical formulas specifying a partition with fixed measures. We will often identify maps with partitions implicitly and without comment.

    In particular, $\Hom((X,\mu), U_r)$ is identified with partitions consisting of two elements. Of course, we could have equivalently simply chosen any subset of $X$ of measure $r$. We will similarly identify $\Hom((X,\mu), U_r)$ with subsets of $X$ of measure $r$.

\end{remark}

We now compute the finite limits of representables in $\Set^{\FinProb^{op}}$ (or equivalently in $\Prob$).

\begin{proposition} \label{multi-product}
    Let $U_{r_1, \cdots r_n}$ and $U_{s_1, \cdots s_m}$ be finite probability spaces. For each finite probability space $U_{t_{ij}}$\footnote{Technically, $t_{ij}$ has two indices, so one would have to reindex it with one index so that our notation is well-defined. Subsequently, we will ignore this issue.} ($0 < i \leq n$, $0 < j \leq m$) with
    \[
        \sum_j t_{ij} = r_i
    \]
    and
    \[
        \sum_i t_{ij} = s_j ,
    \]
    we define projections $p_1: U_{t_{ij}} \to U_{r_i}$, $(x_{ij}) \mapsto (\bigvee_j x_{ij})$ and $p_2: U_{t_{ij}} \to U_{s_i}$, $(x_{ij}) \mapsto (\bigvee_i x_{ij})$.

    These projection maps induce the isomorphism
    \[
    \y U_{r_i} \times \y U_{s_j} \cong \coprod_{t_{ij}} \y U_{t_{ij}} ,
    \]
    where the indexing $t_{ij}$ range over the ones with the fixed sums specified above.
\end{proposition}
\begin{proof}
    The $t_{ij}$ where precisely chosen such that the projections are measure preserving. To show
    \[
    \y U_{r_i} \times \y U_{s_j} \cong \coprod_{t_{ij}} \y U_{t_{ij}} ,
    \]
    send a pair of partitions $((a_i),(b_j))$ to the family $(a_i \wedge b_j)_{ij}$. The inverse of this map is given by joining the family with the projection maps described above.
\end{proof}

Notice that the isomorphism we proved is not quite a universal property in the traditional sense. Normally, we would have required $\y U_{r_i} \times \y U_{s_j}$ to actually be representable in order to be able to say that we have a products in $\FinProb$. But this does not work in our case, as it only is a coproduct of representables.

We give a name to this weaker notion of a limit.

\begin{definition}
    Given a small category $\C$ and a diagram $D: J \to C$, we will call a family of cones\footnote{We think of cones over $D$ as natural transformations $c \Rightarrow D$ from a constant diagram $c$ to the diagram $D$.} $(d_i \Rightarrow D)_i$ over $D$ a \emph{multi-limit} of $D$ the cones induce an isomorphism
    \[
        \limit_{j \in J} D(j) \cong \coprod_i d_i .
    \]
    Moreover, we will use the terminology \emph{multi-product}, \emph{multi-equalizer} and \emph{multi-pullback} to refer to multi-limits of particular shapes.
\end{definition}

Alternatively, we could have presented the universal property in a more traditional style by saying that cones over our diagram factor through one of the $U_{t_{ij}}$ uniquely. In fact, this is what is done in \cite{caramello_lafforgue} (Lemma 6.11.). Caramello and Lafforgue use multi-products in order to study the atoms of an atomic topos, which is also one of the things we will use them for.

Finally, we also have multi-equalizers.

\begin{proposition}
    Given the diagram \begin{tikzcd}[column sep=small]
        \alpha \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \beta
        \end{tikzcd} in $\FinProb$ we have
    \[
        eq(\begin{tikzcd}[column sep=small]
        \y \alpha \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \y \beta
        \end{tikzcd}) \cong \y \alpha \text{ if } f = g \text{ and } \emptyset \text{ otherwise.}
    \]
\end{proposition}
\begin{proof}
    The interesting case is when $f \neq g$. In that case we compute the equalizer poinitwise on a finite probability space $\gamma$:
    \[
        eq(\begin{tikzcd}[column sep=small]
        \y \alpha \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \y \beta
        \end{tikzcd})(\gamma) \cong \{ h: \gamma \twoheadrightarrow \alpha \mid fh = gh \} \cong \emptyset .
    \]
\end{proof}

\subsection{A calculus of polytopes}

We have seen that treating multi-limits requires us to talk about coproducts over certain index sets. As we progress further into the paper, we will encounter many more of these constructions. In order to describe these coproducts in a concise manner, we introduce simplified notation for them.


\begin{definition}
    \begin{enumerate}
        % We probably don't use this part anywhere in the paper
        % \item Let $\mathcal{\bar{A}}$
        % \[
        %     \{(r_1, \cdots, r_n, H) \mid n \in \mathbb{N}, r_i \in \mathbb{R}_{\geq 0}, \sum r_i = 1, H \leq Aut(U_{r_i})\}.
        % \]
        % \item For any $x \in \mathcal{A}$ with $x = (r_i, H)$, denote by $A_x \in \Prob$ the atom corresponding to the finite probability space $U_{r_i}$ divided by the group of permutations $H$.

        \item Let $\mathcal{A}$ denote the set
        \[
            \{(r_1,\cdots, r_n) \mid n \in \mathbb{N}, r_i \in \mathbb{R}_{\geq 0}, \sum r_i = 1\}.
        \]
        \item Let $S$ be a subset of $\mathcal{A}$ and let for for each $x \in S$, $T(x)$ be any set. Then we can introduce the following notation:
        \[
            \la T(x) \mid x \in S \ra := \coprod_{\substack{x \in S \\ y \in T(x)}} U_x .
        \]
        We will call an a object written in this notation a \emph{set of atoms}.
        \item We define an \emph{element} of a set of atoms $\la T(x) \mid x \in S \ra$ to be a tuple $(x,t) \in \coprod_{x \in S} T(x)$. If $T(x)$ is always the one-element set, we will abbreviate and say that $x$ is an \emph{element} of the set of atoms $\la T(x) \mid x \in S \ra$.
    \end{enumerate}
\end{definition}

One subtlety about our definitions is that the set $\mathcal{A}$ will contain multiple distinct elements corresponding to the same atom, simply because we are considering \emph{ordered} families $r_i$ and the space $U_{r_i}$ does not depend on the order.

We have seen that when thinking about binary multi-products, subsets $(t_{ij})$ of $\mathcal{A}$ with fixed sums of rows and columns are essential. Since multi-products will be invaluable in our study of $\Prob$, we introduce some notation for these index sets.

\begin{definition}
    Let $n_1, \cdots, n_k$ be positive integers and for each $j = 1, \cdots k$, let $r^j_1, \cdots r^j_{n_j}$ be nonnegative real numbers summing up to $1$. Now define:
    \begin{equation*}
        \begin{split}
            P^k_{r_i^1,\cdots r_i^k} := \{ (t_{i_1 \cdots i_k}) &\in \mathbb{R}^{n_1 \times \cdots \times n_k} \mid t_{i_1 \cdots i_k} \geq 0, \\
            & \sum_{j=1}^{n_1} t_{j i_2 \cdots i_k} = r_1, \\
            & \cdots \\
            & \sum_{j=1}^{n_k} t_{i_1 i_2 \cdots j} = r_k \\
            & \text{ for all indices } i_1, \cdots i_k \}
        \end{split}
    \end{equation*}
    % \begin{enumerate}
        % \item We can index all \[P^1_n := \{ (r_i) \in \mathbb{R}^n \mid \sum_{i=1}^n r_i = 1 \}\]
        % \item \[P^2_{r_i,s_i} := \{ (t_{ij}) \in \mathbb{R}^{n \times m} \mid \sum_{i=1}^n t_{ij} = s_j, \sum_{j=1}^m t_{ij} = r_i, t_{ij} \geq 0 \}\]
        % \item \[P^2_{n,m} := \{ (t_{ij}) \in \mathbb{R}^{n \times m} \mid \sum_{i,j = 1}^{n,m} t_{ij} = 1 , t_{ij} \geq 0 \}\]
    % \end{enumerate}
\end{definition}

\begin{example} \label{notation_example}
    \begin{itemize}
        \item Binary multi-products can now be written as:
        \[ \y U_{r_i} \times \y U_{s_j} \cong \la 1 \mid t_{ij} \in P^2_{r_i,s_j} \ra, \]
        where $1$ denotes the one-object set.
        \item Since $\FinProb$ has a terminal object, we can use our binary multi-product formula in order to compute arbitrary finite multi-products:
        \[
            \prod_{j=1}^n \y U_{r_i^j} \cong \la 1 \mid t_{i^1 \cdots i^n} \in P^n_{r_i^1 \cdots r_i^n} \ra
        \]
        \item Computing the multi-pullback of a diagram
        \[
            \begin{tikzcd}
            & U_{r'_i} \arrow[d, "g"] \\
            U_{r_i} \arrow[r, "f"'] & U_{s_i} ,
            \end{tikzcd}
        \]
        (by noting that equalizers of coproducts are coproducts of equalizers in presheaf topoi, which can be checked pointwise) yields the formula
        \begin{equation*}
            \begin{split}
            \y U_{r_i} &\times_{\y U_{s_i}} \y U_{r_i'} \cong \\
            &\la 1 \mid t_{ij} \in P^2_{r_i, r_i'}, t_{ij} = 0 \text{ for all } i,j \text{ with } f(i) \neq g(j) \ra
            \end{split}
        \end{equation*}
        \item Define the presheaf $U$ in the following way:
        \[ U \cong \la 1 \mid (r_1,r_2) \in P^1_2 \ra. \]
        We will later see that this presheaf is in fact the underlying sheaf of a universal model in $\Prob$ for a suitable theory of boolean algebras with measures.
    \end{itemize}
\end{example}

\begin{remark} We have seen that the elements $t_{ij}$ of a binary multi-product are the $t_{ij} \in P^2_{r_i,s_i}$. This set can be seen a subset of the set of $n\times m$-matrices, which is, in fact, a polytope in $\mathbb{R}^{n\times m}$. The combinatorics literature has called these polytopes \emph{transportation polytopes}. Chapter 8 of [Matrix book] is dedicated to their study.
\end{remark}

One should note that when specifying a sheaf $\mathcal{F}$ by using this set of atoms notation, the elements of $\mathcal{F}$ (as defined above) are precisely the monomorphisms $\y U_{r_i} \hookrightarrow \mathcal{F}$.

Unfortunately, one can't specify all the sheaves in this way. Nevertheless, this notation can be easily adapted to incorporate the non-representable atoms we discuss in \ref{atoms}, but we won't need this in this article.

The most convenient thing about sets of atoms, is that it is easy to send them through (the inverse image functor of) a geometric morphism, since geometric morphisms preserve coproducts. In fact, we found that the only practical way to compute geometric morphisms on a sheaf, is by decomposing the sheaf into atoms. This will be done numerous times throughout the article. In fact, we will occasionally also need to send morphisms in $\Prob$ through inverse image functors, so we also describe a mechanism through which to decompose morphisms:

\begin{proposition}\label{atom_coprod_maps}
    Let $\mathcal{F} = \la T(x) \mid x \in S \ra$ and $\mathcal{G} = \la T'(x) \mid x \in S' \ra $. Then the maps $\mathcal{F} \to \mathcal{G}$ are precisely pairs $(g, (f_x))$, where $g$ is a map between the sets of elements
    \[
        \coprod_{x \in S} T(x) \to \coprod_{x \in S'} T'(x)
    \]
    and for each element $(x,t) \in \coprod_{x \in S} T(x)$ with $(x',t') = g(x,t)$, $f_{x,t}$ is a morphism
    \[
        U_x \xrightarrow{f_{x,t}} U_{x'} .
    \]
\end{proposition}
\begin{proof}
    Use the universal property of the coproduct of atoms and then use that each map needs to factor through one of the images because the image of an atom needs to be an atom again.
\end{proof}

\subsection{A better sheaf condition}

As a toy application of the facts discovered so far, we develop a better sheaf condition. Since we won't use it anywhere, the reader can safely skip this subsection.

\begin{proposition} \label{sheaf_condition}
A presheaf $\mathcal{F}$ on $\FinProb$ is a sheaf over the atomic topology if and only if for all maps of finite probability spaces $f: U_{r_i} \to U_{s_i}$ the fork
\[
\begin{tikzcd}
\mathcal{F} U_{s_i} \arrow[r, "\mathcal{F}f"] &
\mathcal{F} U_{r_i} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \prod_{t_{ij}} \mathcal{F} U_{t_{ij}}
\end{tikzcd}
\]
is an equalizer diagram, where the $t_{ij}$ range over the elements of the multi-pullback $U_{r_i} \times_{U_{s_i}} U_{r_i}$ (we are pulling $f$ back along itself) and the projection $\pi_1$ and $\pi_2$ are induced by the universal 'projection maps' of multi-pullbacks.
\end{proposition}
\begin{proof}
Since for each $U_{t_{ij}}$ we have the commuting square
\[
\begin{tikzcd}
U_{t_{ij}} \arrow[r] \arrow[d] & {U_{r_i}} \arrow[d, "f"] \\
{U_{r_i}} \arrow[r, "f"']            & {U_{s_i}} ,
\end{tikzcd}
\]
$f$ certainly gives us a diagram
\[
\begin{tikzcd}
\mathcal{F} U_{s_i} \arrow[r, "\mathcal{F}f"] & \mathcal{F} U_{r_i} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \prod_{t_{ij}} \mathcal{F} U_{t_{ij}}
\end{tikzcd}
\]
with $\pi_1 \mathcal{F}(f) = \pi_2 \mathcal{F}(f)$. Claiming that this is an equalizer means saying that for every $a \in \mathcal{F}U_{r_i}$ with the property that for all the projections $p_1: U_{t_{ij}} \to U_{r_i}$, $p_2: U_{t_{ij}} \to U_{r'_i}$ the equation $\mathcal{F}(p_1)(a) = \mathcal{F}(p_2)(a)$ is satisfied, implies that there is a unique lift $b \in \mathcal{F}U_{s_i}$ of $a$.

So our claim is that the criterion described above needs only be checked on the $U_{t_{ij}}$. Thus we assume that the equation above holds for the $U_{t_{ij}}$ with their projection maps. We need to show that the equation $\mathcal{F}(g)(a) = \mathcal{F}(h)(a)$ already holds for all the \[
\begin{tikzcd}
\gamma \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & U_{r_i}
\end{tikzcd}
\]
with $fg = fh$. But this certainly holds, since we can factor $g$ and $h$ through one of the $U_{t_{ij}}$ by the universal property of the multi-pullback.
\end{proof}

Note that this proposition actually had little to do with finite probability spaces and is really about a sheaf condition for atomic topologies where the base category has multi-pullbacks.

\section{$\Prob$ as the classifying topos of a theory of intervals}

In this section we will show that $\Sh(\FinProb, J_{at})$ classifies a certain theory of intervals. For the most part we will use the notations and definitions as in part D.1 of \cite{elephant}. We warn the reader that this section contains big amounts of technical property-checking, so the uninterested reader can read the next definition and then skip to \ref{theory_of_intevals}.

\begin{definition}
Define the geometric theory $\mathbb{T}_{bpalg}$ of boolean probability algebras to have one sort $B$, constants and function symbols
\begin{center}
$1: B$ \\
$0: B$ \\
$\wedge: B \times B \to B$ \\
$\vee: B \times B \to B$ \\
$\neg: B \to B$
\end{center}
and a unary relation symbol $B_r$ on $B$ for each $r \in [0,1]$. We impose the following axioms($a$, $b$ and $c$ denote free variables in $B$):
\begin{itemize}
\item \textit{Boolean algebra}.
\begin{align*}
\top &\vdash a \wedge (b \wedge c) = (a \wedge b) \wedge c && \text{associativity} \\
\top &\vdash a \vee (b \vee c) = (a \vee b) \vee c && \text{associativity} \\
\top &\vdash a \wedge 1 = a && \text{identity} \\
\top &\vdash a \vee 0 = a && \text{identity}\\
\top &\vdash a \wedge \neg{a} = 0 && \text{inverse}\\
\top &\vdash a \vee \neg{a} = 1 && \text{inverse}\\
\top &\vdash a \wedge (a \vee b) = a && \text{absorbtion}\\
\top &\vdash a \vee (a \wedge b) = a && \text{absorbtion}\\
\top &\vdash a \wedge (b \vee c) = (a \wedge b) \vee (a \wedge c) && \text{distributivity} \\
\top &\vdash a \vee (b \wedge c) = (a \vee b) \wedge (a \vee c) && \text{distributivity}
\end{align*}
\item \textit{$B_r$ form a partition}. For all $r, s \in [0,1]$ with $r \neq s$ we have an axiom
\[
B_r(a)  \wedge B_s(a) \vdash \bot
\]
and we also have an axiom
\[
\top \vdash \bigvee_{r \in [0,1]} B_r(a).
\]
\item \textit{Probability measure}. For all $r, s \in [0,1]$, we further require
\[
(a \wedge b = 0) \wedge B_r(a) \wedge B_s(b) \vdash B_{r+s}(a \vee b)
\]
and finally we need
\begin{align*}
\top & \vdash B_1(1) \\
B_0(a) & \vdash a = 0.
\end{align*}
\end{itemize}
\end{definition}

Essentially, we have encoded a boolean probability algebra geometrically by partitioning the base sort $B$ into the elements $B_r$ of measure $r \in [0,1]$. If one were to write down the categorical interpretation of the two partition axioms, one would see that they are just saying that $B$ is a coproduct of the $B_r$.

Let us get some more notation out of the way.

\begin{definition}
Denote the category models of $\mathbb{T}_{bpalg}$ in $\Set$ by $\BPAlg$.
\end{definition}

\begin{remark}
    Note that we have an equivalence of categories
    \[
        \FinProb^{op} \simeq \BPAlg_f
    \]
    between the opposite category of finite probability spaces and the category of finite boolean probability algebras. We don't prove this in detail nor do we give the equivalence explicitly, since we won't use this fact anywhere in this paper.
\end{remark}

\subsection{The classifying topos proof}

We would like to show that the topos $\Set^{\FinProb^{op}}$ classifies $\mathbb{T}_{bpalg}$. More specifically, we will prove the equivalence
\[
\Set[\mathbb{T}_{bpalg}] \simeq \Set^{\FinProb^{op}} .
\]

The main difficulty is that we have we have found no way of knowing whether the topos on the left-hand-side has enough points. For example, Deligne's theorem is inapplicable, since the theory is not coherent.

Nevertheless, as a consistency check, one can verify that the models in $Set$ are equivalent by checking that
\[
    \BPAlg \simeq \Ind(\BPAlg_f) \simeq \Ind(\FinProb^{op}),
\]
but the proof of this fact is not short enough for us to provide it here.

We will prove the equivalence
\[
\Set[\mathbb{T}_{bpalg}] \simeq \Set^{\FinProb^{op}}
\]
by purely syntactical means. The functor in one direction will be given by an appropriate model of $\mathbb{T}_{bpalg}$ in $\Set^{\FinProb^{op}}$. The functor in the other direction will require us to work with the syntactic category $\mathcal{C}^{\mathbb{T}_{bpalg}}$ directly, and we will see that this will lead to us needing to work formally with geometric logic.

Before we begin, we explain the intuition behind this Morita-equivalence. The idea is that, while the left topos axiomatizes a boolean probability algebra, the topos on the right directly axiomatizes the \emph{partitions} of the boolean algebra into elements of prescribed measures. The object $\y U_{r_i}$ is supposed to represent elements $a_1,\cdots,a_n$ with measures $\mu(a_1) = r_1,\cdots,\mu(a_n) = r_n$. The maps $\y U_{s_i} \to \y U_{r_i}$ are supposed to represent unions of the partition $(s_i)$ into a coarser one.

With this intuition in mind, how should we go about defining the universal model defining the functor $\Set[\mathbb{T}_{bpalg}] \to \Set^{\FinProb^{op}}$? Essentially, we are asking how to construct an object of \emph{all} elements of a boolean algebra from the objects of elements with specified measures. Under this perspective, it becomes clear that we should define the underlying presheaf of the universal model $U$ to be
\[
\coprod_{r \in [0,1]} \y U_r \in \Set^{\FinProb^{op}} .
\]
One immediately sees that $U$ is just the powerset functor on the underlying set of a given probability space (a map $f$ between probability spaces gets sent to the map that takes the preimage of each subset).

\begin{lemma} \label{universal model}
$U$ is a model of the $\mathbb{T}_{bpalg}$. The sort $B$ is given by $U$. The relation symbols $B_r$ are given by $\y U_r$ and the boolean algebra operations given by the fact that at every $(X,\mu) \in \FinProb$, $U(X, \mu)$ is the powerset of $X$.

This yields a left-exact, colimit-preserving functor
\[
    \Set^{\FinProb^{op}} \xleftarrow{\Lan_{\y}(U)} \Set[\mathbb{T}_{bpalg}],
\]
where $U$ is the functor we get by identifying models of $\mathbb{T}_{bpalg}$ with functors whose domain is the syntactic category of $\mathbb{T}_{bpalg}$.
\end{lemma}
\begin{proof}
The last statement follows from the first part by using the universal property of classifying topoi.

We begin with some well-definedness remarks. The operations $\wedge, \vee$ and $\neg$ on $U$ can be defined pointwise by using the boolean algebra structure of powersets. Since the maps of finite probability spaces induce boolean algebra homomorphisms between the powersets, and these automatically preserve $\wedge, \vee \text{ and } \neg$, we get naturality of the operations. Similarly, the inclusions $\y U_r \to U$ are natural since morphisms in $\FinProb$ preserve measure.

Since we are looking at presheaves, all the colimit and limit conditions from the axioms can be checked pointwise, where they are trivial. More formally, we can use \cite{elephant}, Corollary D.1.2.14, to get the fact that $U$ is a $\mathbb{T}_{bpalg}$-model in $\Set^{\FinProb^{op}}$.
\end{proof}

We proceed by formalizing our intuition about the representables in $\Set^{\FinProb^{op}}$ being partitions by constructing our candidate inverse functor.

We diverge from the notation in D.1 of \cite{elephant} in that we will sometimes annotate a formulas with a set of variables containing all the variables used in the formula, as seen below. This is done so that when these formulas get combined with logical connectives, the big formula remains easy to read.

\begin{lemma} \label{inverse}
Let $f: (X,\mu) \to (Y, \nu)$ be an arrow in $\FinProb$. We define the functor $F: \FinProb \to \mathcal{C}^{\mathbb{T}_{bpalg}}$ on the object $(X,\mu)$ and on the function $f$ as follows: Let
\begin{align*}
\{\vec{a} . \phi_{X,\mu}^{\vec{a}}\} &:= \Bigg \{ \vec{a} . \bigwedge_{i \in X} B_{\mu(i)} a_i \wedge \bigwedge_{\substack{i,j \in X \\ i \neq j}} (a_i \wedge a_j = 0) \Bigg \} \\
[\theta_f^{\vec{a}, \vec{b}}] &:= \Bigg [ \bigwedge_{j \in Y} (b_j = \bigvee_{f i = j} a_i) \wedge \phi_{X,\mu}^{\vec{a}} \Bigg] ,
\end{align*}
and now define $F(X,\mu) := \{\vec{a} . \phi_{X,\mu}^{\vec{a}}\}$ and $F(f) := [\theta_f^{\vec{a}, \vec{b}}]$.

This yields a left-exact, colimit-preserving functor
\[
    \Lan_F: \Set^{\FinProb^{op}} \to \Set[\mathbb{T}_{bpalg}] .
\]
\end{lemma}

Readers paying close attention to the proof strategy may wonder why we even bother showing left-exactness of $\Lan_F$. After all, if at the end we show that we have an equivalence of categories, we would get left-exactness for free. But it turns out, that proving that our functors are inverses to one another(see \ref{classifying_presheaf}) essentially requires this left-exactness property. We have marked the place in the proof where we use it by a footnote.

\begin{proof}
    We need to show functoriality and then verify that $\Lan_F$ is left-exact. In order to check this left-exactness, we use theorem \Rmnum{7}.9.1 in \cite{sheaves_geometry_logic}(page 399). The cited theorem says that flat functors(defined as functors whose left Kan extension is left-exact) precisely correspond to the functors satisfying the straightforward list of properties listed in the definition of a filtering functor, which is defined in \Rmnum{7}.8.1 (page 394).

    The reader who actually reads the definition of a filtering functor will quickly notice that that definition can be checked in our case by showing that $F$ preserves the terminal object, binary multi-products and multi-equalizers in the sense checked below.

    \begin{enumerate}
        \item We show that $F$ preserves identities. We compute that
            \begin{align*}
                F(\id) &= [\theta^{\vec{a},\vec{b}}_{\id}] \\
                &= [\vec{a}=\vec{b}] \\
                &= \id,
            \end{align*}
            which shows our claim.
        \item We show that $F$ preserves composition. Given morphisms $f: \alpha \to \beta$, $g: \beta \to \gamma$ in $\FinProb$,
            \begin{align*}
                F(g)F(f) &= [\exists c . \theta^{\vec{a},\vec{c}}_f \wedge \theta^{\vec{c},\vec{b}}_g] \\
                &= [\theta^{\vec{a},\vec{b}}_{gf}] ,
            \end{align*}
            where the last equality follows from associativity and commutativity of the $\wedge$ operation and by additivity of the measure.
        \item We show that $F$ preserves the terminal object. We simply compute this:
            \begin{align*}
                F(*) &= \{a. B_1(a)\} \\
                &\cong \{[].\top \} ,
            \end{align*}
            where the last isomorphism follows from the fact we can geometrically prove that there is a unique element of measure $1$.
        \item We show that $F$ preserves multi-products. Concretely, let $\alpha$, $\beta$ be finite probability spaces. Then we have a polytope $P^2_{r_i,s_j}$ and for each of its elements $t_{ij}$ we have a cone
        \[\begin{tikzcd}
            & U_{t_{ij}} \arrow[ld, "p_{t_{ij}}"'] \arrow[rd, "q_{t_{ij}}"] &       \\
        \alpha &                                                               & \beta
        \end{tikzcd} .\]

        In order to show that this multi-product gets preserved, we need to show that the map
        \[
            \coprod_{t_{ij} \in P^2_{r_i,s_j}} \la \theta^{\vec{a},\vec{b}}_{p_{t_{ij}}}, \theta^{\vec{a},\vec{b}}_{q_{t_{ij}}} \ra : \coprod_{t_{ij} \in P^2_{r_i,s_j}} F U_{t_{ij}} \to F(\alpha) \times F(\beta)
        \]
        is an isomorphism. It is crucial that there does not only exist an isomorphism, but that it is this concrete isomorphism constructed by universal property. Indeed, for showing corresponding condition \Rmnum{7}.8.1 in \cite{sheaves_geometry_logic} we need to show that a specific family of morphisms is jointly epimorphic. And our claim here certainly implies that.

        We will show that this map is an isomorphism by computing this map as a formula. First, note that the inclusions
        \[
            FU_{t_{ij}} \to F(\alpha) \times F(\beta)
        \]
        can be computed (using D.1.4.2 in \cite{elephant}) to be
        \[
            [ b_i = \bigvee_j a_{ij}, c_j = \bigvee_i a_{ij} ] :\{ \vec{a}. \phi^{\vec{a}}_{U_{t_{ij}}} \} \to \{ \vec{b},\vec{c} . \phi^{\vec{b}}_{\alpha} \wedge \phi^{\vec{c}}_{\beta} \} .
        \]
        By using the partition axiom multiple times, we notice that the formulas $\{ \vec{a} . \phi^{\vec{a}}_{U_{t_{ij}}}\}$ are disjoint (in the subobject lattice of $\{ \vec{a} . \top \}$). Thus the coproduct corresponds to union in that subobject lattice. Therefore by D.1.4.10 in \cite{elephant} we can compute the required coproduct to be
        \[
            [ b_i = \bigvee_j a_{ij}, c_j = \bigvee_i a_{ij} ]: \{ \vec{a}.\bigvee_{t_{ij} \in P^2_{r_i,s_j} } \phi^{\vec{a}}_{U_{t_{ij}}} \} \to \{\vec{b},\vec{c} . \phi^{\vec{b}}_{\alpha} \wedge \phi^{\vec{c}}_{\beta}\},
        \]
        where the map is forced to be this map by universal property, since it commutes with the inclusions.

        Interestingly, we have shown that this map is simply a substitution. But we can give another substitution that can be checked to be an inverse of this map by using the boolean probability algebra axioms:
        \[
            [a_{ij} = b_i \wedge c_j]
        \]

        Thus we have shown that the required map is an isomorphism.

        \item  Let
        \begin{tikzcd}
        \alpha \arrow[r, "f", shift left] \arrow[r, "g"', shift right] & \beta
        \end{tikzcd}
        be a diagram in $\FinProb$. We show that $F$ preserves multi-equalizers. More specifically, if we have a family of forks
        \[
            \begin{tikzcd}
            \gamma_i \arrow[r, "h_i"] & \alpha \arrow[r, "f", shift left] \arrow[r, "g"', shift right] & \beta
            \end{tikzcd}
        \]
        forming a multi-equalizer, then we need to show that
        \[
            \coprod_i F(h_i) : \coprod_i F(\gamma_i) \to eq(\begin{tikzcd}
                F(\alpha) \arrow[r, "Ff", shift left] \arrow[r, "Fg"', shift right] & F(\beta)
                \end{tikzcd})
        \]
        is an isomorphism.

        We already know that multi-equalizers in $\FinProb$ are particularly simple. If $f = g$, then the family of forks consists of only the identity map $\id: \alpha \to \alpha$. In this case our claim becomes trivial.

        Now assume that $f \neq g$. Then the multi-equalizer is the empty family. Thus our claim becomes that
        \[
            eq(\begin{tikzcd}
                \{ \vec{a}.\phi^{\vec{a}}_{\alpha} \} \arrow[r, "{[\theta^{\vec{a},\vec{b}}_f]}", shift left] \arrow[r, "{[\theta^{\vec{a},\vec{b}}_g]}"', shift right] & \{ \vec{b}.\phi^{\vec{b}}_{\beta} \}
                \end{tikzcd})
        \]
        is the initial object $\{\vec{a}.\bot\}$. In fact, using D.1.4.2 in \cite{elephant}, we can compute this equalizer to be $\{ \vec{a} . (\exists \vec{b}) \theta_f^{\vec{a},\vec{b}} \wedge \theta_g^{\vec{a},\vec{b}} \}$. This means that our objective is to show the sequent
        \[
            (\exists \vec{b}) \theta_f^{\vec{a},\vec{b}} \wedge \theta_g^{\vec{a},\vec{b}} \vdash_{\vec{a}} \bot .
        \]
        Since that $f \neq g$, we have a $k$ be such that $f(k) \neq g(k)$. Now we can simply show that this sequent holds.
        \begin{align*}
            (\exists \vec{b}) \theta_f^{\vec{a},\vec{b}} \wedge \theta_g^{\vec{a},\vec{b}}
            &\vdash_{\vec{a}} (\exists \vec{b}) \bigwedge_{j \in \beta} (b_j = \bigvee_{f i = j} a_i) \wedge \bigwedge_{j \in \beta} (b_j = \bigvee_{g i = j} a_i) \wedge \phi_{\alpha}^{\vec{a}} \\
            &\vdash_{\vec{a}} \bigwedge_{j \in \beta} \big ( \bigvee_{f i = j} a_i = \bigvee_{g i = j} a_i \big ) \wedge \phi_{\alpha}^{\vec{a}} \\
            &\vdash_{\vec{a}} \big ( \bigvee_{f i = f k} a_i = \bigvee_{g i = f k} a_i \big ) \wedge \phi_{\alpha}^{\vec{a}} \\
            &\vdash_{\vec{a}} \big ( \bigvee_{f i = f k} a_i \wedge a_k = \bigvee_{g i = f k} a_i \wedge a_k \big ) \wedge \phi_{\alpha}^{\vec{a}}\\
            &\vdash_{\vec{a}} (a_k = 0) \wedge \phi_{\alpha}^{\vec{a}} \\
            &\vdash_{\vec{a}} \bot
        \end{align*}
    \end{enumerate}
\end{proof}

\begin{theorem}[Classifying topos of $\mathbb{T}_{bpalg}$] \label{classifying_presheaf}
$\Lan_{\y}(U)$ and $\Lan_F$ define an equivalence of categories
\[
\Set^{\FinProb^{op}} \simeq \Set[\mathbb{T}_{bpalg}].
\]
\end{theorem}

We warn the reader that the necessary ideas defining the equivalence have already been introduced, and that this proof consists of highly technical and uninsightful property-checking.

\begin{proof}
For this proof, let $\mathbb{T} := \mathbb{T}_{bpalg}$.

We check that the functors we defined are inverses to each other.

We first check that $\Lan_{\y}(U) \circ \Lan_F \cong \id$. Since these functors preserve colimits, we check only need to check this on representables. So let $(X,\mu) \in \FinProb$. Then we get natural isomorphisms

\begin{align*}
\Lan_{\y}(U)(\Lan_F(\y(X,\mu))) &\cong \Lan_{\y}(U)(yF(X,\mu)) \\
&\cong UF(X,\mu) \\
&\cong U \{\vec{a} . \phi^{\vec{a}}_{X,\mu}\} \\
&\cong \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U .
\end{align*}

It remains to show that we have a natural isomorphim $\y (X,\mu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$. First, we compute this functor on objects. Since the corresponding limits are computed pointwise, we first get a natural (in $(X,\mu)$) isomorphism
\[
\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U (Y,\nu) \cong \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(Y,\nu)} .
\]
But computing these pullbacks and equalizers in $\Set$ yields
\begin{align*}
\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(Y,\nu)} \cong
\{\{V_x\} \subset Y \mid (\nu(V_x) = \mu(x)) \wedge (V_x \cap V_y = \emptyset) \text{ for } x,y \in X, x \neq y\} .
\end{align*}

Now we can use this together with the Yoneda lemma in order to give the required isomorphism $\y (X,\nu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$ by the element $\{x\}_{x \in X} \in \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(X,\mu)}$. In order to show this actually is an isomorphism, we explicitly compute this isomorphism on an $f \in \y (X,\mu) (Y,\nu)$. In order to do that, we note that the functor $\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$ is a subfunctor of $\prod_{x \in X} U$, so that lets us see that the map
\[
\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U(X,\mu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U(Y,\nu)
\]
induced by $f$, sends $\{x\}_{x \in X}$ to $\{f^{-1} x\}_{x \in X}$. This means that the morphism
\[
\y (X,\mu) (Y,\nu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U(Y,\nu)
\]
sends an $f$ to the family $\{f^{-1} x\}$. We should recognize this mapping from our discussions on the relationship between partitions and the presheaf $\y (X,\mu)$ in \ref{classifying_partitions}. We already discussed that this is a bijection and thus we get an isomorphism $\y (X,\nu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$.

We still need to show this isomorphism is natural in $(X,\mu)$. We prove naturality on each $(Y,\nu) \in \FinProb$. So let $(X,\mu), (X',\mu') \in \FinProb$. The diagram
\[
\begin{tikzcd}
    {\Hom((Y,\nu),(X,\mu))} \arrow[r, "\cong"] \arrow[d, "f_*"'] & {\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(Y,\nu)}} \arrow[d, "{\ldoub \vec{a},\vec{b} . \theta_f \rdoub}"] \\
    {\Hom((Y,\nu),(X',\mu'))} \arrow[r, "\cong"]                 & {\ldoub \vec{a} . \phi^{\vec{a}}_{X',\mu'} \rdoub_{U(Y,\nu)}}
\end{tikzcd}
\]
commutes because this is the way $\{\vec{a},\vec{b} . \theta_f \}$ internalizes in a $\Set$-model. This concludes our proof of $\Lan_{\y}(U) \circ \Lan_F \cong \id$.

We now prove that $\Lan_F \circ \Lan_{\y}(U) = \id$. Since all the functors involved are left-exact and colimit-preserving, it suffices to show that the isomorphism holds on the corresponding models of $\mathbb{T}$ inside $\Set[\mathbb{T}]$. This means we have to compute $\Lan_F \circ \Lan_{\y}(U)$ on the 'signature' of $\mathbb{T}$ and show that the yielded structure is isomorphic as a $\mathbb{T}$-model to the universal model of $\Set[\mathbb{T}]$. \footnote{One should emphazise that this reduction step is the only reason that we laboriously showed that $F$ is left-exact.}

We first check this for the sort $B$. This means that we have to show that $\Lan_F(U) \cong \y \{b . \top\}$. This reduces to showing
\[
\coprod_{r \in [0,1]} \y \{b . B_r b\} \cong \y \{b . \top\} .
\]
We can prove this by showing that for every sheaf $\mathcal{F} \in \Set[\mathbb{T}]$, we have a natural bijection
\[
\Hom(\y \{b . \top\}, \mathcal{F}) \cong \prod_{r \in [0,1]} \Hom(\y \{b . B_r b\}, \mathcal{F})
\]
given by the inclusions $\iota_r : \{b . B_r b\} \to \{b . \top\}$. Applying the yoneda lemma on both sides, this is equivalent to showing that the inclusions induce an isomorphism
\[
\mathcal{F} \{b . \top\} \cong \prod_{r \in [0,1]} \mathcal{F} \{b . B_r b\} .
\]
But this can be checked by applying the sheaf condition to the cover of $\{b . \top\}$ given by the $\{b . B_r b\}$. Notice that here we are using the two partition axioms.

Next, we need to show that the above isomorphism actually is an isomorphism of $\mathbb{T}$-models. Explicitly, we have to show that for each function symbol $f$ our isomorphism induces an iso
% TODO: This should be improved on.
\[
\begin{tikzcd}[column sep=tiny]
    {\y \{a_1,\cdots,a_n . \top \}} \arrow[d, "{[f(a_1,\cdots,a_n) = a]}"'] \arrow[r, "\cong"',phantom, shift right=7] & \Lan_F U^n \arrow[d, "\Lan_F U(f)"] \\
    \y \{a . \top \}                                                                                           & \Lan_F U
\end{tikzcd}
\]
in the category of arrows in $\Set[\mathbb{T}]$. The upper isomorphim is induced by the data of the respective universal cones exhibiting the upper objects as cartesian products. We also need the analogous statement for relation symbols. In particular this apply this remark to Kan-extensions. Notice that here and also in what follows, we are taken the viewpoint on objects defined by universal property described in section \ref{conventions}.

We first consider the 0-ary function $U(0): * \to U$. We get the chain of isomorphisms

\[
\begin{tikzcd}
\Lan_F * \arrow[d, "\Lan_F U(0)"'] \arrow[r, "\cong"',phantom, shift right=7] & \Lan_F \y U_0 \arrow[d] \arrow[r, "\cong"',phantom, shift right=7] & \y \{b . B_0 b \} \arrow[d] \arrow[r, "\cong"',phantom, shift right=7] & {\y \{[].\top\}} \arrow[d, "{[a=0]_*}"] \\
\Lan_F U                                                             & \Lan_F \coprod \y U_r                                      & \coprod \y \{ b . B_r b\}                                      & \y\{a.\top\}
\end{tikzcd}
\]

where the first three isos clearly are isos satisfying the commutativity condition. The only interesting step in this chain is where we use the fact that $\{b . B_0 b\} \cong \{a . a = 0\} \cong \{[]. \top\}$, where the first isomorphism uses the that $B_0 a \dashv \vdash_a (a = 0)$. One can check that the last commutativity condition also holds:
\[
[B_0 b]_* [a=0]_* = [B_0 b \wedge (a = 0)]_* = [B_0 b \wedge (a=b)]_*,
\]
where the left hand side is the upper right composition and the right hand side is the lower left composition. Now the composite isomorphism on the bottom clearly is the one constructed earlier. The proof for $1$ is almost the same, again one only needs the fact that $B_1 a \dashv \vdash_a (a = 1)$, which is provable in our theory.

We proceed with the binary function $U(\wedge): U \times U \to U$. We will prove the required isomorphism in the following two steps:
\[
\begin{tikzcd}
\Lan_F(U \times U) \arrow[d, "\Lan_F(U(\wedge))"'] \arrow[r, phantom, shift right=7, "\cong"] & {\coprod \y \{\vec{b}.\bigwedge_{i=1,\cdots 4} B_{r_i} b_i\}} \arrow[d] \arrow[r, phantom, shift right=7, "\cong"] & {\y \{a_1,a_2.\top\}} \arrow[d, "{[a = a_1 \wedge a_2]_*}"] \\
\Lan_F U                                          & \coprod \y \{b.B_rb\} & \y\{a.\top\} .
\end{tikzcd}
\]
We start with the left isomorphism. We can use \ref{multi-product} to rewrite $U \times U$ as a coproduct of representables by using the isomorphism $U \times U \to \coprod \y U_{r_1 \cdots r_4}$ given on components by
\[
(a,b) \mapsto (a \wedge b, a \wedge \neg b, \neg a \wedge b, \neg a \wedge \neg b) .
\]
Using the inverse of this isomorphism $(b_1,b_2,b_3,b_4) \mapsto (b_1 \vee b_2, b_1 \vee b_3)$, we get the commutative square which after applying $\Lan_F$ yields the required commutative square above on the left
\[
\begin{tikzcd}
U \times U \arrow[d, "U(\wedge)"'] & \coprod \y U_{r_1 \cdots r_4} \arrow[d, "\coprod f"] \arrow[l, "\cong"'] \\
U                                  & \coprod \y U_r \arrow[l, "\cong"]                          ,
\end{tikzcd}
\]

where $f$ sends a partition into four subsets onto the first subset. Since we do not only need any isomorphism $\Lan_F (U \times U) \cong \coprod \y F (U_{r_1 \cdots r_4})$, but a specific one induced on the components on the cartesian product, we check that the upper isomorphism in our diagram is in fact induced by the required isomorphism. We do this by noting that the map $U \times U \xleftarrow{\cong} \coprod \y U_{r_1 \cdots r_4}$ commutes with the required map on the first projection of the cartesian products:

\[
\begin{tikzcd}
U \times U \arrow[d, "p_1"'] & \coprod \y U_{r_1 \cdots r_4} \arrow[d, "\alpha_1"] \arrow[l, "\cong"'] \\
U                            & \coprod \y U_r \arrow[l, "\cong"]                                    ,
\end{tikzcd}
\]
where $\alpha_1$ is the map induced by the maps $\y U_{r_1 \cdots r_4} \to \y U_r$ given by $(b_1,\cdots,b_4) \mapsto b_1 \vee b_2$, where the $b_i$ are seen as partitions. There is an analogous map $\alpha_2$ that has a similar relation to the second projection $p_2$. Now the two isomorphims on the the diagram above imply that $\alpha_1$ and $\alpha_2$ form a universal cone for a cartesian product. This immediately implies that the isomorphism $U \times U \cong \coprod \y U_{r_1 \cdots r_4}$ is the one induced by the universal properties of the product and moreover, by flatness of $F$, this fact gets preserved when applying $\Lan_F$. Now that we have shown the first part of the isomorphism, we wish to show that we have an isomorphism
\[
\begin{tikzcd}
{\coprod \y \{\vec{b}.\bigwedge_{i=1,\cdots 4} B_{r_i} b_i\}} \arrow[d, "{\coprod [b = b_1]_*}"'] \arrow[r, "\phi"] & {\y \{a_1,a_2.\top\}} \arrow[d, "{[a = a_1 \wedge a_2]_*}"] \\
\coprod \y \{b.B_rb\} \arrow[r, "\cong"']                                                & \y\{a.\top\}                                               ,
\end{tikzcd}
\]
where $\phi$ is given by $[(a_1 = b_1 \vee b_2) \wedge (a_2 = b_1 \vee b_3)]_*$. It is easy to see that the diagram commutes. The fact that $\phi$ is an isomorphism will follow by the fact that $\phi$ is induced by the required isomorphisms. Like earlier, this is shown by remarking that

\[
\begin{tikzcd}
{\coprod \y \{\vec{b}.\bigwedge_{i=1,\cdots 4} B_{r_i} b_i\}} \arrow[d, "\alpha_1"'] \arrow[r, "\phi"] & {\y \{a_1,a_2.\top\}} \arrow[d, "{[a = a_1]_*}"] \\
\coprod \y \{b.B_rb\} \arrow[r, "\cong"']                                                            & y\{a.\top\}
\end{tikzcd}
\]
commutes. But this time, we already know that $\alpha_1$ and $\alpha_2$ are a universal cone of a product and similarly, $[a=a_1]_*$ and $[a=a_2]_*$ are the projections of a product. This already implies that $\phi$ is induced by the correct isomorphisms and moreover that $\phi$ itself is an isomorphism. This concludes the proof that $\Lan_F U(\wedge)$ matches the corresponding operation on the universal model in $\Set[\mathbb{T}]$. The argument for $\vee$ should be very similar.

We show that $\Lan_F U(\neg)$ matches the corresponding operation on the universal model, by showing that we don't need to show it. Let $\mathbb{T}_{BAlg}$ denote the theory of boolean algebras and $\mathbb{T}_{DLat'}$ be the theory of distributive lattices together with the axiom
\[
\top \vdash_{x} (\exists y) ((x \wedge y=0)\wedge (x\vee y=1)) .
\]

We even have that $\C^{\mathbb{T}_{BAlg}} \simeq \C^{\mathbb{T}_{DLat'}}$. The functor pointing towards the left is just given by the universal model in $\mathbb{T}_{BAlg}$. The functor pointing towards the right is given by the universal model in $\mathbb{T}_{DLat'}$, where negation is given by the $\mathbb{T}_{DLat'}$-provably functional formula
\[
[(x\wedge y=0) \wedge (x\vee y=1)] : \{x.\top\} \to \{y.\top\}  .
\]

% TODO: Clean this up. Say something like that one can trivially see that the set-models match.
One can verify that this actually is an equivalence by using \ref{interpretations} and the fact that
\[
[y=\neg x] = [(x\wedge y=0) \wedge (x\vee y=1)]
\]
in $\C^{\mathbb{T}_{BAlg}}$. This now proves that we don't need to check that negation gets preserved, by identifying models of $\mathbb{T}_{BAlg}$ with models of $\mathbb{T}_{DLat'}$.

Luckily, sending $U_r \to \coprod U_r$ through $\Lan_F$ is easily seen to give the expected subobject, concluding the proof.
\end{proof}

We proceed by investigating what $\Sh(\FinProb, J_{at})$ classifies.

\begin{definition} \label{theory_of_intevals}
Define the \textit{theory of intervals} $\mathbb{T}_{int}$ by adding the axioms
\[
B_s a \vdash_a (\exists b) \big ( (b = a \wedge b) \wedge B_r b \big )
\]
for all $r,s \in [0,1]$ with $r \leq s$ to the theory of boolean probability algebras.
\end{definition}

Note that the models of $\mathbb{T}_{int}$ in $\Set$ must all be uncountable. We now look at some examples of intervals in $\Set$.

\begin{definition}
Call a boolean probability algebra $(A,\mu)$ simply a probability algebra, if $A$ is a complete boolean algebra and moreover, for every directed family $a_i$ of elements of $A$, we have the additivity condition
\[
\mu(\bigvee a_i) = \text{sup } \mu(a_i) .
\]
The pairs $(A,\mu)$ for which there is a $c > 0$ such that $(A, c \mu)$ is a probability algebra will simply be called measure algebras. A morphism of measure algebras is a morphism of boolean algebras that is measure-preserving.
\end{definition}

Note that we have chosen a slightly more restrictive definition of measure algebra than is standard, since we did not allow the measure to adopt infinite values.

Measure algebras are the correct setting for doing measure theory while ignoring the effects of nullsets. They connect to the more standard setting for measure theory as follows: Given a $\sigma$-algebra $(X,\Sigma)$ and a measure on $(X,\Sigma)$, dividing out the nullsets out of $\Sigma$ is guaranteed to yield a measure algebra. This is surprising, since the $\sigma$-algebra doesn't need to have infinite joins or meets, but the measure algebra does have them. One can also conversely construct a measure space on a $\sigma$-algebra out of a measure algebra by using the Stone space of the measure algebra. For many more details on measure algebras, see chapter 32 of \cite{fremlin}, a notably long reference on measure theory.

\begin{example} \label{interval_examples}
\begin{itemize}
\item Let $(A,\mu)$ be an atomless probability algebra. Let $a \in A$ with $\mu(a) = r$ and let $s \in [0,r]$. We use the axiom of choice to construct an element $b
\leq a$ of measure $s$. Consider the set
\[
S := \{ b \leq a \mid \mu(b) \leq s \}.
\]
Since every chain has a supremum, we can use Zorn's lemma to get a maximal element $b \in S$. Now consider the set
\[
T := \{ b' \leq a \mid b' \geq b\} .
\]
What? This seems wrong... though the idea seems correct
This has a minimal element $b'$ given by the meet of all elements of $T$. Note that $\mu(b') \geq s$ since $b' \geq b$. Thus, for all $c$ with $b \leq c \leq b'$, $c$ must either be $b$ or $b'$. This implies that $b' \wedge \neg b$ is an atom, or that $b' = b$. But the former is impossible due to the atomless hypothesis. Thus we have constructed an element of measure $s$, which means that $(A,\mu)$ is an interval.
\item Let $I$ denote the boolean probability algebra defined by the boolean algebra of Borel-subsets of the interval modulo the ideal of null-sets. Note that we can equivalently divide out the null-sets out of the boolean algebra of Lebesgue-subsets of the interval. Let $(I, \lambda)$ denote this boolean algebra equipped with the Lebesgue measure, and call $(I, \lambda)$ the Lebesgue interval. This is an atomless measure algebra, so the Lebesgue interval $(I, \lambda)$ is actually an interval.
\item More generally, any radon measure gives rise to an atomless measure algebra and thus also gives rise to an interval.
\item Note that not all intervals are atomless probability algebras. Consider the subalgebra
\[
A = \{(x_i) \in \prod_{i=1}^{\infty} I \mid \text{ finitely many } x_i \neq 0 \text{ or finitely many } x_i \neq 1 \}
\]
of the product of boolean algebras $\prod_{i \in \mathbb{N}} I$, where $(I, \lambda)$ is the Lebesgue interval. For some intuition on product boolean algebras, see \ref{partitions}. $A$ is the boolean algebra generated by elements that are everywhere zero except at one index. Note that $A$ is not complete and we have a measure on this boolean algebra defined by
\[
\mu((x_i)) := \sum_{i=1}^{\infty} 2^{-i} \lambda(x_i) ,
\]
where $\lambda$ denotes the Lebesgue measure on the $i$th Lebesgue interval. It can be easily seen that the defined boolean probability algebra is actually an interval.
\end{itemize}
\end{example}


\begin{theorem} \label{classifying}
The topos $\Sh(\FinProb,J_{at})$ classifies the theory $\mathbb{T}_{int}$. Moreover, $U$ is the universal model that gives us the required equivalence.
\end{theorem}
\begin{proof}
We use \cite{caramello_book}, corollary 8.1.14 and \ref{classifying_presheaf} in order to get that $\Sh(\FinProb,J_{at})$ classifies $\mathbb{T}_{bpalg}$ together with an axiom
\[
\phi_{\alpha}^{\vec{b}} \vdash_{\vec{b}} (\exists \vec{a}) \theta_f^{\vec{a},\vec{b}}
\]
for each morphism $f: \alpha \to \beta$ in $\FinProb$. One can easily see that the axioms
\[
\phi_{U_{r+s,t}}^{\vec{b}} \vdash_{\vec{b}} (\exists \vec{a}) \theta_f^{\vec{a},\vec{b}}
\]
suffice, where $f: U_{r,s,t} \to U_{r+s,t}$ joins the first two elements. Note that $r,s$ and $t$ denote any elements in $[0,1]$. Now, the axioms above are precisely reformulations of the interval axioms.

Now we compute the universal model. By the way that the equivalence in \cite{caramello_book}, corollary 8.1.14 is constructed \footnote{One can use the commutative square in theorem 8.1.3 to see this, with a similar argument as in the remark below.}, the universal model is the sheafification on $U$. But we can show that $U$ is already a sheaf by using \ref{sheaf_condition_weak}. This tells us that $p_1^{-1}(a) = p_2^{-1}(a)$, which means that
IT IS A SHEAF BY ATOM NOTATION! % Explain why we don't need to sheafify coproducts!!!
\[
\forall x,y \text{ such that } f(x) = f(y): x \in a \Leftrightarrow y \in a .
\]
This is equivalent to the fact that
\[
\forall x \in X: f^{-1}(x) \cap a \text{ is } \emptyset \text{ or } f^{-1}(x) .
\]
But this means, that we can lift the subset $a \in U(\alpha)$ to a subset $b \in U(\beta)$, and the subset clearly must be unique.

Thus we can conclude that $U$ is in fact the universal model in $\Sh(\FinProb, J_{at})$.
\end{proof}

\begin{remark} \label{classifying_equiv_data}
Using the commutative square(it only commutes up to isomorphism) for any Grothendieck topos $\mathcal{E}$
\[
\begin{tikzcd}
\mathbb{T}_{int}\text{-}mod(\mathcal{E}) \arrow[d] \arrow[r, "\simeq"] & {Geom(\mathcal{E},\Sh(\FinProb,J_{at}))} \arrow[d, "j \circ -"] \\
\mathbb{T}_{bpalg}\text{-}mod(\mathcal{E}) \arrow[r, "\simeq"]         & {Geom(\mathcal{E},\Set^{\FinProb^{op}})}
\end{tikzcd}
\]
in theorem 8.1.3 in \cite{caramello_book}, one can extract more information about how to compute the equivalence. Here $j$ denotes the sheafification functor. First, note that the inclusion on the left hand side is fully faithful and that the functor on the bottom is given by the functor in \ref{inverse}. Thus we can choose the equivalence on the top such that it is precisely defined by the interpretation in \ref{inverse}.

Thus, we can explicitly describe the equivalence of categories
\[
    \mathbb{T}_{int}\text{-}mod(\mathcal{E}) \simeq Geom(\mathcal{E},\Sh(\FinProb,J_{at}))
\]
by giving the functor going to the right as the interpretation in \ref{inverse} and the functor going to the left by Yoneda embedding the universal model $U$.

In particular, if we have a model $(A,\mu)$ of $\mathbb{T}_{int}$ in $\Set$, we can view it as a geometric morphism $\Set \to \Sh(\FinProb, J_{at})$ by specifying it as the $J_{at}$-flat functor $\FinProb \to \Set$ given by sending a finite probability space $(X,\nu)$ to the set
\[
\{(a_i)_{i \in X} \mid a_i \in A \text{ are pairwise disjoint, } \mu(a_i) = \nu(i) \}
\]
and by sending a map $(X,\nu_1) \to (Y,\nu_2)$ the map
\[
(a_j)_{j \in X} \mapsto \big (\bigvee_{f(j) = i} a_j \big )_{i \in Y} .
\]
\end{remark}


\subsection{Completeness and quantifier elimination}

TODO: THIS SECTION IS UBERSCUFFED RIGHT NOW
\begin{corollary}
Every infinitary first-order formula over the empty context over the theory $\mathbb{T}_{int}$ is provably equivalent to $\top$ or $\bot$ in $\mathbb{T}_{int}$.
\end{corollary}
\begin{proof}
    Since we know that infinitary first-order formulas can be internalized in $\Prob$ [cite sth], we only need to remark that a formula over the empty context invernalizes to a subobject of the subobject classifier. Because the subobject classifier only has two subobjects, the claim follows.

    We need to talk about infinitary first-order logic sites(or use claims about those in the literature) in order to be more precise.
\end{proof}
% This result is particularly remarkable. The study of the geometric logic of $\Sh(Fin\Set, J_{at})$ corresponds to the study of geometric statements over the boolean probability algebra signature on $(I, \lambda)$. Thus $\mathbb{T}_{int}$ can be thought as a synthetic context for studying geometric properties of the measure-theoretic interval.

% All this should be defined much more carefully
\begin{corollary}
    Let $\{ \vec{x} . \psi\}$ be a formula in context over the theory $\mathbb{T}_{int}$, where $\vec{x} = x_1, \cdots x_n$. Then it is provably equivalent to a a formula of the form $\{\vec{y} . \bigvee_j \phi_{U_{r_i^j}} \}$, where each of the $r_i^j$ in the family is in $P^1_{2^n}$ and $\vec{y} = y_1,\cdots,y_{2^n}$.
\end{corollary}
\begin{proof}
    Let $\{ \vec{x} . \psi\}$ such a formula in context, where $\vec{x} = x_1, \cdots x_n$. Then it internalizes to a subobject of the iterated cartesian product $U^n$, where $n$ is the length of the context. Since we can compute $U^n$ using multi-products to be $\la * \mid t_{i_1,\cdots i_n} \in P^n_{2,\cdots 2} \ra$, we know that $\{ \vec{x} . \psi\}$ is a join of the subobjects given by atoms. But the subobjects given by the atoms are precisely the $\phi_{X,\mu}$, so the claim follows.

    Here in reality we also need some results about infinitary first order logic sites, if we want to be precise.
\end{proof}

This is a form of quantifier elimination, only that this is a bit different than traditional quantifier elimination in that we can't guarantee that the equivalent quantifier-free formula has only finite joins. Moreover, our formulas aren't even over the same context.

\section{$\Prob$ as the classifying topos of a theory of simple functions}

\subsection{Simple functions} \label{simple_functions}

In this section we aim to illustrate how we can use $\Prob$ in order to look at problems in probability theory that have a more combinatorial and less analytic nature.

% TODO: We should throughly explain why stuff like L^0 doesn't work and the philosophical ramifications of this. Because it is very nonobvious and philosophically interpreting Prob has been and still is one of the hardest problems we have faced. It would be retarded not to write about it.

\begin{definition}
    Define the presheaf $\mathcal{S}$ of simple functions on $\FinProb$ to be defined by sending $(X,\mu)$ to the set of maps of sets $\mathbb{R}^X$ and by sending maps between finite probablitiy spaces to the corresponding precomposition maps.
\end{definition}

We show that $\mathcal{S}$ is a sheaf by showing that $\mathcal{S}$ is a coproduct of atoms.

\begin{proposition}
    We have that
    \[
        \mathcal{S} \cong \la \{y_1 < \cdots < y_n \mid y_i \in \mathbb{R} \} \mid (r_1, \cdots, r_n) \in \mathcal{A} \ra
    \]
    and in particular, $\mathcal{S}$ is a sheaf.
\end{proposition}
\begin{proof}
    The essential observation is that we can describe any $s \in \mathbb{R}^X$ by looking at the ordered set of values in $\mathbb{R}$ that the function $s$ takes.
\end{proof}


The point of this chapter is convincing the reader that for a model $F: \mathcal{E} \to \Prob$, $F^*(\mathcal{S})$ is a suitable definition for the simple functions over $F$ in $\mathcal{E}$. We will prove that we can recover the simple functions over a $\sigma$-algebra with this construction. Of course, for proving meaningful statements, we want to equip $\mathcal{S}$ with suitable structure.

\begin{definition}
    Define the theory of expectation algebras to be the geometric theory of $\mathbb{R}$-algebras together with a unary relation symbol $E_r$ for each $r \in \mathbb{R}$, adding the following geometric sequents:
    \begin{enumerate}
        \item \textit{$E_r$ form a partition}. For all $r, s \in \mathbb{R}$ with $r \neq s$ we have an axiom
        \[
        E_r(a)  \wedge E_s(a) \vdash \bot
        \]
        and we also have an axiom
        \[
        \top \vdash \bigvee_{r \in \mathbb{R}} E_r(a).
        \]
        \item \textit{Linearity}. For all $r, s \in \mathbb{R}$, we require the sequents
        \[
        E_r(a) \wedge E_s(b) \vdash E_{r+s}(a + b)
        \]
        and for all $r \in \mathbb{R}$ and $\lambda \in \mathbb{R}$, we also need
        \[
        E_r(a) \vdash E_{\lambda r} (\lambda \cdot a) .
        \]
        \item \textit{Positivity}.
        \[
            \top \vdash \bigvee_{r \geq 0} E_r a^2
        \]
        \item \textit{Expectation}.
        \[
            \top \vdash E_1 1
        \]
        \item \textit{No nullsets}.
        \[
            E_0 (a^2) \vdash a = 0 % We need to be careful what we write here, since a priori I don't see why our algebra should be an integral domain.
        \]
    \end{enumerate}
    %     \item Define expectation algebra structure on $\mathcal{S}$.
    %     \item Let $\alpha$ be a model of the theory of intervals in a topos $\mathcal{E}$, i.e. a geometric morphism $\mathcal{E} \to \Prob$. Then we define the simple functions over $\alpha$ to be the expectation algebra that the inverse image functor sends $\mathcal{S}$ to.
    % \end{enumerate}
\end{definition}

Here we made use of the same trick we used when defining the theory of boolean probability algebras. We used unary relation symbols to encode a function. The thing that now is different, is that if we have a real $\lambda \in \mathbb{R}$, we get again a canonical element of our $\mathbb{R}$-algebra, since we can consider $\lambda \cdot 1$. This means that if $A$ is an $\mathbb{R}$-algebra in any topos, we get a canonical operator $\mathbb{E}: A \to A$, which can be thought of an expectation operator.

% TODO: Is this even true?
Now under the usual functional-analytic correspondence of finitely additive measures and linear operators to $\mathbb{R}$, the fact that a measure is non-negative corresponds to our \emph{positivity} axiom. The fact that a measure is a probability measure, corresponds to our \emph{expectation} axiom. The \emph{no nullsets} axiom corresponds to the fact that there is only one element of measure zero in a boolean probability algebra. Note that we could have also axiomatized the operator $\mathbb{E}$ directly, although that wouldn't necessarily have been easier.

% TODO: ref this:https://terrytao.wordpress.com/2014/06/28/algebraic-probability-spaces/

We can now define expectation algebra structure on $\mathcal{S}$. Note that we do not yet check the axioms, for now we will only think of $\mathcal{S}$ as a structure over the signature of the theory of expectation algebras.

\begin{definition}
    \begin{enumerate}
        \item Define $+: \mathcal{S} \times \mathcal{S} \to \mathcal{S}$ on the components of the natural transformation by pointwise addition of the $s \in \mathbb{R}^X$.
        \item Define $\cdot: \mathcal{S} \times \mathcal{S} \to \mathcal{S}$ on the components of the natural transformation by pointwise multiplication of the $s \in \mathbb{R}^X$.
        \item Define $E_r \xrightarrow{} \mathcal{S}$ to be the subsheaf that on an object $(X,\mu)$ consists of the $s \in \mathbb{R}^X$ with $\sum_{i \in X} s(i) = r$.
    \end{enumerate}
\end{definition}

Our aim is to send $\mathcal{S}$ and its structure through inverse image functors. Thus it is imperative to figure out how our structure behaves on the atoms. The first step is decomposing $\mathcal{S} \times \mathcal{S}$:

\begin{align*}
    S \times S &\cong \la \{y_1 < \cdots < y_n \mid y_i \in \mathbb{R} \} \mid (r_1, \cdots, r_n) \in \mathcal{A} \ra^2 \\
    &\cong \la \{y_1 < \cdots < y_n, z_1 < \cdots < z_m \mid y_i, z_j \in \mathbb{R} \} \mid (t_{ij})_{1 \leq i \leq n, 0 \leq j \leq m} \in \mathcal{A}\ra
\end{align*}

Now we can use \ref{atom_coprod_maps} to specify our structure on the elements of this set of atoms:

\begin{proposition}
    \begin{enumerate}
        \item We calculate addition on an element $(t_{ij}, y_i, z_j)$. Let $x_1 < x_2 < \cdots < x_k$ denote the elements of $\{y_i + z_j \mid i,j \}$. Then addition is given on elements by
        \[
            (t_{ij},y_i,z_j) \mapsto (\sum_{y_i + z_j = x_k} t_{ij}, x_k)
        \]
        with the corresponding map on atoms
        \[
            U_{t_{ij}} \to U_{\sum_{y_i + z_j = x_k} t_{ij}}
        \]
        defined to be the join the two pairs $(i,j)$, $(i',j')$ if the equality $y_i + z_j = y_{i'} + z_{j'}$ holds.
        \item We calculate multiplication on an element $(t_{ij}, y_i, z_j)$. Let $x_1 < x_2 < \cdots < x_k$ denote the elements of $\{y_i \cdot z_j \mid i,j \}$. Then we multiplication is given on elements by
        \[
            (t_{ij},y_i,z_j) \mapsto (\sum_{y_i \cdot z_j = x_k} t_{ij}, x_k)
        \]
        with the corresponding map on atoms
        \[
            U_{t_{ij}} \to U_{\sum_{y_i \cdot z_j = x_k} t_{ij}}
        \]
        defined to be the join the two pairs $(i,j)$, $(i',j')$ if the equality $y_i \cdot z_j = y_{i'} \cdot z_{j'}$ holds.
        \item $E_r \to \mathcal{S}$ is the subobject
        \[
            \la \{y_1 < \cdots < y_n \mid y_i \in \mathbb{R}, \sum r_i y_i = r \} \mid (r_1, \cdots, r_n) \in \mathcal{A} \ra
        \]
        of $\mathcal{S}$.
    \end{enumerate}
\end{proposition}

Having defined the simple functions in $\Prob$, we can define simple functions in great generality.

\begin{definition}
    Let $F: \mathcal{E} \to \Prob$ be an interval in $\mathcal{E}$. Then we can define the simple functions over $F$ to be $F^*(\mathcal{S})$ equipped with the corresponding expectation algebra structure.
\end{definition}

For the sake of comparing this unusual definition of the set of simple functions to the more standard one, we recall the following:

\begin{definition}
    Define the expectation algebra of simple functions $S(X,\Sigma, \mu)$ on a probability space $(X, \Sigma, \mu)$ to be the set of measurable maps $X \to \mathbb{R}$ of finite image modulo equality almost everywhere equipped with pointwise addition, pointwise multiplication and expectation.
\end{definition}

\begin{proposition}
    Let $(X, \Sigma, \mu)$ be a probability space such that the corresponding measure algebra is atomless. Then $S(X,\Sigma,\mu)$ is isomorphic to the expectation algebra over the corresponding interval.
\end{proposition}
\begin{proof}
    The atomless measure algebra of $(X, \Sigma, \mu)$ is an interval and thus can be viewed as a geometric morphism $F: \Set \to \Prob$. $F^*$ sends an atom $U_{r_i}$ to the set of partitions of the interval with measures $r_1,\cdots,r_n$. Thus, since $F^*$ is colimit preserving, $\mathcal{S}$ gets sent to
    \[
        \coprod_{\substack{r_1, \cdots r_n \in \mathcal{A} \\ x_1 < \cdots < x_n}} F^*(U_{r_1\cdots r_n}) .
    \]
    It should be clear that this corresponds to the traditional set of simple functions. It is a straightforward calculation that expectation, addition and multiplication are the correct ones. The necessary setup has already been done, since addition and multiplication have already been decomposed into their components on atoms.
\end{proof}

This proof ilustrates one of the most fascinating things about the set of atoms notation(the same goes for the $(\FinProb, J_{at})$ site). Partitions are treated on a very abstract level, where it does not even make sense to ask \emph{where} the different parts of the partitions are located. There is simply no data about the location of the partition, only how big it is. The way we defined the simple functions, we never had to deal with issues about \emph{where} exactly a simple function took a specific value, but instead just specified the measure of the preimages.

Applying the inverse image functors of models inserts that missing location information(similarly when passing to the group action sites). The sets we deal with are suddently much, much bigger. The surprising thing, is that for the purposes of calculating with simple functions, that data is fully irrelevant.

\begin{theorem}
    \begin{enumerate}
    \item $\mathcal{S}$ is an expectation algebra.
    \item The simple functions over an interval(one should explicitly give this theory, by stating the interval property for characteristic functions and state the Morita equivalence explicitly, maybe?) are all infinitary first order equivalent as expectation algebras.
    \end{enumerate}
\end{theorem}
\begin{proof}
    Use that the topos is two-valued.
\end{proof}

% TODO: Say that poset structure also matches, since x \leq y iff y - x is a square.

say the following
\begin{enumerate}
    \item Legitimizes(to a certain degree) the belief that the base $\sigma$-algebra does not matter
    \item Extremely interesting: This technique is not at all specific to $\Prob$. One can imagine proving similar results in a wide variety of other contexts. Classical Model theory could not prove this kind of stuff?
\end{enumerate}

\subsection{Transfer results for $L^\infty$-spaces}
%TODO: PROVE THAT ANY function $f:\mathbb{R} \to \mathbb{R}$ we get a map $f: \mathcal{S} \to \mathcal{S}$(defined pointwise) that gets sent to the expected map on atomless $\sigma$-algebras.

We will now try to transfer statements between $L^\infty(X,\mu)$ for atomless probability algebras $(X,\mu)$. The key insight is that we know how to transfer statements about simple functions and bounded measurable functions can be approximated by them. Another insight is, that every bounded, measurable function on a probability space is integrable. So $L^\infty(X,\mu)$ is an expectation algebra, in particular, for any probability interval $(X,\mu)$ in \Set.
\begin{definition} For a expectation algebra $S$ we define:
\begin{enumerate}
\item $f\geq g$ if $\exists h. h^2=f-g$
\item $|f|$ is the function uniquely determined by $f^2=|f|^2\wedge |f|\geq 0$
\item $f^+=\frac{1}{2}(f+|f|)$ and $f^-=\frac{1}{2}(f-|-f|)$
\item For $p$ an integer, $||f||_p=r$ if $E_{r^p}(|f|^p)$
\item $||f||_\infty=r$ if $\bigwedge_{k\in\mathbb{N}}\bigvee_{N\in\mathbb{N}}\bigwedge_{n\geq N}\bigvee_{-1/k\leq s\leq 1/k}||f||_{n}=r+s$

\end{enumerate}
\end{definition}
The last definition is motivated by the fact that for the algebras simple functions and bounded functions, we have
\[  \\limit_{n\rightarrow \infty} ||f||_n=||f||_\infty. \]
Note that the fact that all statements of the previous definition are infinitary first order, we can transfer statements using them between algebras of simple functions. The next insight will be that we can actually define given simple functions uniquely using only infinitary first order language in the theory of expectation algebras.\newline
\indent The next step is to characterise simple functions among bounded measurable functions. This will also allow us to classify the definable subsets of algebras of simple functions.
\begin{definition} For an expectation algebra $S$, $f$ is called a
\begin{enumerate}\item \emph{characteristic function} if $(f-1)^+-f^- -(f-1)^-f^+=0$. Write this relation $\chi$.
\item \emph{simple function} if $\bigvee_{n\in \mathbb{N}}\exists f_1 \cdots \exists f_n. \bigwedge_{i=1}^n \chi(f_n)\wedge \bigvee_{r_1,\cdots,r_n\in\mathbb{R}} f=\sum_{i=1}^n r_if_i$. Call this relation $s$.
\end{enumerate}
\end{definition}
In the case of $L^\infty(X,\mu)$ or $S(X,\mu)$, these definitions can easily be seen to be equivalent to the ordinary ones. Note also that these are geometric statements.
\begin{theorem}
The complete boolean algebra of subsets of $S(X,\mu)^n$ for an interval $(X,\mu)$ in \Set, definable by infinitary first order (equivalently geometric) statements in the theory of expectation algebras, with $n$ free variables, is generated by subsets of the form:
\[\{(f_1,\cdots, f_n)\mid f_1,\cdots, f_n\text{have cumulative distribtion function g}\} \]
for $g:\mathbb{R}^n\rightarrow\mathbb{R}$ cumulative distribution functions of $n$-tuples of simple functions.
\end{theorem}
\begin{proof}
These subsets correspond precisely to the images under $f^*$, the inverse image functor classifying $(X,\mu)$, of the atoms of $\mathcal{S}^n$. This shows, that the lattice of definable sets is certainly contained in the lattice given in the statement.\newline
\indent For the converse, we have to construct for any cumulative distribution function of an $n$-tuple of simple functions, a infinitary first order statement satisfied by precisely all the $n$-tuples of simple functions with the same cumulative distribution function. Given simple functions some interval $(X,\mu)$ in \Set $f_i=\sum_{j=1}^{m} r_{j}\chi_{a_j}$ for $1\leq i\leq n$ with and $a_j\neq 0$ disjoint from $a_{j'}$ for  $j\neq j'$ on. Say $\mu(a_{j})=\mu_{j}$.  We claim that the following geometric statement with free variables $h_i$ characterises all the simple functions with the same distribution function as $f_i$:
\[\exists g_1\cdots \exists g_m. \bigwedge_{j=1}^m(\chi (g_j)\wedge E_{\mu_{j}}(g_j))\wedge \bigwedge_{i=1}^n\sum_{j=1}^m r_jg_j=h_i   \]  %make this prettier and internal to $\mathcal{S}$!
\end{proof}
We will now see that we can generalise this theorem to all measurable functions and, with that, get a transfer result. First some lemmas.
\begin{lemma} The one for atomic statements
\end{lemma}
\begin{lemma}\label{atomic_L_infty} Given an atomic statement in the theory of expectation algebras $\Phi(f_1,\cdots,f_n)$ with free variables $f_1,\cdots, f_n$. If it holds for functions $f_1,\cdots ,f_n\in L^\infty(X,\mu)$ for an atomless probability algebra $(X,\mu)$ in \Set, then it holds for all $n$-tuple $f_1',\cdots, f_n'\in L^\infty(X,\mu)$ with the same distribution function $g:\mathbb{R}^n\rightarrow \mathbb{R}$.
\end{lemma}
\begin{proof}
For any $n$-tuple of bounded measurable functions $f_1,\cdots, f_n$ and polynomial $f\in \mathbb{R}[X_1,\cdots, X_n]$, we have:
\[\int_X f(f_1,\cdots,f_n)d\mu=\\limit_{\substack{g_1\rightarrow f_1,\cdots, g_n\rightarrow f_n \text{ in }L^\infty\\ g_1\cdots g_n \text{ simple}}}  \int_Xf(g_1,\cdots,g_n)d\mu \]%formulate this properly
This is true as simple functions are dense in $L^\infty(X,\mu)^n$. Thus we have:
\[E_0(f_1,\cdots,f_n)\iff \forall g_1\cdots \forall g_n.(\bigwedge_{i=1}^n s(g_i))\wedge\bigwedge_{\epsilon>0}\bigvee_{\delta>0}(\bigvee_{0\leq r\leq \delta}||f_i-g_i||_\infty=r \]
\[\implies\bigvee_{|s|\leq\epsilon} E_s(g_1,\cdots,g_n) )\]%bad and ugly
$E_s(g_1,\cdots,g_n)$ only depends on the cumulative distribution function of $g_1,\cdots,g_n$. So it will already hold if not $||f_i-g_i||_\infty=r$ but merely $g_i$ have the same  cumulative distribution function as some $n$-tuple of simple functions for which this holds. The existence of such a tuple can be read off the cumulative distribution function of $f_1,\cdots,f_n$.%Finish the argument
\end{proof}
\begin{lemma}\label{distribution_L_infty} The joint cumulative distribution functions of $n$-tuple of bounded measurable functions on an atomic probability algebra $(X,\mu)$ in \Set are precisely the functions $g:\mathbb{R}^n\rightarrow \mathbb{R}$ which are:
\begin{enumerate}
\item Right-continuous in all variables
\item Non-decreasing in all variables
\item There exist real numbers $r_1,\cdots,r_n,s_1,\cdots, s_n$, such that we have $f(x_1,\cdots,x_n)=0$ for all $x_i\leq r_i$ and $f(x_1,\cdots,x_n)=1$ for all $x_i\geq s_i$  and for each $i$ and numbers $x_j$ for $i\neq j$, $f(x_1,\cdots,x_n)$ is constant in $x_i$ outside $[s_i,r_i]$.%Check this is the right condition
\end{enumerate}
\end{lemma}
\begin{proof}
We adopt a proof of a similar statement from [Probability: Theory and Examples by Rick Durrett, Thm 1.2.1 and 1.2.2].
\begin{enumerate}
\item It is right continuous as $\\limit_{y\rightarrow x^+}f^{-1}(-\infty,y)=f^{-1}(-\infty, x)$
\item The function is non-decreasing in all variables by the monotonicity of the measure
\item As the functions are bounded in both directions, we have $\mathbb{E}((f-c)^+)=1$ for some $c$ small enough and $\mathbb{E}((f-c)^+)=0$ for some $c$ large enough.
\end{enumerate}
Conversely, given such a joint cumulative distribution function, we seek to construct an $n$-tuple of functions with these properties. The reference describes how this can be done for the Lebesque interval. So it suffices to construct a measure preserving measurable function $f:(X,\mu)\rightarrow (I,\lambda)$. We repeatedly use the interval property to define elements $x_{\frac{1}{2}}$ of $X$ of measure $\frac{1}{2}$, then bisecting it and its complement to get elements $x_{\frac{k}{2^n}}$ of measure $\frac{1}{2^n}$. We now define the map by $f^{-1}(0,r)=\bigvee_{\frac{k}{2^n}\leq r} x_{\frac{k}{2^n}} $. %make this precise
\end{proof}
\begin{corollary}\label{quantifierfreeLinfty}
Given a \emph{quantifier-free} infinitary first-order statement $\Phi$ in the theory of expectation algebras and any atomless probability algebras $(X,\mu)$ and $(Y,\nu)$ then we have:
\[L^\infty(X,\mu)\vDash\Phi \iff L^\infty(Y,\nu)\vDash \Phi \]
\end{corollary}
\begin{proof}
This is true for atomic statements simply because they only depend on the joint cumulative distribution function of the free variables and the set of these functions coincides for all choices. A simple symbolic recursion yields the quantifier-free case.
\end{proof}
Interestingly, we \emph{cannot} extend this result to statements containing quantifiers in general! Almost magically, statements in the theory of expectation algebras for $L^\infty(X,\mu)$ can detect whether elements in the underlying probability algebra $(X,\mu)$ are countably generated. This was the case neither for the theory of intervals nor for simple function algebras.
\begin{definition} A probability algebra $(X,\mu)$ is said to be $\aleph_1$\emph{-atomless} if there exists no element $x\in X$ such that the boolean algebra $\downarrow x$ is countably generated.
\end{definition}
These probability algebras have the following saturation property, which is necessary for dealing with quantifiers:
\begin{lemma} Given a function $g:\mathbb{R}^n\rightarrow \mathbb{R}$ with the conditions of lemma \ref{distribution_L_infty} and bounded measurable functions $f_1,\cdots, f_{n-1}\in L^\infty(X,\mu)$ for some $\aleph_1$-atomless probability algebra $(X,\mu)$, such that their joint cumulative distribution function $\tilde{g}:\mathbb{R}^{n-1}\rightarrow \mathbb{R}$ has
\[g(x_1,\cdots, x_n)=\tilde{g}(x_1,\cdots, x_{n-1}) \text{ for }x_n\text{ large enough} \]
Then there exists a bounded measurable function $f_n\in L^\infty(X,\mu)$ such that the joint cumulative distribution function of $f_1,\cdots,f_n $ is $g$.
\end{lemma}
\begin{proof}
This is essentially 4.5 [Keisler paper].
\end{proof}
\begin{remark} It is shown in [Keisler paper] that this lemma fails for the Lebesgue interval. Also note that such probability algebras actually exist, see ibid.
\end{remark}
\begin{theorem}
For any infinitary first order statement in the theory of expectation algebras $\Phi$ and all $\aleph_1$-atomless probability algebras $(X,\mu)$, $(Y,\nu)$, we have:
\[L^\infty(X,\mu)\vDash\Phi \iff L^\infty(Y,\nu)\vDash\Phi \]
Moreover, the subsets of $L^\infty(X,\mu)^n$ definable by infinitary first order statements are precisely unions of sets of the form
\[\{(f_1,\cdots,f_n)\mid f_1,\cdots,f_n \text{ have cumulative distribution function }g \} \]
where $g:\mathbb{R}^n\rightarrow\mathbb{R}$ is right-continuous and non-decreasing, zero for all values small enough and one for all values large enough in all variables.
\end{theorem}
\begin{proof}
We seek to extend the result of \ref{quantifierfreeLinfty} to statements containing quantifiers. To do this we use symbolic recursion:\newline
\indent Assume one has a statement $\Phi(f_1,\cdots f_n)$ with free variables $f_1,\cdots, f_n$ which only depends on the joint cumulative distribution of $f_1,\cdots, f_n$. We seek to show that then, so does $\exists f_1.\Phi(f_1,\cdots f_n)$. \newline
\indent We have shown that the validity of all statements only depends on the joint cumulative distribution function of the free variables. This concludes the first part of the lemma in conjunction with lemma \ref{distribution_L_infty} as the joint cumulative distribution functions are exactly the same.\newline
\indent So it remains to show that we can define the set
\[\{(f_1,\cdots,f_n)\mid f_1,\cdots,f_n \text{ have cumulative distribution function }g \} \]
 with $g$ as in the statement. This is possible with the following statement:
 \[\bigwedge_{n\in \mathbb{N}}\text{There exist a lot of simple functions below it...} \]
This concludes the second part of the lemma.
\end{proof}
\begin{remark} This gives definitive evidence, that there cannot a "universal" $L^\infty$ algebra in $\Prob$, whose images under the inverse image functors given by models $(X,\mu)$ are precisely the expectation algebras $L^\infty(X,\mu)$. For this, we would need a topos that somehow axiomatises the property of being $\aleph_1$-atomless, which is, as we stated it, formulated in second order logic.
\end{remark}
\section{$\Prob$ as a topos of continuous group actions}

We seek to apply the following result due to O.Caramello:

\begin{theorem}\label{olivia}
Let $\C$ be a small, inhabited category satisfying the amalgamation and joint-embedding properties, and let $u$ be a $\C$-universal and $\C$-ultrahomogeneous object in $Ind(\C)$. Then the collection $\mathcal{I}_{\C}$ of sets of the form $\mathcal{I}_{\chi}:=\{f:u\overset{\sim}{\rightarrow} u\mid  f\circ \chi=\chi\} $, for an arrow $\chi:c\rightarrow u$, form an object $c$ of $\C$ to $u$ defines an algebraic base for the group of automorphisms of $u$ in $Ind(\C)$, and, denoted by $Aut_\C$ the resulting topological group, we have an equivalence of toposes
\[\Sh(\C^{op},J_{at})\simeq \text{Cont}(Aut_\C) \]
induced by the functor $F:\C^{op}\rightarrow \text{Cont}(Aut_{\C})$ which sends any object $c$ of $\C$ to the set $\Hom_{Ind(\C)}(c,u)$ equipped with the action by post-composition and any arrow $f:c\rightarrow d$ in $\C$ to pre-composition by $f$.
\end{theorem}

In our context we set $\C=BPAlg_f$ and will show that the Lebesgue interval is $BPAlg_f$-universal and $BPAlg_f$-ultrahomogeneous. But before we do that, we need some remarks that will be used in our proof.

\begin{remark}\label{partitions}
For an element $a \in B$ of a boolean algebra, we will denote the ideal of elements of $B$ that are less than or equal to $a$ by $I(a)$.
\begin{enumerate}
\item In the category of boolean algebras, if one has a \\ boolean algebra $A$, we get the following correspondence between decompositions $A \cong B \times C$ and partitions $a,b$ (i.e. pairs of elements $a,b$ with $a \vee b = 1$ and $a \wedge b = 0$). A decomposition $B \times C$ induces the partition $(1,0), (0,1)$ on $A$ and conversely the partition $a,b$ induces the decomposition \\ $A \cong I(a) \times I(b)$. This lets us interpret the product of boolean algebras as some sort of disjoint union.
\item The interesting thing about this description of products, is that it shows that if we have a map $A \to B$ of boolean algebras and we have a decomposition $A \cong A_1 \times A_2$, then this induces a decomposition of $B$.
\item Given two boolean probability algebras $(A, \mu)$ and $(B, \nu)$, there is a measure $(\mu + \nu)(x,y) := \mu(x) + \nu(y)$ on $A \times B$. Unfortunately, this can't be the product in $\BPAlg$, because $\mu + \nu$ is not a probability measure nor are the projections measure-preserving.
\end{enumerate}
\end{remark}

We could now start proving that the Lebesgue interval satisfies the required properties, but in order to emphasize that the Lebesgue interval is not really special, we will will prove that a well-known more general class of measure algebras is $BPAlg_f$-universal and $BPAlg_f$-ultrahomogeneous. The reader can ignore this and pretend that he is dealing with the Lebesgue interval.

\begin{definition} \label{maharam_type_homogeneous}
% TODO: Maharam-type homogeneous should be emphazised less by intead always requiring the 'ultrahomogeneous' hypothesis.
\begin{enumerate}
\item Let $A$ be a complete boolean algebra. We say that a subset $S \subset A$ generates $A$ if $A$ is the only complete boolean subalgebra of $A$ containing $S$.
\item Let $A$ be a complete boolean algebra. We say that the Maharam type of $A$ is the smallest possible cardinality of a generating set.
\item We moreover say that $A$ is Maharam-type-homogeneous if the Maharam type of every nonzero principal ideal $I(a)$ is the same.
\item Call a measure algebra Maharam-type-homogeneous if its underlying boolean algebra is Maharam-type homogeneous.
\end{enumerate}
\end{definition}

For more information on Maharam-type-homogeneous measure algebras, see chapter 33 of \cite{fremlin}. The crucial fact about Maharam-type-homogeneous measure algebras, is they are isomorphic if and only if they have the same Maharam type and the top element $1$ has the same measure on both measure algebras(see 331I of \cite{fremlin}). Moreover, there is a surprising theorem by Maharam (see 332J in \cite{fremlin}) that lets us decompose any atomless measure algebra into Maharam-type-homogeneous measure algebras.

Now we actually show that homogeneous-Maharam-type probability algebras are $BPAlg_f$-universal and $BPAlg_f$-ultrahomogeneous. More concretely, we prove the following for a Maharam-type-homogeneous probability algebra $(M, \alpha)$:

\begin{lemma}\begin{enumerate}
\item $\FinProb$ has a terminal object, proving the joint embedding property.
\item $\FinProb$ fulfills the right Ore condition.
\item For any $(A,\mu),(B,\nu)$ in $BPAlg_f$ , an arrow $f:(A,\mu)\rightarrow (B,\nu)$ in \\
 $BPAlg_f$, and arrows $\chi_1:(A,\mu)\rightarrow (M, \alpha)$ as well as $\chi_2:(B,\nu)\rightarrow (M, \alpha)$ in $\BPAlg$ there exists an isomorphism $j':(M, \alpha) \rightarrow (M, \alpha)$ such that $j'\circ \chi_1=\chi_2\circ j$:
 \begin{center}
 \begin{tikzcd}
{(A,\mu)} \arrow[r, "\chi_1"] \arrow[d, "j"'] & {(M, \alpha)} \arrow[d, "j'", dotted] \\
{(B,\nu)} \arrow[r, "\chi_2"']                & {(M, \alpha)}
\end{tikzcd}
 \end{center}
\item For any object $(A,\mu)$ of $BPAlg_f$ there exists an arrow $\chi:(A,\mu)\rightarrow (M, \alpha)$ in $\BPAlg$.
\end{enumerate}
\end{lemma}
\begin{proof}
\begin{enumerate}
\item The one-element set $\{*\}$ with with measure $\mu(\star)=1$ is the terminal object. Its underlying set the terminal object in $\Set$ and the universal map is tautologically measure preserving.
\item We have already shown this in \ref{pullback_measure}.
\item
Now, given boolean probability algebras as in the claim above, we see that $(A, \mu)$ has a partition into atoms $x_i$. Crucially, if we apply a map of boolean algebras to this partition, we get a partition again. This means we can decompose our problem(by \ref{partitions}) into finding a measure-preserving map $j'$ as below:
\[
\begin{tikzcd}
2 \arrow[d, "j"'] \arrow[r, "\chi_1"]  & I(\chi_1 x_i) \arrow[d, "j'", dotted] \\
I(j x_i) \arrow[r, "\chi_2"'] & I(\chi_2 j x_i)
\end{tikzcd}
\]
Since $2 := \{0, 1\}$ is the initial object in boolean algebras, it suffices to show that we have an isomorphism of measure algebras
\[
I(\chi_1 x_i) \cong I(\chi_2 j x_i)
\]
for each $i$. Now both of these measure algebras are Maharam-type-homogeneous and have the same Maharam type, since $(M, \alpha)$ was Maharam-type-homogeneous. Moreover, the top element $1$ has the same measure in both algebras, so we can now use 331I in \cite{fremlin} in order to get our isomorphism.

\item A measure-preserving map $\chi:(\mathcal{P} X,\mu)\rightarrow (A,\mu)$ consists of precisely a partition of $(A,\mu)$ into finitely many elements of predetermined measure. But this is precisely the interval property for atomless measure algebras, see \ref{interval_examples}.

% \item $f_1(\mathcal{B}_1)$ and $f_2(\mathcal{B}_2)$ are subalgebras of $I$, so we may generate the smallest subalgebra of them, containing both. Define $\mathcal{B}_3=\la f_1(\mathcal{B}_1),f_2(\mathcal{B}_2) \ra $ with the measure induced by the Lebesgue measure. As $f_1(\mathcal{B}_1)$ and $f_2(\mathcal{B}_2)$ are isomorphism to $\mathcal{B}_1$ resp. $\mathcal{B}_2$, the diagram commutes. It remains to show that $\mathcal{B}_3$ is finite (resp. at most countable). This is obvious, however any element of it may be represented as the unions of intersections of atoms $b_1\wedge b_2$ of $b_1\in \mathcal{B}_1$, $b_2\in\mathcal{B}_2$.
\end{enumerate}
\end{proof}

\begin{remark}
Notice that by using 331I in \cite{fremlin} we have implicitly used the axiom of choice.
\end{remark}

\begin{corollary}\label{Galois} Let $(M, \alpha)$ be a homogeneous-Maharam-type probability algebra. Let $G$ be the group of automorphisms of $(M, \alpha)$ topologised via an algebraic base given by collections $\mathcal{M}_{\chi}:=\{f:u\overset{\sim}{\rightarrow} u\mid f\circ \chi=\chi\} $ of automorphisms fixing a finite partition $\chi: (A,\mu)\rightarrow (M, \alpha)$. Then we get an equivalence of toposes, which is induced as in \ref{olivia}:
\[\Sh(\FinProb, J_{at})\simeq \text{Cont}(G)\]
\end{corollary}
\begin{remark} In the case of the Lebesgue interval, its automorphisms are commonly known as \emph{measure-preserving dynamical systems}. This hints at a connection to ergodic theory.
\end{remark}
%It follows that the atoms of the topos correspond to open subgroups of $G$. We shall classify them. %give ref
\begin{proposition} The automorphism group of a homogeneous-Maharam-type probability algebra is simple by 383Ib \cite{fremlin}. In particular, all topos-theoretic invariants involving any sort of normal subgroup listed in \cite{caramello_lafforgue} are trivial.
\end{proposition}

Another feature of this description is that toposes of continuous group actions are quite well understood. The interest in researching them comes from their connection to set theory and representation theory. So called \emph{permutation models} are one of the main tools of forcing, and they will also appear later in this paper as another interpretation of $\Prob$. In a totally separate field of mathematics, a representation of a topological group on a $k$-vector space (with discrete topology) is nothing but an internal $k$-vector space \cite{XYZ} i.e. a sheaf of $k$-vector spaces in the topos of continuous group actions of that group.

Now that we have proved a non-trivial \emph{bridge}, we briefly discuss an application. We show that the universal model in $\Prob$ has not only finite meets and joins, but all meets and joins, in a sense to be defined.

\begin{definition} A sheaf $L$ of posets with finite meets and top element is called an \emph{internal locale} if the map
\[I: L\rightarrow \mathcal{P}(L) \]
sending ... has a right adjoint. An \emph{internal complete boolean algebra} is accordingly a sheaf of boolean algebras that is an internal locale.
\end{definition}

Our surprising result now follows by glueing some theorems from the literature.

\begin{theorem} The universal model of $\mathbb{T}_{int}$ is an internal complete boolean algebra.
\end{theorem}
\begin{proof}
We use the following equivalence of categories:
\[ \text{Cont}_\tau(\text{Aut}_{\BPAlg}(I,\lambda))\simeq \text{\Set}[\mathbb{T}_{int}]  \]
We can use Theorem 7.3 (and remark 7.2) \cite{caramello_lafforgue} %is this the correct ref?
 to see $(I,\lambda)$ is a special model of $\mathbb{T}_{int}$ and thus the universal model in $\text{Cont}_\tau(\text{Aut}(I,\lambda))$ is $(I,\lambda)$ with the canonical continuous group action.\newline
\indent Thus $U_{\mathbb{T}_{int}}$ is a complete boolean algebra acting on itself via automorphisms.  By C2.5.8(e) \cite{elephant} this proves that the universal model is an internal locale. Hence it is a complete boolean algebra.
\end{proof}

This theorem is remarkable as we get some completeness condition from definitions, which essentially only use statements about finite sets of variables. Nevertheless, we feel like it needs to be commented that the statement of this result might be a bit misleading at first sight. The reason is, that we will see in \ref{choice_failture}, that infinite families of variables often fail to exist inside $\Prob$.


\section{The atoms of $\Prob$ }\label{atoms}

Sheaves on sites are a very complicated data type. Not only does one need to give a set for each object in the site, one also has to specify functions between these set for any morphism in the site. On top of that, all this has to satisfy the sheaf condition. Similarly convoluted is the data of a morphism of sheaves.

Almost miraculously, this complexity can be reduced to next to non. This will require quite a lot of work though. We will see that any sheaf decomposes into a coproduct of \emph{atoms} and morphisms of sheaves are coproducts of maps between these atoms.

\begin{definition} An \emph{atom} of a topos is an object whose only two subobjects are trivial or itself. Note that constant sheaf of the empty set is not an atom.
\end{definition}

\begin{definition} Given a topos, the \emph{category of atoms} of a topos is the full subcategory of objects, which are atoms.
\end{definition}
\begin{theorem}
Given an atomic topos $\mathcal{E}$ and its category of atoms $\mathcal{E}_{at}$, then $\mathcal{E}_{at}$ fulfils the right Ore condition and we have
\[\Sh(\mathcal{E}_{at},J_{at})\simeq \mathcal{E} \]
More concretely, $\mathcal{E}$ is the $\infty$-positivisation of $\mathcal{E}_{at}$. This means any sheaf is a coproduct of atoms and any morphism of sheaves $f: F\rightarrow G$, where $F=\bigsqcup_{i\in M} A_i$ and $G=\bigsqcup_{j\in N} B_j$ for $A_i,B_j\in ob\mathcal{E}_{at}$, is a coproduct of maps $A_i\rightarrow B_{g(i)}$ in $\mathcal{E}_{at}$ for some function $g:M\rightarrow N$.
\end{theorem}
\begin{proof}
The statement is Proposition 4.21 of \cite{caramello}. % TODO: Why is this the same statement? Why is the topology on \mathcal{E}_{at} the atomic topology? There is at least some sort of commentary necessary here. Also, I don't like the usage of undefined terms like infinity positivasation and free completion, because it is not clear what that is even supposed to mean.
\end{proof}
We can quickly give a first description of the category of atoms in our case. But this will be not very workable.
\begin{proposition} Given a topological group $(G,\tau)$, the category of atoms of the topos $\text{Cont}_\tau (G)$ is equivalent to its subcategory of transitive, continuous actions. \cite{XYZ}
\end{proposition}
As our topos is equivalent to $\text{Cont}_\tau(\text{Aut}_{\BPAlg}(I,\lambda))$, this immediately gives a description of its atoms.
But again, it would be nice to have a more combinatorial, workable interpretation of these objects. First we need to classify the atoms (as sheaves on the atomic site on $\FinProb$) and thereby inadvertently the open subgroups of our topological groups.
\newline
\indent We have already seen some of the atoms: $y (X,\mu)$ for any finite probability space $(X,\mu)$. Any morphism $y (X,\mu)\rightarrow A$ for an atom $A$ is necessarily surjective, else its image would be a third subobject. As $A$ is not constantly $\emptyset$ and by the Yoneda lemma, such a map exists. Toposes are effective categories by IV.7.8 \cite{sheaves_geometry_logic}, so there exists an equivalence relation $R$ such that the following fork is a coequalizer diagram:
\begin{center}

\begin{tikzcd}
R \arrow[r, hook] & {y (X,\mu)\times y (X,\mu)} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & {y (X,\mu)}\arrow[r]&A
\end{tikzcd}
\end{center}

To exploit this, we will utilize the combinatorial method outlined in \cite{caramello_lafforgue} Prop 6.7. For this, we will need to understand internal equivalence relations on the sheaves $yU_{r_1\cdots r_n}$. We use \ref{multi-product} to yield the following description of an equivalence relation. \newline
\indent A relation is a subobject
\[R\hookrightarrow yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n}=\bigsqcup_{\substack{\sum_i t_{ij}=r_j \\ \sum_j t_{ij}=r_i}  }yU_{t_{ij}}\]
As these representable functors are atoms, this is equivalent to giving a subset of the set $S_{r_1\cdots r_n}:=\{(t_{ij})_{0\leq i,j \leq n} \mid \sum_i t_{ij}=r_j,\, \sum_j t_{ij}=r_i \}$ of matrices whose rows and columns sum to the $r_i$'s. We use Definition 6.5 (iii) \cite{caramello_lafforgue} to see that a relation is an equivalence relation iff it fulfils the following conditions:
\begin{enumerate}
\item Reflexivity:  The element induced by the diagonal $\Delta: yU_{r_1\cdots r_n}\rightarrow $\linebreak $ yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n}$ is in $R$ i.e. the following matrix is in $R$:
\[ \begin{bmatrix}
    r_{1}       & 0 & \dots & 0 \\
    0      & r_2 &  \dots &0 \\
    \vdots & \vdots &  \ddots& \vdots\\
    0       & 0& \dots & r_n
\end{bmatrix} \]
\item Symmetry: $R$ is invariant under swapping the factors of the product $ yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n}$ i.e. if $T\in R$ then so is its conjugate $T^\top$.
\item Transitivity: Given $(t^{(1)}_{ij})\in R$ and $(t^{(2)}_{jk})\in R$ and $(t_{ijk})$ corresponding to an atom of $yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n} \times yU_{r_1\cdots r_n}$ such that its images in the product of the first resp. last two components are $(t^{(1)}_{ij})$ resp. $(t^{(2)}_{jk})$ i.e.:
\[\sum_k t_{ijk}=t^{(1)}_{ij} \quad \sum_i t_{ijk}=t^{(2)}_{jk} \]
Then its image in the product of the first and third component lies in $R$ i.e.:
\[(t^{(3)}_{ik})\in R \text{ where }t^{(3)}_{ik}:=\sum_j t_{ijk}    \]
Geometrically:
%Geometrically, this means that for every $3$-dimensional matrix with values in $\mathbb{R}_{\geq 0}$, if the sums of the entries in two of the directions are  matrices in $R$, then so is the third:
\end{enumerate}
\begin{center}
\begin{tikzcd}[row sep=small, column sep= small]
             & t^{(2)}_{n1}                                  &              & t^{(2)}_{nn}                                                     &              &                                               &              \\
t^{(3)}_{n1} & t_{n11} \arrow[l, "\sum"'] \arrow[u, "\sum"'] & \cdots       & t_{n1n} \arrow[u, "\sum"']                                       &              &                                               &              \\
             & \vdots                                        & \ddots       & t_{11}^{(2)}                                                     & \ddots       & t^{(2)}_{1n}                                  &              \\
t^{(3)}_{nn} & t_{nn1} \arrow[l, "\sum"']                    & t^{(3)}_{11} & t_{111} \arrow[rd, "\sum"] \arrow[l, "\sum"'] \arrow[u, "\sum"'] & \cdots       & t_{11n} \arrow[rd, "\sum"] \arrow[u, "\sum"'] &              \\
             &                                               & \ddots       & \vdots                                                           & t^{(1)}_{11} & \vdots                                        & t^{(1)}_{1n} \\
             &                                               & t^{(3)}_{1n} & t_{1n1} \arrow[rd, "\sum"] \arrow[l, "\sum"']                    & \cdots       & t_{1nn} \arrow[rd, "\sum"]                    &              \\
             &                                               &              &                                                                  & t^{(1)}_{n1} &                                               & t^{(1)}_{nn}
\end{tikzcd}
\end{center}
\indent One can generate an equivalence relation by intersecting all those, which contain a given set of the matrices. This can be seen as some kind of \emph{game}, where on starts with some matrices and then constructs all other possible ones with these $3$ "moves".


\begin{remark}
$3$-dimensional non-negative real matrices whose rows sum to three prescribed matrices on the sides have been investigated in combinatorics literature under the name "\emph{3-way axial transportation polytope}", which they form as a subset of $\mathbb{R}^{n\times n\times n}$. See for instance \cite{3way}.\end{remark}%Do we need this?


\begin{definition} Given a non-negative real matrix $M\in \mathbb{R}^{n^2}_{\geq 0}$, define the \emph{graph }$\Gamma(M)$\emph{ of }$M$ as the bipartite graph on $\{1, \cdots, n\}\sqcup \{1, \cdots, n\}$ with an edge between $i$ and $j$ iff $M_{ij}\neq 0$. One can also interpret this as a $(0,1)$-matrix.
\end{definition}
\begin{lemma}\label{2x2x2} Given $0<r_1<1$, setting $r_2=1-r_1$, and  a matrix $\begin{bmatrix}
r_1-a & a\\
a &r_2-a
\end{bmatrix}$ with $0\neq a \leq r_1,r_2$, $a\neq 1/2$, the equivalence relation on $yU_{r_1 r_2}$ generated by it are already all matrices in $S_{r_1r_2}$.
\end{lemma}
\begin{proof} WLOG $r_1\geq r_2$. All matrices in $S_{r_1r_2}$ are of the form as in the statement of the lemma (without the restrictions $a\neq 0,a\neq  1/2$). If we set $t^{(1)}_{ij}=t^{(2)}_{jk}=\begin{bmatrix}
r_1-a & a\\
a &r_2-a
\end{bmatrix}$ then the matrix $t_{ijk}$ has to be if the following form:
\[t_{i1k}=\begin{bmatrix}
r_1-a-b & b\\
b & a-b
\end{bmatrix} \quad t_{i2k}=\begin{bmatrix}
a-c & c\\
c & r_2-a-c
\end{bmatrix}\]
for $b\leq \min \{a, r_1-a \}$, $c\leq \min \{a,r_2-a\}$. Hence:
\[ t_{ik}^{(3)}=\begin{bmatrix}
r_1-b-c &b+ c\\
b+c & r_2-b-c
\end{bmatrix}
\]
Setting $a'=b+c$, these are precisely all the matrices such that $a'\leq \min\{2a, r_1, r_2, r_1+r_2-2a   \}=\min \{2a,r_2, 1-2a \}$. We will iteratively expand the set of  values $a$ such that the equivalence relation generated by them is $S_{r_1r_2}$.
Clearly this holds for all $a\in [\frac{r_2}{2},\frac{ r_1}{2}  ]$ (and $a\leq r_2$ we will always implicitly assume this condition in what follows).\newline
\indent For $n\geq 1$ and $a\in [\frac{r_2}{2^{n+1}},\frac{r_2}{2^n})\cup (\frac{1}{2}-\frac{r_2}{2^n}, \frac{1}{2}-\frac{r_2}{2^{n+1}}] $, choose $a'=\frac{r_2}{2^n}$. Thus for any starting point $a\in (0,\frac{1}{2})$, we can generate, after finitely many steps, some $a\in  [\frac{r_2}{2},\frac{ r_1}{2}  ]$ and hence everything.
\end{proof}
\begin{theorem}
The atoms of the topos $\Prob$ correspond to tuples $(M, \mu, H)$ where $(M,\mu)$ is a finite probability space and $H\leq Aut(M,\mu)$ a subgroup of its automorphism group.
\end{theorem}
\begin{proof}
Given an equivalence relation $R$ on $yU_{r_1\cdots r_n},$ we will conclude the proof via a sequence of reduction steps.\newline
\newline
\emph{Step 1.} If there exists a matrix $M\in R$ such that the associated $(0,1)$-matrix is not a permutation matrix then there exists a node $l\in \{1,\cdots,n\} \sqcup\{1,\cdots,n\}$in its graph with at least two neighbours, WLOG, by reordering, the nodes $1$ and $2$. By symmetry, we may assume $l$ lies in the first component. Setting, as in the description of transitivity as before, $t^{(1)}_{ij}=M$, $t^{(2)}_{jk}=M^\top$, we seek to find an appropriate $n\times n \times n$-matrix for some matrix $L$ in the following block diagonal form
\[ \begin{bmatrix}
    a_{11}      & a_{12} & 0&\dots & 0 \\
    a_{21}     & a_{22} &  0&\dots &0 \\
    0 & 0& r_3 &\dots & 0\\
    \vdots & \vdots & \vdots &  \ddots& \vdots\\
    0       & 0& 0 & \dots & r_n
\end{bmatrix} \]
such that $a_{ij}\neq 0$. One can achieve this by setting for $j\neq l$: $t_{ijk}=\begin{cases}  m_{ij} &\text{if }i=k \\ 0 & \text{else}  \end{cases}$ and $(t_{ilk})_{0\leq i,k\leq n}$ to be the following matrix for some $\min\{m_{1l},m_{2l}\}>\epsilon> 0$:
\[ \begin{bmatrix}
    m_{1l}-\epsilon  & \epsilon & 0&\dots & 0 \\
  \epsilon     &m_{2l}-\epsilon &  0&\dots &0 \\
    0 & 0& m_{3l} &\dots & 0\\
    \vdots & \vdots & \vdots &  \ddots& \vdots\\
    0       & 0& 0 & \dots & m_{nl}
\end{bmatrix} \]
$L$ is then defined to be the sum of these matrices.
\newline
\newline
\emph{Step 2.} Now we can generate the smallest equivalence relation containing $L$. We set $t_{ij}^{(1)}=t^{(2)}_{jk}=L$ and construct all 3-dimensional matrices $t_{ijk}$ with these faces. Clearly, for tuples $ijk$ such that at least one $i>2$, $j>2$ or $k>2$, we must have $t_{ijk}=\begin{cases} r_i &\text{if }i=j=k \\ 0 &\text{else}  \end{cases}$. Hence the problem reduces (up to scaling) to the statement of the previous lemma \ref{2x2x2}. It is applicable as non of the entries are zero and hence the $a$, in the notation of the lemma, is neither $0$ nor $\frac{1}{2}$. The smallest equivalence relation containing $L$ is thus the set of all matrices in the same block-diagonal form as $L$. This can easily be seen to be the equivalence relation $R_{1,2}$ associated the quotient map  $yU_{r_1\cdots r_n}\rightarrow yU_{(r_1+r_2),r_3\cdots r_n}$ sending $1, 2\mapsto 1$ and $j\mapsto j-1$ for $j> 2$.
\newline
\newline
\emph{Step 3.} Replace $R$ on $yU_{r_1\cdots r_n}$ by  the equivalence relation $\tilde{R}$ on $yU_{(r_1+r_2),r_3\cdots r_n}$ defined as what is left over after quotienting out $R_{1,2}$. Repeat these steps until the condition of step 1 is no longer fulfilled. This will terminate as $n$ is finite.\newline
\newline
\emph{Step 4.} The $(0,1)$-matrices of all matrices in $R$ are permutation matrices. The conditions on matrices in $S$ impose that these matrices are automorphisms of $U_{r_1\cdots r_n}$. It remains to prove that they form a subgroup of $S_n$. One can check that $\sigma^\top=\sigma^{-1}$ and the only matrix that can appear as $t^{(3)}_{ik}$ if we set $t^{(1)}_{ij}=\sigma$ and $t^{(2)}_{jk}=\tau$, is $\sigma \tau^{-1}$. It also contains the unit of $S_n$ by reflexivity. Hence it is a subgroup.
\newline
\newline
This concludes the proof as all atoms are quotients of equivalence relations and the relations. The representable functors appear as $(X,\mu, \{\id\})$.
\end{proof}

\begin{lemma} \label{atoms_are_sheaves} Given a finite probability space $(X,\mu)$ and a subgroup $H$ of its automorphism group, we compute the sheaf-theoretic quotient of the corresponding equivalence relation in $\Sh(\FinProb,J_{at})$ to be:
\[ \mathcal{F} :(N,\nu)\mapsto\text{\FinProb}((N,\nu), (X,\mu))/\sim  \]
where $f\sim g$ if there exists $\sigma\in H$ with $ \sigma\circ f=g$. These are partitions up to permutation by elements in $H$.
\end{lemma}
\begin{proof}
One calculates coequalizers in sheaf topoi by calculating the section-wise coequalizer and then sheafifying. The quotient the equivalence relation $R$ associated to $U$ is given by the coequalizer of the composition of the maps
% TODO: Maybe explain previously what they quotients of equivalence relations are
\begin{center}

\begin{tikzcd}
\bigsqcup_{\sigma \in H}\y(X,\mu) \arrow[r, hook] & {\y (X,\mu)\times \y (X,\mu)} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & {\y (X,\mu)}
\end{tikzcd}
\end{center}
Here the components on the left are included as permutation matrices. These compositions are coproducts of the Yoneda embeddings of $\id: (X,\mu)\rightarrow (X,\mu)$ resp. $\sigma: (X,\mu)\rightarrow (X,\mu)$. Thus the quotient presheaf is the sheaf described in the statement.

Sheafification is not needed in our case however as the presheaf given in the statement is a sheaf:  We seek to apply the criterion \ref{sheaf_condition_weak}. We need to check that the following is an equalizer diagram for any $f:(Z,\lambda)\rightarrow (Y,\nu)$:
\[
\begin{tikzcd} \mathcal{F} (Y,\nu) \arrow[r, "\mathcal{F}f"] & \mathcal{F} (Z,\lambda) \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \mathcal{F} (Z \times_f Z,\bar{\lambda})
\end{tikzcd} ,
\]

First notice that $\mathcal{F} f$ is injective and its image consists of precisely the $[s] \in \mathcal{F}(Z,\lambda)$ such that $s$ is constant on each fiber of $f$. We want to prove that these elements are precisely the ones with $\pi_1([s]) = \pi_2([s])$.

Since the diagram above is always a fork, we just need to to prove that the elements $[s] \in \mathcal{F}(Z,\lambda)$ such that for some $\sigma \in H$, $s \circ \pi_1 = \sigma \circ s \circ \pi_2$, are already constant on the fibers of $f$. Elementwise, our assumption on $s$ is that for all $x,y$ with $f(x) = f(y)$ we have that
\[
    s (x) = \sigma (s y) .
\]

Notice that this immediately implies that $s$ must be constant on the fibers of $f$.
\end{proof}

\begin{remark} The automorphism groups aren't all that complicated. Note that $\text{Aut}(X,\mu)\simeq \prod_{r\in (0,1)} S_{\{x\in X\mid \mu(x)=r \}}$.
\end{remark}

Now we are able to describe the category of atoms of $\Prob$ in a very combinatorial manner.

\begin{theorem} The category $\Prob_{at}$ is equivalent to the following category. \begin{enumerate}
\item Objects are given by tuples $(M,\mu, V)$ where $(M,\mu)$ is a finite probability space and $V$ is a subgroup of its automorphism group.
\item Morphisms $[f]:(M,\mu, V)\rightarrow (N,\nu, U)$ are given by equivalence classses of measure-preserving functions $f:(M,\mu)\rightarrow (N,\nu)$ such that for any $\sigma\in V$ there exists a $\psi\in U$ with $f\circ \sigma =\psi\circ f $; with $f\sim g$ if there exists $\sigma\in U$ with $f=\sigma\circ g$.
\end{enumerate}
\end{theorem}
\begin{proof}
%We use Theorem 6.7 of \cite{caramello_lafforgue}.
We can Yoneda embed $\Prob_{at}$ into $\Prob$.  By the Yoneda lemma, a morphism $\y (M,\mu)\rightarrow \y (N,\nu)/U$ corresponds to an element of $(\y (N,\nu)/U)(M,\mu)$. This has been computed to be maps $(M,\mu)\rightarrow (N,\nu)$ up to permutation by $\sigma\in U$. A morphism $\y (M,\mu)/V \rightarrow \y (N,\nu)/U$ is simply a morphism such that $\y (M,\mu)\rightarrow \y (N,\nu)/U$ factors over the quotient map $\y (M,\mu)\rightarrow \y (M,\mu)/V$. This means it is a morphism $f:(X,\mu)\rightarrow (Y,\nu)$ such that for any $\sigma\in V$ there exists a $\psi\in U$ such that $f\circ \sigma =\psi\circ f $. Hence the statement follows.
\end{proof}

\begin{remark} This shows, in particular that the atoms $\y (X,\mu)/U$, $\y (X,\mu)/V$ for different subgroups $U$ and $V$, which are not conjugated to each other, are non-isomorphic. % is this true?
\end{remark}

\begin{definition} Denote the category given above by $\Prob_{at}$ and call it the atomic completion of $\FinProb$ in accordance with notation in \cite{caramello_lafforgue}.
\end{definition}
This yields a new site presentation, which we will see is extremely easy to work with.
\begin{corollary} \label{coprod_representation}
    $\Prob\simeq \Sh(\Prob_{at},J_{at})$. More concretely, $\Prob$ is the $\infty$-positivisation of $\Prob_{at}$. % TODO: What is this even supposed to mean???
\end{corollary}



%TODO: Insert subsection on group-action perspective on all of this here.


\section{$\Prob$ as a set-theoretical universe}
The findings of the last chapter are so striking, that they allow us to reformulate our constructions, which heavily featured topos theory, in such a way as to not mention topoi in any way whatsoever. The notation introduced there already hints to this possibility. We hope that this makes our theory understandable to a far greater audience. So this chapter is concerned with outlining a translation into the language of set theory.
\begin{definition}[ZFA]  A model of Zermelo-Fraenkel set theory with atoms (or urelements) is a model of the single-sorted first order language with equality relation $=$, membership relation $\in$ and a constant $A$, the set of atoms, with the following axioms:
\begin{center}\begin{tabular}{ |p{3.5 cm}|p{7.5 cm}| }
\hline
Decidability&  $\forall x. (x\in A\vee \neg(x\in A))$  \\ % This seems to be obsolete in classical interpretations
\hline
\Set & $\forall y. (\exists x.x\in y\implies \neg (y\in A))$\\
\hline
Extensionality & $\forall x,y. \neg(x\in A)\wedge \neg(y\in A)\implies [ x=y\iff \forall z.(z\in x \iff z\in y) ] $\\
\hline
Pairing & $\forall x,y \exists z. (x\in z \wedge y\in z)$ \\
\hline
Separation & $\forall x \exists y. \neg (y\in A)  \wedge\exists z. (z\in y\iff z\in x \wedge \phi)$ for $x$ not free in $\phi$. \\
\hline
Union &$\forall x \exists y\forall z. (z\in y\iff \exists w\in x.z\in w)$ \\
\hline
Power-set &$\forall x\exists y \forall z. (z\in y\iff \forall w\in z.w\in x)$ \\
\hline
Infinity & $\exists x(\exists y.y\in x\wedge \forall y\in x.\exists w\in x.y\in w)$\\
\hline
$\in$-induction &$\forall x.(\forall y\in x. \phi(y)\implies \phi(x))\implies \forall x.\phi(x)$ \\
\hline
Collection & $\forall x (\forall y\in x\exists w.\phi\implies \exists z\forall y\in x \exists w\in z. \phi)$\\
\hline
\end{tabular}%what is phi?
\end{center}
\end{definition}
\begin{proposition}\label{ZFA} The internal language of a two-valued atomic topos is a classical model of ZFA.
\end{proposition}
\begin{proof}
This is essentially proved in \cite{set_theory}.
Let $A$ be the coproduct of all the atoms (i.e. one of each isomorphism class).
 Equality is equality but constructing a global membership relation from the datum of a topos is a bit less easy.\newline
\indent We can get bounded membership relations $\in_X\hookrightarrow X\times \Omega^X$ using the cartesian closed structure of our topos.\newline
\indent Now one uses an analogue of the cumulative hierarchy, starting with the set of atoms and then taking power objects and directed colimits just as one would in set-theory. The details can be found in \cite{set_theory}.
\end{proof}
\begin{remark} Models of ZFA like the one given by $\Prob$ are known as \emph{Fraenkel-Mostowski models} or \emph{permutation models}.
\end{remark}
%Maybe remark that this datum of a set theory is equivalent to that of a topos. Quote the paper corresponding to this fact
\begin{theorem}
In the combinatorial interpretation of our topos we have that $A$ is interpreted as \\\[\bigsqcup_{\substack{0<r_1\leq  \cdots\leq r_n \\ \sum_i r_i=1 \\ [V]\text{ conjugacy class of subgroup }V\subset Aut(U_{r_1\cdots r_n})}} yU_{r_1\cdots r_n}/V\]%it would be better to choose one subgroup per conjugacy class
 with element-hood relation and equality given as in \ref{ZFA}.
 \end{theorem}
 This puts the previous intuition that our topos consists of \emph{sets parametrized by partitions of unity (with subgroups of permutations)} on a firm footing.
\begin{remark}[Non-standard probability theory] We can also use language analogous to that used in the set theoretic constructions of non-standard analysis here \cite{XYZ} . One may call sets containing only elements of the form $yU_1$ \emph{standard sets} and these containing at least one different atom \emph{non-standard}. This works well as the following theorem shows. %Maybe also define "standard parts" of a set as the global sections i.e. the yU1 part. This preserves at least finite limits. Also one asign to an internal set its set of atoms i.e the left adjoint to the inclusion of standard sets. This doesn't preserve finite limits however.
\end{remark}
\begin{theorem} If there is any statement of higher order logic $\phi$ where all quantification is bounded over \emph{standard} sets then $\Prob\vDash \phi \iff \text{\Set}\vDash \phi$.
\end{theorem}
\begin{proof}
We essentially use that the topos $\Prob$ is atomic. This means, that the inverse image functor $\Delta: \text{\Set}\rightarrow \Prob$ of the global sections functor is logical. This means it preserves higher order logic \cite{XYZ}. Now we use the site $\Prob\simeq \Sh(\FinProb,J_{at})$. Given a set $A$, $\Delta(A)$ is the sheafification of the constant presheaf with values $A$ by \cite{XYZ}. This presheaf can be given as $\bigsqcup_{a\in A}yU_1$, which is already a sheaf as the site is subcanonical.
Hence an object in $\Prob$ is in its essential image iff it is a standard set.
\end{proof}
This means, dealing with standard sets is really cheap and easy. Quite the contrast to the monstrous descriptions of e.g. power sets of non-standard sets we have seen above. This has some immediate applications.
\begin{example} The natural numbers $\mathbb{N}$ of $\Prob$ are a standard set. In particular, all of arithmetic works just the same. %Is the same true for reals? I believe so.
\end{example}
\begin{proof}
The natural numbers object of a Grothendieck topos is always the constant sheaf with value $\mathbb{N}$. \cite{XYZ}.
\end{proof}
Given a probability interval $(\mathcal{B},\mu)$, we get an interpretation (is this the right word?) of $\Prob$ in $\text{\Set}$. %Do this properly with proper language
\begin{proposition}\label{choice_failture} The internal language of our topos proves the negation of countable choice.
\end{proposition}
\begin{proof} We construct a countable product of non-empty objects, which is empty. Take $yU_{1/n}$ to be the representable functors of the finite probability space with two elements and measure $1/n$ on one of them. Then the multi-limit of this family is empty as there is no finite probability space with a sequence of elements $x_n$ with measures $1/n$. We conclude $\prod_n yU_{1/n}=0$.
\end{proof}

This proof can, in fact be adapted in many situations, to suggest that most countable products of objects are empty. So there is really not much hope to extend the transfer principle to statements containing countably infinitely many variables or more.
\begin{remark} All this is not too exotic, so in practice one may just pretend to work formally in ZFA as one usually pretends to do so in ZFC. The only thing one has to be vary of is the failure of the axiom of choice. But as the proof of the last proposition suggests, the failure of the axiom of choice can be strictly controlled using fairly straight forward multi-product calculations.
\end{remark}


\section{Outlook for further research}

Sheaves and shit maybe? The Grothendieck construction and shit. I don't know how much of it we should mention. We could give the explicit site description and say we think it has all the nice properties. But the technical difficulties are too big and would take up too much time to give them in this paper etc.

Thinks that should go in here:
\begin{enumerate}
    \item $\mathfrak{Rand}$ and the Grothendieck construction. 'Random vectors spaces', 'random groups', etc. as vectors spaces, groups, etc. internal to $\mathfrak{Rand}$.
    \item Difficulties in looking at $L^0$, despite internal completeness. Discussion of the failture of the axiom of choice. Non-open stabilizers.
    \item Philosophically, argue for a solution using internal sheaves over the simple functions, cite Vickers(and maybe someone else) and his ideas in formal topology(this must be explained very well). He does geometric mathematics in 'A monad of valuation locales' and also uses simple functions as a proxy for $L^0$.
    \item Far future: One might expect our 'canonical' framework for probability theory to have much better formal properties than models by intervals in $\Set$. Thus, geometry might be better behaved when using the universal $L^0$ as a base for 'random field stuff'(cite the random fields book!)
    \item A sure bet: Repeat the logical analysis in this paper for many other atomic topoi. More conceptual proofs for algebraically closed fields and real closed fields? Quantifier elimination in infinitary logic as a weaker version of usual q-elim.
    \item The technique that we use for proving that the simple functions are all geometrically equivalent looks extremely easy to reproduce in other contexts. E.g. free modules over algebraically closed fields?
    \item Emulate ideas in this paper by considering $L^2$ equipped with the action of $Aut(I,\lambda)$ (Koopmann operator). "Can only ask questions about distributions", as one should.
\end{enumerate}


\begin{thebibliography}{9}
\bibitem{sheaves_geometry_logic}
Saunders Mac Lane, Ieke Moerdijk. \textit{Sheaves in Geometry and Logic} A First Introduction to Topos Theory.
\bibitem{elephant}
ELEPHANT
\bibitem{caramello_book}

\bibitem{fremlin}
FREMLIN
\bibitem{riehl}
Category theory in context
\bibitem{caramello_lafforgue}
Caramello, Olivia, and Laurent Lafforgue. "Some aspects of topological Galois theory." Journal of Geometry and Physics 142 (2019): 287-317.
\bibitem{caramello}
 Caramello, Olivia. "Topological Galois Theory". arXiv e-prints (2013):  1301.0300
\bibitem{set_theory}
Michael P. Fourman. "Sheaf models for set theory". Journal of Pure and Applied Algebra 19 (1980): 91 - 101
\bibitem{matrix}
Brualdi, R."Combinatorial Matrix Classes".Encyclopedia of Mathematics and its Applications. Cambridge  (2006): Cambridge University Press.
\bibitem{3way} Jess A. De Loera and Edward D. Kim and Shmuel Onn and Francisco Santos. "Graphs of transportation polytopes". Journal of Combinatorial Theory, Series A 116 8 (2009): 1306-1325
\end{thebibliography}




\end{document}

\documentclass[a4paper]{amsproc}
\renewcommand\labelenumi{(\roman{enumi})}
\renewcommand\theenumi\labelenumi
\title{\textbf{An Atomic Topos for Probability Theory}}

\usepackage{amssymb}
%\usepackage[hyphens]{url} \urlstyle{same}
\usepackage{tikz}
\usepackage{lscape}
\usepackage{mathtools}
\usetikzlibrary{cd}
%\usepackage[dvips]{graphicx} %% Package for inserting illustrations/figures

\theoremstyle{plain}
 \newtheorem{theorem}{Theorem}[section]
 \newtheorem{proposition}[theorem]{Proposition}
 \newtheorem{lemma}[theorem]{Lemma}
 \newtheorem{corollary}[theorem]{Corollary}
\theoremstyle{definition}
 \newtheorem{example}[theorem]{Example}
 \newtheorem{definition}[theorem]{Definition}
\theoremstyle{remark}
 \newtheorem{remark}[theorem]{Remark}
 \numberwithin{equation}{section}
 
\newcommand{\ldoub}{[\![ }
\newcommand{\rdoub}{]\!]}

\author{Adam Dauser, Adrian Marti}

\date{}
\begin{document}

\begin{center}
\begin{minipage}{\textwidth}
\begin{abstract}
Inspired by probability, we introduce topos $\mathfrak{Prob}$. %TODO do this but properly
\end{abstract}

\maketitle
\end{minipage}
\end{center}
\tableofcontents 
\section{Introduction}
Talk about 'bookkeeping' in probability theory. Nobody cares about the choice of base $\sigma$-algebra, as long as it has good properties. Yet, a $\sigma$-algebra must be chosen. Probability theorists always quantify over a good class of $\sigma$-algebras. The domain of a random variable never gets fixed on a particular $\sigma$-algebra. One may try to exploit this by imposing restrictions(of functorial or topological nature) on how statements/sets may depend on the base $\sigma$-algebra. These techniques will lead to an approach to probability theory that works without a choice of $\sigma$-algebra. Outline the standard set up.\newline
\indent First technical improvement: Divide out null sets! (Explain this in detail) Define measure algebras and show how they interact with $\sigma$-algebras. \newline
\indent Step 3:  Intervals model Lebesgue interval. Give the definitions.
\newline
%logics
\indent Talk about how this is a substantial application justifying the use of geometric/infinitary logic, since first order logic doesn't suffice. Talk about how one can't even define probability intervals in first order logics. Completeness, Quantifier elimination.\newline
\indent To do this we use the topos $\mathfrak{Prob}$. Shortly explain how models of the theory correspond to intervals and how other structure can be transported along that morphism. Here we give background to topos theory. Completeness comes from an 'open surjection' a map of topoi to Set that preserves and reflects this infinitary first order logics. Completeness legitimizes the belief that the underlying $\sigma$-algebra does not matter, to a certain extend(in the geometric logic sense). Explain enough to justify simple functions. I.e. the universal model. The simple functions are mapped to each other.
\begin{center}\textbf{ALWAYS EXPLAIN THE REASONING BEHIND ALL THE CONCEPTS WHICH APPEAR HERE}\end{center}
Also say that usual Galois theory a la SGA1 does not suffice to capture the group action flavour. The group is simple but profinite groups are completely determined by their closed normal subgroups (or smth. similar). State the main result (group of automorphisms ... commonly called measure preserving dynamical systems).\newline
\indent Combinatorial methods using 'multiproducts'. We give a nice calculus of our topos using its "atoms". This also yields a description by a model of ZFA. \newline
\indent Hype!!! $L^p$ spaces and other outlook. 

Somewhere in here we should definetly mention Olivia's bridges philosophy and how we give three very distinct site presentations (and the $\infty$-positivization) of $\mathfrak{Prob}$.


\section{Conventions} \label{conventions}

When there is need to be completely formal, the lim and colim operators in our sheaf toposes will not be defined only 'up to isomorphism', but rather taken the to be canonical constructions in sheaf toposes given by sheafifying the (co-)limit taken pointwise is $Set$. In case the sheaf topos is a presheaf topos, we will omit the sheafification step. The same will hold for Kan extensions, as in our examples these are always computed as (co-)limits. When considering what is traditionally thought of different 'representatives' of an isomorphism class given by a limit or colimit, we will formalize this as simply claiming that an object (together with a corresponding universal (co-)cone) \emph{has} a universal property.

This explicit approach clears up some of the confusion that arises when one thinks of e.g. a limit $\text{lim } c_i$ simply as some sort of object defined only up to isomorphism that takes the form of the correct representative of the isomorphism class when convenient. Admittedly, this explicit viewpoint will only be taken in the rare occasion where one needs to prove that certain diagrams involving isomorphisms given by universal properties commute.

For a small category $\mathcal{C}$, we will denote the Yoneda embedding by $y: \mathcal{C} \to Set^{\mathcal{C}^{op}}$. For a morphism $f$ in $\mathcal{C}$, we will denote $y(f)$(also known as postcomposition) by $f_*$.

We will call a diagram
\[
\begin{tikzcd}
\alpha \arrow[r, "f"] & \beta \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \gamma
\end{tikzcd}
\]
in a category $\mathcal{C}$ a fork if $fg = hg$.


\section{A combinatorial construction of $\mathfrak{Prob}$}

In this section we will introduce the topos $\mathfrak{Prob}$, by exhibiting a site based on the following category of finite probability spaces.

\begin{definition}
\begin{enumerate}
\item A finite probability space is a finite set $X$ equipped with a map(called probability measure) $\mu: X \to \mathbb{R}_{>0}$ such that \\ $\sum_{x \in X} \mu(x) = 1$.
\item For a finite probability space $(X,\mu)$ and a subset $a \subset X$, we define $\mu(a) := \sum_{x \in a} \mu(x)$.
\item A map of finite probability spaces $(X,\mu) \to (Y,\nu)$ is defined as a map of finite sets $f: X \to Y$ that is measure-preserving, i.e. $\mu(f^{-1}(y)) = \nu(y)$. Denote the category of finite probability spaces by $FinProb$.
\end{enumerate}
\end{definition}

Notice that all maps of finite probability spaces are surjective. Also notice that we do not allow elements of measure zero.

We want to consider the sheaf topos $Sh(FinProb, J_{at})$, where $J_{at}$ denotes the atomic topology. For this to be well-defined, we need to check $FinProb$ satisfies the right Ore condition.

\begin{theorem} \label{pullback_measure}
Given a diagram of finite probability spaces
\[
\begin{tikzcd}
                               & {(X_2,\mu_2)} \arrow[d, "g"] \\
{(X_1, \mu_1)} \arrow[r, "f"'] & {(Y,\mu)}                   
\end{tikzcd},
\]
the pullback of the finite sets carries a probability measure $\nu(x,y) := \frac{\mu_1(x) \mu_2(y)}{\mu(f x)}$ such that
\[
\begin{tikzcd}
{(X_1 \times_Y X_2, \nu)} \arrow[d, "p_1"'] \arrow[r, "p_2"] & {(X_2,\mu_2)} \arrow[d, "g"] \\
{(X_1, \mu_1)} \arrow[r, "f"']                               & {(Y,\mu)}                   
\end{tikzcd}
\]
is a diagram in $FinProb$.

In particular, $FinProb$ satisfies the right Ore condition.
\end{theorem}
\begin{proof}
The only thing to show is that the projections are measure-preserving, since that also implies that $\nu$ is actually a measure. So let $x \in X_1$ and $u := f(x)$.
\begin{align*}
\sum_{(x,y) \in p_1^{-1} x} \nu(x,y) &= \sum_{y \in g^{-1} u} \frac{\mu_1(x)\mu_2(y)}{\mu u} \\
&= \frac{\mu_1 x}{\mu u} \sum_{y \in g^{-1} u} \mu_2 y \\
&= \frac{\mu_2 x}{\mu u} \mu u \\
&= \mu_2 x
\end{align*}
\end{proof}

\begin{lemma}\label{subcanonical} All morphisms in $FinProb$ are regular epimorphisms. In particular $J_{at}$ is a subcanonical topology on $FinProb$.
\end{lemma}
\begin{proof}
We use our construction of the measure on the pullback in \ref{pullback_measure}. Given a morphism $f:(X,\mu)\rightarrow (Y, \nu)$, we have the following fork:
\[
\begin{tikzcd}[column sep=large]
(X \times_Y X, \bar{\mu}) \arrow[r, shift left=2] \arrow[r, shift right] & (X,\mu) \arrow[r, "f", two heads] & (Y,\nu)
\end{tikzcd}
\]
Since this is clearly a coequalizer on the underlying sets, the only thing to show is that the uniquely induced map is measure-preserving. This can either be directly computed or more concisely calculated by using \ref{finprob_equiv}.

The fact that this implies that $J_{at}$ on $FinProb$ is subcanonical is a standard fact, or it can alternatively also seen with \ref{sheaf_condition_weak}, which we will prove soon.
\end{proof}

Now we can introduce the topos that we wish to study in this paper.

\begin{definition}
Define the topos $\mathfrak{Prob}$ to be $Sh(FinProb, J_{at})$.
\end{definition}

Much of this paper is dedicated to finding other equivalent ways of describing $\mathfrak{Prob}$. When we wish to leave the particular description of $\mathfrak{Prob}$ vague, we will use the notation $\mathfrak{Prob}$.

\subsection{Finite Limits and a Calculus of Polytopes}

Our goal in the next section will be to understand the logic of $\mathfrak{Prob}$. Successfully doing so requires a very good understanding of what the flat functors on $FinProb$ are and thus also requires a good understanding of finite limits in $\mathfrak{Prob}$. This will be our goal in this subsection.

But the situation is not as simple as one may hope: these finite limits only very rarely exist. But naturally, in the topos $\mathfrak{Prob}$, these finite limits do actually exist, and we will see that luckily these have a straightforward form. This will give rise to a weakened form of the notion of a limit which we will call multilimit. It will be essential in all our discussions about logic.

The most surprising thing about multilimits will be their nontrivial combinatorial content and their connection to polytopes. We will see that an overwhelming amount of statements in this paper(beyond statements about flat functors) are proved by using computations with multilimits and polytopes. One could say that this subsection gives us a first look at the computational meat of $\mathfrak{Prob}$.

There is some very convenient notation for finite probability spaces emphasizing their combinatorial nature, where we see that phenomena involving polytopes are starting to arise.

\begin{definition}[U-notation] \label{U-notation}
\begin{enumerate}
\item For $r_1, \cdots r_n \in [0,1]$ such that $r_1 + \cdots + r_n = 1$, denote by $U_{r_1 \cdots r_n}$ or simply by $U_{r_i}$ the finite probability space on the set 
\[
\{i | r_i \neq 0 \}
\]
equipped with the measure $\mu(i) = r_i$.
\item We will use the shorthand $U_r := U_{r,r-1}$ for $r \in [0,1]$.
\end{enumerate}
\end{definition}

This is notation for finite probability spaces in the sense that the $U_{r_i}$ form a skeleton of $FinProb$.

\begin{remark}
    Notice that for a finite probability space $(X,\mu)$, $Hom((X,\mu), U_{r_i})$ precisely consists of partitions $(a_i)$ of the set $X$ with $\mu(a_i) = r_i$. This may seem like quite a harmless observation, but being aware of this fact makes some calculations with $y U_{r_i}$ much more intuitive. Moreover, we will later see that the $U_{r_i}$ in fact precisely correspond to logical formulas specifying a partition with fixed measures. We will often identify maps with partitions implicitly and without comment.

    In particular, $Hom((X,\mu), U_r)$ is identified with partitions consisting of two elements. Of course, we could have equivalently simply chosen any subset of $X$ of measure $r$. We will similarly identify $Hom((X,\mu), U_r)$ with subsets of $X$ of measure $r$.

\end{remark}

We now compute the finite limits of representables in $\mathfrak{Prob}$.

\begin{proposition} \label{multiproduct}
    Let $U_{r_1, \cdots r_n}$ and $U_{s_1, \cdots s_m}$ be finite probability spaces. For each finite probability space $U_{t_{ij}}$ ($0 < i \leq n$, $0 < j \leq m$) with
    \[
        \sum_j t_{ij} = r_i
    \]
    and
    \[
        \sum_i t_{ij} = s_j ,
    \]
    we define projections $p_1: U_{t_{ij}} \to U_{r_i}$, $(x_{ij}) \mapsto (\bigvee_j x_{ij})$ and $p_2: U_{t_{ij}} \to U_{s_i}$, $(x_{ij}) \mapsto (\bigvee_i x_{ij})$.

    These projection maps induce the isomorphism
    \[
    y U_{r_i} \times y U_{s_j} \cong \coprod_{t_{ij}} y U_{t_{ij}} ,
    \]
    where the indexing $t_{ij}$ range over the ones with the fixed sums specified above.
\end{proposition}
\begin{proof}
    The $t_{ij}$ where precisely chosen such that the projections are measure preserving. To show
    \[
    y U_{r_i} \times y U_{s_j} \cong \coprod_{t_{ij}} y U_{t_{ij}} ,
    \]
    send a pair of partitions $((a_i),(b_j))$ to the family $(a_i \wedge b_j)_{ij}$. The inverse of this map is given by joining the family with the projection maps described above.
\end{proof}
    
Notice that the isomorphism we proved is not quite a universal property in the traditional sense. Normally, we would have required $y U_{r_i} \times y U_{s_j}$ to actually be representable in order to be able to say that we have a products in $FinProb$. But this does not work in our case, as it only is a coproduct of representables.

We give a name to this weaker notion of a limit.

\begin{definition}
    Given a small category $\mathcal{C}$ and a diagram $D: J \to C$, we will call a family of cones\footnote{We think of cones over $D$ as natural transformations $c \Rightarrow D$ from a constant diagram $c$ to the diagram $D$.} $(d_i \Rightarrow D)_i$ over $D$ a \emph{multi-limit} of $D$ the cones induce an isomorphism
    \[
        lim_{j \in J} D(j) \cong \coprod_i d_i .
    \]
    Moreover, we will use the terminology \emph{multi-product}, \emph{multi-equalizer} and \emph{multi-pullback}.
\end{definition}

Alternatively, we could have presented the universal property in a more traditional style by saying that cones over our diagram factor through one of the $U_{t_{ij}}$ uniquely. In fact, this is what is done in \cite{caramello_lafforgue} (Lemma 6.11.). Caramello and Lafforgue use multi-products in order to study the atoms of an atomic topos, which is also one of the things we will use them for.

For completeness sake, we remark that not only binary multi-products do exist in $FinProb$, but in fact all finite multi-products do exist. Indeed, $FinProb$ has a terminal object.

Finally, we also have multi-equalizers.

\begin{proposition}
    Given the diagram \begin{tikzcd}[column sep=small]
        \alpha \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \beta
        \end{tikzcd} in $FinProb$ we have
    \[
        eq(\begin{tikzcd}[column sep=small]
        y \alpha \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & y \beta
        \end{tikzcd}) \cong y \alpha \text{ if } f = g \text{ and } \emptyset \text{ otherwise.}
    \]
\end{proposition}
\begin{proof}
    The interesting case is when $f \neq g$. In that case we compute the equalizer poinitwise on a finite probability space $\gamma$:
    \[
        eq(\begin{tikzcd}[column sep=small]
        y \alpha \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & y \beta
        \end{tikzcd})(\gamma) \cong \{ h: \gamma \twoheadrightarrow \alpha | fh = gh \} \cong \emptyset .
    \]
\end{proof}

In practise we noticed that we needed to work a lot with big coproducts with complicated index sets, like one has to do with multi-products. Thus, we introduce a simplified notation for objects of this kind.


\begin{definition}
    \begin{enumerate}
        \item $P^1_n := \{ (r_i) \in \mathbb{R}^n | \sum_{i=1}^n r_i = 1 \}$
        \item $P^2_{r_i,s_i} := \{ (t_{ij}) \in \mathbb{R}^{n \times m} | \sum_{i=1}^n t_{ij} = s_j, \sum_{j=1}^m t_{ij} = r_i, t_{ij} \geq 0 \}$
        \item $P^2_{n,m} := \{ (t_{ij}) \in \mathbb{R}^{n \times m} | \sum_{i,j = 1}^{n,m} t_{ij} = 1 , t_{ij} \geq 0 \}$
    \end{enumerate}
\end{definition}

\begin{remark} Given $r_i$, $s_j$, the elements of the multiproduct $t_{ij}$ can be interpreted as a $n\times m$-matrix with coefficients in $\mathbb{R}_{\geq 0}$. Actually, non-negative real matrices satisfying
\[
\sum_j t_{ij} = r_i \quad \sum_i t_{ij} = s_j .
\]
are in one-to-one correspondence with elements of the multiproduct. These matrices form a polytope inside $\mathbb{R}^{n\times m}$ called \emph{transportation polytope}. Any element of a polytope is a convex sum of its extreme points. These and much more about this polytope are explored in Chapter 8 of [Matrix book]. \newline
\indent $yU_{r_i}\times_{yU_{s_i}}yU_{r'_i}$ corresponds to the subset of matrices in the block diagonal from with non-zero entries at $(i,j)$ only if $g(i)=f(j)$.
\end{remark}

Using this site for substantial applications will result in having to write coproducts whose index will be many lines long. This is very inconvenient to write down and moreover we don't find it very transparent when it comes to understanding what is going on. Thus, we give a more convenient notation for coproducts.

\begin{definition}
    \begin{enumerate}
        \item Let $\mathcal{A}$ denote the set 
        \[
            \{(r_1, \cdots, r_n, H) | n \in \mathbb{N}, r_i \in \mathbb{R}_{\geq 0}, \sum r_i = 1, H \leq Aut(U_{r_i})\}.
        \]
        \item For any $x \in \mathcal{A}$ with $x = (r_i, H)$, denote by $A_x \in \mathfrak{Prob}$ the atom corresponding to the finite probability space $U_{r_i}$ divided by the group of permutations $H$.
        \item Let $\mathcal{A}^{re}$ denote the set
        \[
            \{(r_1,\cdots, r_n) | n \in \mathbb{N}, r_i \in \mathbb{R}_{\geq 0}, \sum r_i = 1\}.
        \]
        \item Let $S$ be a subset of $\mathcal{A}$ and let for for each $x \in S$, $T(x)$ be any set. Then we can introduce the following notation:
        \[
            \langle T(x) | x \in S \rangle := \coprod_{\substack{x \in S \\ y \in T(x)}} A_x .
        \]
        We will call a sheaf written in this notation a \emph{set of atoms}.
        \item We define an \emph{element} of a set of atoms $\langle T(x) | x \in S \rangle$ to be a tuple $(x,t) \in \coprod_{x \in S} T(x)$.
    \end{enumerate}
\end{definition}

This notation is the payoff of the efforts that had been directed towards a combinatorial understanding of $\mathfrak{Prob}_{at}$. One should be aware that the coproduct that results in this notation will contain many atoms twice, simply because we are considering \emph{ordered} families $r_i$ and the space $U_{r_i}$ does not depend on the order. This means that we can only think of $\mathcal{A}$ and $\mathcal{A}^{re}$ as sets that we can use to index our atoms, but not as the actual objects in the category of atoms.

The crucial thing about this notation, is that \ref{coprod_representation} gurantees that every sheaf can be written this way. Moreover, when the subsets of $\mathcal{A}$ are even subsets of $\mathcal{A}^{re}$, we will be able to precisely describe the sheaves that are coproducts of sheaves representable over the site $(FinProb, J_{at})$. In this case, we omit writing down trivial subgroups everywhere in our notation.

We give some examples as how to it makes things easier. 

\begin{example}
    \begin{enumerate}
        \item The binary multiproducts we have dealt with so often, can now be written as:
        \[ y U_{r_i} \times y U_{s_j} \cong \langle 1 | t_{ij} \in P^2_{r_i,s_j} \rangle, \] % TODO: Define the P stuff earlier.
        where $1$ denotes the one-object set
        \item We can also express the universal model $U$ in the following way:
        \[ U \cong \langle 1 | (r_1,r_2) \in P^1_2 \rangle. \]

        % TODO: Add n-ary multiproducts.
    \end{enumerate}
\end{example}

The previous examples may be too easy to fully make use of the notation. In chapter \ref{simple_functions} we will see be a more interesting application when we look at simple functions.

One of the most intriguing things about this notation, is that it almost feels like it gives semantics to an abstract notion of \emph{sets parameterized by a partition of unity}, defined in the formal sense above. The convenient thing, is that when writing down sheaves in this way, one does not need to check functoriality nor sheaf conditions. Of course, this is does not mean that our topos is equivalent to $Set^{\mathcal{A}}$, because while the objects match, the morphisms are different:

\begin{proposition}\label{atom_coprod_maps}
    Let $\mathcal{F} = \langle T(x) | x \in S \rangle$ and $\mathcal{G} = \langle T'(x) | x \in S' \rangle $. Then the maps $\mathcal{F} \to \mathcal{G}$ are precisely maps $(g, (f_x))$, where $g$ is a map between the sets of elements
    \[
        \coprod_{x \in S} T(x) \to \coprod_{x \in S'} T'(x)
    \]
    and for each element $(x,t) \in \coprod_{x \in S} T(x)$ with $(x',t') = g(x,t)$, $f_{x,t}$ is a morphism
    \[
        A_x \xrightarrow{f_{x,t}} A_{x'} .
    \]
\end{proposition}
\begin{proof}
    Use the universal property of the coproduct of atoms and then use that each map needs to factor through one of the images because the image of an atom needs to be an atom again.
\end{proof}

One of the most convenient things about sets of atoms, is that it is easy to send them through (the inverse image functor of) a geometric morphisms, since geometric morphisms preserve coproducts. In fact, we found that the only practical way to compute geometric morphisms on a sheaf, is by decomposing the sheaf into atoms. % Adjust this. Say that this theme will be very noticeable throughout the paper.

\subsection{Sheaf Conditions}

Before continuing, we will derive a better criterion for determining whether a presheaf on $FinProb$ is a sheaf.

Here we give our first application of our calculus of polytopes. We use it to give a straightforward criterion for when a preasheaf over $FinProb$ is actually a sheaf. This sounds very useful, but the sheaves we use in practise, are usually coproducts of representables and are thus automatically sheaves. In fact, we only use the results of this subsection when we later compute the set of atoms of $\mathfrak{Prob}$ and we show that the new atoms we found are in fact sheaves (see \ref{atoms_are_sheaves}). This means that the uninterested reader can safely skip this subsection.

% TODO: HEAVILY SIMPLIFY THIS
\begin{lemma} \label{multipullback}
    For a diagram
    \[
    \begin{tikzcd}
    & U_{r_i} \arrow[d, "g"] \\
    U_{r'_i} \arrow[r, "f"'] & U_{s_i} ,
    \end{tikzcd}
    \]
    we consider the finite probability spaces $U_{t_{ij}}$ with the projections $p_1: U_{t_{ij}} \to U_{r_i}$, $(x_{ij}) \mapsto (\bigvee_j x_{ij})$ and $p_2: U_{t_{ij}} \to U_{r'_i}$, $(x_{ij}) \mapsto (\bigvee_i x_{ij})$, where the $t_{ij} \geq 0$ are indexed by pairs $(i, j)$ with $f(i) = g(j)$ such that for each $i$,
    \[
    \sum_j t_{ij} = r_i
    \]
    and for each $j$
    \[
    \sum_i t_{ij} = r'_j .
    \]
    These cones have the universal property
    \[
    y U_{r_i} \times_f y U_{s_j} \cong \coprod_{t_{ij}} y U_{t_{ij}} .
    \]
\end{lemma}
\begin{proof}
r
\end{proof}

We can use this lemma in order to simplify the following sheaf condition for sheaves over categories equipped with the atomic topology found in \cite{sheaves_geometry_logic}, III.4 Lemma 2:

A presheaf $\mathcal{F}$ on a $FinProb$ is a sheaf over the atomic topology if and only if one can check that for any morphism $f: \alpha \to \beta$ and any $a \in \mathcal{F}(\alpha)$: If for all diagrams

\[
\begin{tikzcd}
\gamma \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & \alpha \arrow[r, "f"] & \beta
\end{tikzcd}
\]
with $f g = f h$ we have that $\mathcal{F}(g)(a) = \mathcal{F}(h)(a)$, then there is a unique lift $b \in \mathcal{F}(\beta)$ with the property that $\mathcal{F}(f)(b) = a$.

\begin{proposition} \label{sheaf_condition}
A presheaf $\mathcal{F}$ on $FinProb$ is a sheaf over the atomic topology if and only if for all maps of finite probability spaces $f: U_{r_i} \to U_{s_i}$ the fork
\[
\begin{tikzcd}
\mathcal{F} U_{s_i} \arrow[r, "\mathcal{F}f"] & 
\mathcal{F} U_{r_i} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \prod_{t_{ij}} \mathcal{F} U_{t_{ij}}
\end{tikzcd}
\]
is an equalizer diagram, where the $t_{ij}$ are as in \ref{multipullback} and the projection $\pi_1$ and $\pi_2$ are induced by the universal 'projection maps' defined in \ref{multipullback}.
\end{proposition}
\begin{proof}
Since for each $U_{t_{ij}}$ we have the commuting square
\[
\begin{tikzcd}
U_{t_{ij}} \arrow[r] \arrow[d] & {U_{r_i}} \arrow[d, "f"] \\
{U_{r_i}} \arrow[r, "f"']            & {U_{s_i}} ,
\end{tikzcd}
\]
$f$ certainly gives us a diagram
\[
\begin{tikzcd}
\mathcal{F} U_{s_i} \arrow[r, "\mathcal{F}f"] & \mathcal{F} U_{r_i} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \prod_{t_{ij}} \mathcal{F} U_{t_{ij}}
\end{tikzcd}
\]
with $\pi_1 \mathcal{F}(f) = \pi_2 \mathcal{F}(f)$. Claiming that this is an equalizer means saying that for every $a \in \mathcal{F}U_{r_i}$ with the property that for all the projections $p_1: U_{t_{ij}} \to U_{r_i}$, $p_2: U_{t_{ij}} \to U_{r'_i}$ the equation $\mathcal{F}(p_1)(a) = \mathcal{F}(p_2)(a)$ is satisfied, implies that there is a unique lift $b \in \mathcal{F}U_{s_i}$ of $a$.

So our claim is that the criterion described above needs only be checked on the $U_{t_{ij}}$. Thus we assume that the equation above holds for the $U_{t_{ij}}$ with their projection maps. We need to show that the equation $\mathcal{F}(g)(a) = \mathcal{F}(h)(a)$ already holds for all the \[
\begin{tikzcd}
\gamma \arrow[r, "g", shift left] \arrow[r, "h"', shift right] & U_{r_i}
\end{tikzcd}
\]
with $fg = fh$. But this certainly holds, since we can factor $g$ and $h$ through one of the $U_{t_{ij}}$ by \ref{multipullback}.
\end{proof}

Note that this proposition actually had little to do with finite probability spaces and is really about a sheaf condition for atomic topologies where the base category has multipullbacks.

In some cases, one can prove the following condition that is much stronger than being a sheaf. It is especially useful when the sheaf doesn't really use the measure in its definition.

\begin{proposition} \label{sheaf_condition_weak}
Let $\mathcal{F}$ be a presheaf on $FinProb$. If for all morphisms $f: (X,\mu) \to (Y,\nu)$ the fork
\[
\begin{tikzcd} \mathcal{F} (Y,\nu) \arrow[r, "\mathcal{F}f"] & \mathcal{F} (X,\mu) \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \mathcal{F} (X \times_f X,\bar{\mu})
\end{tikzcd}
\]
is an equalizer, where $\bar{\mu}$ is as in \ref{pullback_measure}, then $\mathcal{F}$ is a sheaf.
\end{proposition}
\begin{proof}
This is the condition from \cite{sheaves_geometry_logic} described above, but weakened by choosing $\gamma = (X \times_f X,\bar{\mu})$.
\end{proof}

\section{$\mathfrak{Prob}$ as a classifying topos}

In this section we will determine what $Sh(FinProb, J_{at})$ classifies. By default, we will use the notations and definitions as in part D.1 of \cite{elephant}. We warn the reader that this section contains big amounts of technical property-checking, so the uninterested reader can read the next definition and then skip to \ref{theory_of_intevals}. If the reader still wants an intuition about why \ref{classifying} should be true, we have provided an independent proof of a weaker theorem in the appendix. There prove our result only for the models of $Sh(FinProb, J_{at})$ in $Set$ in a way that should be accessible to a reader only familiar with $Ind$-completions and flat functors into $Set$. There we do not use any formal logic.

\begin{definition}
Define the geometric theory $\mathbb{T}_{bpalg}$ of boolean probability algebras to have one sort $B$, constants and function symbols
\begin{center}
$1: B$ \\
$0: B$ \\
$\wedge: B \times B \to B$ \\
$\vee: B \times B \to B$ \\
$\neg: B \to B$
\end{center}
and a unary relation symbol $B_r$ on $B$ for each $r \in [0,1]$. We impose the following axioms($a$, $b$ and $c$ denote free variables in $B$):
\begin{itemize}
\item \textit{Boolean algebra}.
\begin{align*}
\top &\vdash a \wedge (b \wedge c) = (a \wedge b) \wedge c && \text{associativity} \\
\top &\vdash a \vee (b \vee c) = (a \vee b) \vee c && \text{associativity} \\
\top &\vdash a \wedge 1 = a && \text{identity} \\
\top &\vdash a \vee 0 = a && \text{identity}\\
\top &\vdash a \wedge \neg{a} = 0 && \text{inverse}\\
\top &\vdash a \vee \neg{a} = 1 && \text{inverse}\\
\top &\vdash a \wedge (a \vee b) = a && \text{absorbtion}\\
\top &\vdash a \vee (a \wedge b) = a && \text{absorbtion}\\
\top &\vdash a \wedge (b \vee c) = (a \wedge b) \vee (a \wedge c) && \text{distributivity} \\
\top &\vdash a \vee (b \wedge c) = (a \vee b) \wedge (a \vee c) && \text{distributivity}
\end{align*}
\item \textit{$B_r$ form a partition}. For all $r, s \in [0,1]$ with $r \neq s$ we have an axiom
\[
B_r(a)  \wedge B_s(a) \vdash \bot
\]
and we also have an axiom
\[
\top \vdash \bigvee_{r \in [0,1]} B_r(a).
\]
\item \textit{Probability measure}. For all $r, s \in [0,1]$, we further require
\[
(a \wedge b = 0) \wedge B_r(a) \wedge B_s(a) \vdash B_{r+s}(a \vee b) 
\]
and finally we need
\begin{align*}
\top & \vdash B_1(1) \\
B_0(a) & \vdash a = 0.
\end{align*}
\end{itemize}
\end{definition}

Essentially, we have encoded a boolean probability algebra geometrically by partitioning the base sort $B$ into the elements $B_r$ of measure $r \in [0,1]$. If one were to write down the categorical interpretation of the two partition axioms, one would see that they are just saying that $B$ is a coproduct of the $B_r$.

Let us get some more notation out of the way.

\begin{definition}
Denote the category models of $\mathbb{T}_{bpalg}$ in $Set$ by $BPAlg$.
\end{definition}

\begin{remark}
    Note that we have an equivalence of categories 
    \[
        FinProb^{op} \simeq BPAlg_f
    \]
    between the opposite category of finite probability spaces and the category of finite boolean probability algebras. We don't prove this in detail nor do we give the equivalence explicitly, since we won't use this fact anywhere in this paper.

\end{remark}


We would like to show that the topos $Set^{FinProb^{op}}$ classifies $\mathbb{T}_{bpalg}$. Proving this fact requires a bit of work. The difficulty is mainly the fact that  $FinProb$ does not have all finite limits, so the flat functors on $FinProb$ are not as straightforward to understand. We will prove the equivalence
\[
Set[\mathbb{T}_{bpalg}] \simeq Set^{FinProb^{op}}
\]
by purely syntactical means. The functor in one direction will be given by an appropriate model of $\mathbb{T}_{bpalg}$ in $Set^{FinProb^{op}}$. The challenge lies in proving that this gives an equivalence. We will show this by interpreting the topos on the left hand side as the classifying topos of the theory of flat functors on $FinProb$ and using this fact we will give an inverse functor. Working purely syntactically is essential to being able to comfortably write down a formal argument. That means that we will need to extensively work with geometric logic.

To get an idea of what the universal model might be, one can for example look at the universal models in classifying toposes of cartesian theories $\mathbb{T}$. In those cases the universal model in $[\mathbb{T} \text{-} Mod(Set)_{f.p.}, Set]$ just corresponds to the forgetful functor sending a (finitely presented) $\mathbb{T}$-model to its underlying set. Of course, the forgetful functor comes equipped with the required $\mathbb{T}$-model structure. For more details, see D3.1.2 of \cite{elephant}.

The above gives us some inspiration as to how to guess the universal model. We want it to be the functor in $Set^{BPAlg_f}$ that gives us the underlying set of the boolean algebra in question. On the equivalent topos $Set^{FinProb^{op}}$, this happens to be the powerset functor on the underlying set of the finite probability space in question. We can give an alternative description. First, we introduce the shorthand $U_r := U_{r,r-1}$ for $r \in (0,1)$. We will think of the functor $y U_r$ as the functor sending a finite probability space to the set of subsets of measure $r$. Similarly, we will think of the functor $y U_{r_i}$ as the functor sending a finite probability space $(X,\mu)$ to the set its partitions $(a_i)$ with $\mu(a_i) = r_i$. Then we can define $U$ to be
\[
\coprod_{r \in [0,1]} y U_r \in Set^{FinProb^{op}} .
\]
One immediately sees that $U$ is just the powerset functor on the underlying set of a given probability space. This means that map $f$ between probability spaces gets sent to the map that takes the preimage of a subset. We will see that the $U_r$ can be interpreted as the unary relations of the theory $\mathbb{T}_{bpalg}$.

We use this universal model in order to define the functor for our equivalence of topoi.

\begin{lemma} \label{universal model}
$U$ is a model of the $\mathbb{T}_{bpalg}$. The sort $B$ is given by $U$. The relation symbols $B_r$ are given by $y U_r$ and the boolean algebra operations given by the fact that at every $(X,\mu) \in FinProb$, $U(X, \mu)$ is the powerset of $X$.

This yields a left-exact, colimit-preserving functor $Lan_y(U): Set^{FinProb^{op}} \leftarrow Set[\mathbb{T}_{bpalg}]$.
\end{lemma}
\begin{proof}
The last statement follows from the first part by using the universal property of classifying topoi.

We begin with some well-definedness remarks. The operations $\wedge, \vee$ and $\neg$ on $U$ can be defined pointwise by using the boolean algebra structure of powersets. Since the maps of finite probability spaces induce boolean algebra homomorphisms between the powersets, and these automatically preserve $\wedge, \vee \text{ and } \neg$, we get naturality of the operations. Similarly, the inclusions $y U_r \to U$ are natural since morphisms in $FinProb$ preserve measure.

Since we are looking at presheaves, all the colimit and limit conditions from the axioms can be checked pointwise, where they are trivial. More formally, we can use \cite{elephant}, Corollary D.1.2.14, to get the fact that $U$ is a $\mathbb{T}_{bpalg}$-model in $Set^{BPAlg_f}$.
\end{proof}

We diverge from the notation in D.1 of \cite{elephant} in that we will sometimes annotate a formulas with a set of variables containing all the variables used in the formula, as seen below. This is done so that when these formulas get combined with logical connectives, the big formula remains easy to read.

Since the theory of flat functors we will apply this lemma to has no relation symbols, we restrict ourselves to the case where $\Sigma$ has no relation symbols

We will identify the objects and arrows in $FinProb$ with the corresponding sorts and function symbols in $\mathbb{T}^{FinProb}$.

\begin{lemma} \label{inverse}
We have a $\mathbb{T}^{FinProb}$-model in $\mathcal{C}^{\mathbb{T}_{bpalg}}$ given as follows. Let $f: (X,\mu) \to (Y, \nu)$ be an arrow in $FinProb$. We specify a model $F$ on the sort given by $(X,\mu)$ and on the function symbol given by $f$ by:
\begin{align*}
\{\vec{a} . \phi_{X,\mu}^{\vec{a}}\} &:= \Bigg \{ \vec{a} . \bigwedge_{i \in X} B_{\mu(i)} a_i \wedge \bigwedge_{\substack{i,j \in X \\ i \neq j}} (a_i \wedge a_j = 0) \Bigg \} \\
[\theta_f^{\vec{a}, \vec{b}}] &:= \Bigg [ \bigwedge_{j \in Y} (b_j = \bigvee_{f i = j} a_i) \wedge \phi_{X,\mu}^{\vec{a}} \Bigg] ,
\end{align*}
so now we can give $F((X,\mu))$ by $\{\vec{a} . \phi_{X,\mu}^{\vec{a}}\}$ and $F(f)$ by $[\theta_f^{\vec{a}, \vec{b}}]$.

This yields a left-exact, colimit-preserving functor $Lan_F: Set^{FinProb^{op}} \to Set[\mathbb{T}_{bpalg}]$.
\end{lemma}

The model $M$ has a straightforward intuitive meaning: The sorts can be interpreted as partitions of a boolean algebra into elements of prescribed measure. The function symbols compute unions of the partitions in prescribed ways.

\begin{proof}
TODO: THIS PROOF SHOULD BE DONE ENTIRELY WITHOUT INTERPRETATIONS BY INSTEAD USING MULTIPRODUCTS
% Concretly, I want to use that by Makkai's 'Accessible categories', 1.2.2 v) iff iv), it suffices to check that F preserves finite limits of representables. Thus we only need to check lim F x_i can be computed as the coproduct of the multiproduct.

\end{proof}

\begin{theorem}[Classifying topos of $\mathbb{T}_{bpalg}$] \label{classifying_presheaf}
$Lan_y(U)$ and $Lan_F$ define an equivalence of categories
\[
Set^{FinProb^{op}} \simeq Set[\mathbb{T}_{bpalg}].
\]
\end{theorem}

We warn the reader that the necessary ideas defining the equivalence have already been introduced, and that this proof consists of highly technical and uninsightful property-checking.

\begin{proof}
For this proof, let $\mathbb{T} := \mathbb{T}_{bpalg}$.

We check that the functors we defined are inverses to each other.

We first check that $Lan_y(U) \circ Lan_F \cong Id$. Since these functors preserve colimits, we check only need to check this on representables. So let $(X,\mu) \in FinProb$. Then we get natural isomorphisms

\begin{align*}
Lan_y(U)(Lan_F(y(X,\mu))) &\cong Lan_y(U)(yF(X,\mu)) \\
&\cong UF(X,\mu) \\
&\cong U \{\vec{a} . \phi^{\vec{a}}_{X,\mu}\} \\
&\cong \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U .
\end{align*}

It remains to show that we have a natural isomorphim $y (X,\mu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$. First, we compute this functor on objects. Since the corresponding limits are computed pointwise, we first get a natural (in $(X,\mu)$) isomorphism
\[
\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U (Y,\nu) \cong \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(Y,\nu)} .
\]
But computing these pullbacks and equalizers in $Set$ yields
\begin{align*}
\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(Y,\nu)} \cong
\{\{V_x\} \subset Y | (\nu(V_x) = \mu(x)) \wedge (V_x \cap V_y = \emptyset) \text{ for } x,y \in X, x \neq y\} .
\end{align*}

Now we can use this together with the Yoneda lemma in order to give the required isomorphism $y (X,\nu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$ by the element $\{x\}_{x \in X} \in \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(X,\mu)}$. In order to show this actually is an isomorphism, we explicitly compute this isomorphism on an $f \in y (X,\mu) (Y,\nu)$. In order to do that, we note that the functor $\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$ is a subfunctor of $\prod_{x \in X} U$, so that lets us see that the map
\[
\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U(X,\mu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U(Y,\nu)
\]
sends $\{x\}_{x \in X}$ to $\{f^{-1} x\}_{x \in X}$. This means that the morphism
\[
y (X,\mu) (Y,\nu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U(Y,\nu)
\]
sends an $f$ to the family $\{f^{-1} x\}$. This clearly is an isomorphism, so $y (X,\nu) \to \ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_U$ is an isomorphism.

We still need to show this isomorphism is natural in $(X,\mu)$. We prove naturality on each $(Y,\nu) \in FinProb$. So let $(X,\mu), (X',\mu') \in FinProb$. The diagram
\[
\begin{tikzcd}
    {Hom((Y,\nu),(X,\mu))} \arrow[r, "\cong"] \arrow[d, "f_*"'] & {\ldoub \vec{a} . \phi^{\vec{a}}_{X,\mu} \rdoub_{U(Y,\nu)}} \arrow[d, "{\ldoub \vec{a},\vec{b} . \theta_f \rdoub}"] \\
    {Hom((Y,\nu),(X',\mu'))} \arrow[r, "\cong"]                 & {\ldoub \vec{a} . \phi^{\vec{a}}_{X',\mu'} \rdoub_{U(Y,\nu)}}                                             
\end{tikzcd}
\]
commutes because this is the way $\{\vec{a},\vec{b} . \theta_f \}$ internalizes in a $Set$-model. This concludes our proof of $Lan_y(U) \circ Lan_F \cong Id$.

We now prove that $Lan_F \circ Lan_y(U) = Id$. Since all the functors involved are left-exact and colimit-preserving, it suffices to show that the isomorphism holds on the corresponding models of $\mathbb{T}$ inside $Set[\mathbb{T}]$. This means we have to compute $Lan_F \circ Lan_y(U)$ on the 'signature' of $\mathbb{T}$ and show that the yielded structure is isomorphic as a $\mathbb{T}$-model to the universal model of $Set[\mathbb{T}]$.

We first check this for the sort $B$. This means that we have to show that $Lan_F(U) \cong y \{b . \top\}$. This reduces to showing
\[
\coprod_{r \in [0,1]} y \{b . B_r b\} \cong y \{b . \top\} .
\]
We can prove this by showing that for every sheaf $\mathcal{F} \in Set[\mathbb{T}]$, we have a natural bijection
\[
Hom(y \{b . \top\}, \mathcal{F}) \cong \prod_{r \in [0,1]} Hom(y \{b . B_r b\}, \mathcal{F})
\]
given by the inclusions $\iota_r : \{b . B_r b\} \to \{b . \top\}$. Applying the yoneda lemma on both sides, this is equivalent to showing that the inclusions induce an isomorphism
\[
\mathcal{F} \{b . \top\} \cong \prod_{r \in [0,1]} \mathcal{F} \{b . B_r b\} .
\]
But this can be checked by applying the sheaf condition to the cover of $\{b . \top\}$ given by the $\{b . B_r b\}$. Notice that here we are using the two partition axioms.

Next, we need to show that the above isomorphism actually is an isomorphism of $\mathbb{T}$-models. Explicitly, we have to show that for each function symbol $f$ our isomorphism induces an iso
% TODO: This should be improved on.
\[
\begin{tikzcd}[column sep=tiny]
    {y \{a_1,\cdots,a_n . \top \}} \arrow[d, "{[f(a_1,\cdots,a_n) = a]}"'] \arrow[r, "\cong"',phantom, shift right=7] & Lan_F U^n \arrow[d, "Lan_F U(f)"] \\
    y \{a . \top \}                                                                                           & Lan_F U                            
\end{tikzcd}
\]
in the category of arrows in $Set[\mathbb{T}]$. The upper isomorphim is induced by the data of the respective universal cones exhibiting the upper objects as cartesian products. We also need the analogous statement for relation symbols. In particular this apply this remark to Kan-extensions. Notice that here and also in what follows, we are taken the viewpoint on objects defined by universal property described in section \ref{conventions}. 

We first consider the 0-ary function $U(0): * \to U$. We get the chain of isomorphisms

\[
\begin{tikzcd}
Lan_F * \arrow[d, "Lan_F U(0)"'] \arrow[r, "\cong"',phantom, shift right=7] & Lan_F y U_0 \arrow[d] \arrow[r, "\cong"',phantom, shift right=7] & y \{b . B_0 b \} \arrow[d] \arrow[r, "\cong"',phantom, shift right=7] & {y \{[].\top\}} \arrow[d, "{[a=0]_*}"] \\
Lan_F U                                                             & Lan_F \coprod y U_r                                      & \coprod y \{ b . B_r b\}                                      & y\{a.\top\}                         
\end{tikzcd}
\]

where the first three isos clearly are isos satisfying the commutativity condition. The only interesting step in this chain is where we use the fact that $\{b . B_0 b\} \cong \{a . a = 0\} \cong \{[]. \top\}$, where the first isomorphism uses the that $B_0 a \dashv \vdash_a (a = 0)$. One can check that the last commutativity condition also holds:
\[
[B_0 b]_* [a=0]_* = [B_0 b \wedge (a = 0)]_* = [B_0 b \wedge (a=b)]_*,
\]
where the left hand side is the upper right composition and the right hand side is the lower left composition. Now the composite isomorphism on the bottom clearly is the one constructed earlier. The proof for $1$ is almost the same, again one only needs the fact that $B_1 a \dashv \vdash_a (a = 1)$, which is provable in our theory.

We proceed with the binary function $U(\wedge): U \times U \to U$. We will prove the required isomorphism in the following two steps:
\[
\begin{tikzcd}
Lan_F(U \times U) \arrow[d, "Lan_F(U(\wedge))"'] \arrow[r, phantom, shift right=7, "\cong"] & {\coprod y \{\vec{b}.\bigwedge_{i=1,\cdots 4} B_{r_i} b_i\}} \arrow[d] \arrow[r, phantom, shift right=7, "\cong"] & {y \{a_1,a_2.\top\}} \arrow[d, "{[a = a_1 \wedge a_2]_*}"] \\
Lan_F U                                          & \coprod y \{b.B_rb\} & y\{a.\top\} .
\end{tikzcd}
\]
We start with the left isomorphism. We can use \ref{multiproduct} to rewrite $U \times U$ as a coproduct of representables by using the isomorphism $U \times U \to \coprod y U_{r_1 \cdots r_4}$ given on components by 
\[
(a,b) \mapsto (a \wedge b, a \wedge \neg b, \neg a \wedge b, \neg a \wedge \neg b) .
\]
Using the inverse of this isomorphism $(b_1,b_2,b_3,b_4) \mapsto (b_1 \vee b_2, b_1 \vee b_3)$, we get the commutative square which after applying $Lan_F$ yields the required commutative square above on the left
\[
\begin{tikzcd}
U \times U \arrow[d, "U(\wedge)"'] & \coprod y U_{r_1 \cdots r_4} \arrow[d, "\coprod f"] \arrow[l, "\cong"'] \\
U                                  & \coprod y U_r \arrow[l, "\cong"]                          ,
\end{tikzcd}
\]

where $f$ sends a partition into four subsets onto the first subset. Since we do not only need any isomorphism $Lan_F (U \times U) \cong \coprod y F (U_{r_1 \cdots r_4})$, but a specific one induced on the components on the cartesian product, we check that the upper isomorphism in our diagram is in fact induced by the required isomorphism. We do this by noting that the map $U \times U \xleftarrow{\cong} \coprod y U_{r_1 \cdots r_4}$ commutes with the required map on the first projection of the cartesian products:

\[
\begin{tikzcd}
U \times U \arrow[d, "p_1"'] & \coprod y U_{r_1 \cdots r_4} \arrow[d, "\alpha_1"] \arrow[l, "\cong"'] \\
U                            & \coprod y U_r \arrow[l, "\cong"]                                    ,
\end{tikzcd}
\]
where $\alpha_1$ is the map induced by the maps $y U_{r_1 \cdots r_4} \to y U_r$ given by $(b_1,\cdots,b_4) \mapsto b_1 \vee b_2$, where the $b_i$ are seen as partitions. There is an analogous map $\alpha_2$ that has a similar relation to the second projection $p_2$. Now the two isomorphims on the the diagram above imply that $\alpha_1$ and $\alpha_2$ form a universal cone for a cartesian product. This immediately implies that the isomorphism $U \times U \cong \coprod y U_{r_1 \cdots r_4}$ is the one induced by the universal properties of the product and moreover, by flatness of $F$, this fact gets preserved when applying $Lan_F$. Now that we have shown the first part of the isomorphism, we wish to show that we have an isomorphism
\[
\begin{tikzcd}
{\coprod y \{\vec{b}.\bigwedge_{i=1,\cdots 4} B_{r_i} b_i\}} \arrow[d, "{\coprod [b = b_1]_*}"'] \arrow[r, "\phi"] & {y \{a_1,a_2.\top\}} \arrow[d, "{[a = a_1 \wedge a_2]_*}"] \\
\coprod y \{b.B_rb\} \arrow[r, "\cong"']                                                & y\{a.\top\}                                               ,
\end{tikzcd}
\]
where $\phi$ is given by $[(a_1 = b_1 \vee b_2) \wedge (a_2 = b_1 \vee b_3)]_*$. It is easy to see that the diagram commutes. The fact that $\phi$ is an isomorphism will follow by the fact that $\phi$ is induced by the required isomorphisms. Like earlier, this is shown by remarking that

\[
\begin{tikzcd}
{\coprod y \{\vec{b}.\bigwedge_{i=1,\cdots 4} B_{r_i} b_i\}} \arrow[d, "\alpha_1"'] \arrow[r, "\phi"] & {y \{a_1,a_2.\top\}} \arrow[d, "{[a = a_1]_*}"] \\
\coprod y \{b.B_rb\} \arrow[r, "\cong"']                                                            & y\{a.\top\}
\end{tikzcd}
\]
commutes. But this time, we already know that $\alpha_1$ and $\alpha_2$ are a universal cone of a product and similarly, $[a=a_1]_*$ and $[a=a_2]_*$ are the projections of a product. This already implies that $\phi$ is induced by the correct isomorphisms and moreover that $\phi$ itself is an isomorphism. This concludes the proof that $Lan_F U(\wedge)$ matches the corresponding operation on the universal model in $Set[\mathbb{T}]$. The argument for $\vee$ should be very similar.

We show that $Lan_F U(\neg)$ matches the corresponding operation on the universal model, by showing that we don't need to show it. Let $\mathbb{T}_{BAlg}$ denote the theory of boolean algebras and $\mathbb{T}_{DLat'}$ be the theory of distributive lattices together with the axiom
\[
\top \vdash_{x} (\exists y) ((x \wedge y=0)\wedge (x\vee y=1)) .
\]

We even have that $\mathcal{C}^{\mathbb{T}_{BAlg}} \simeq \mathcal{C}^{\mathbb{T}_{DLat'}}$. The functor pointing towards the left is just given by the universal model in $\mathbb{T}_{BAlg}$. The functor pointing towards the right is given by the universal model in $\mathbb{T}_{DLat'}$, where negation is given by the $\mathbb{T}_{DLat'}$-provably functional formula
\[
[(x\wedge y=0) \wedge (x\vee y=1)] : \{x.\top\} \to \{y.\top\}  .
\]

% TODO: Clean this up. Say something like that one can trivially see that the set-models match.
One can verify that this actually is an equivalence by using \ref{interpretations} and the fact that
\[
[y=\neg x] = [(x\wedge y=0) \wedge (x\vee y=1)] 
\]
in $\mathcal{C}^{\mathbb{T}_{BAlg}}$. This now proves that we don't need to check that negation gets preserved, by identifying models of $\mathbb{T}_{BAlg}$ with models of $\mathbb{T}_{DLat'}$.

Luckily, sending $U_r \to \coprod U_r$ through $Lan_F$ is easily seen to give the expected subobject, concluding the proof.
\end{proof}

We proceed by investigating what $Sh(FinProb, J_{at})$ classifies.

\begin{definition} \label{theory_of_intevals}
Define the \textit{theory of intervals} $\mathbb{T}_{int}$ by adding the axioms
\[
B_s a \vdash_a (\exists b) \big ( (b = a \wedge b) \wedge B_r b \big )
\]
for all $r,s \in [0,1]$ with $r \leq s$ to the theory of boolean probability algebras.
\end{definition}

Note that the models of $\mathbb{T}_{int}$ in $Set$ must all be uncountable. We now look at some examples of intervals in $Set$.

\begin{definition}
Call a boolean probability algebra $(A,\mu)$ simply a probability algebra, if $A$ is a complete boolean algebra and moreover, for every directed family $a_i$ of elements of $A$, we have the additivity condition
\[
\mu(\bigvee a_i) = \text{sup } \mu(a_i) .
\]
The pairs $(A,\mu)$ for which there is a $c > 0$ such that $(A, c \mu)$ is a probability algebra will simply be called measure algebras. A morphism of measure algebras is a morphism of boolean algebras that is measure-preserving.
\end{definition}

Note that we have chosen a slightly more restrictive definition of measure algebra than is standard, since we did not allow the measure to adopt infinite values.

Measure algebras are the correct setting for doing measure theory while ignoring the effects of nullsets. They connect to the more standard setting for measure theory as follows: Given a $\sigma$-algebra $(X,\Sigma)$ and a measure on $(X,\Sigma)$, dividing out the nullsets out of $\Sigma$ is guaranteed to yield a measure algebra. This is a surprising, since the $\sigma$-algebra doesn't need to have infinite joins or meets, but the measure algebra does have them. One can also conversely construct a measure space on a $\sigma$-algebra out of a measure algebra by using the Stone space of the measure algebra. For many more details on measure algebras, see chapter 32 of \cite{fremlin}, a notably long reference on measure theory.

\begin{example} \label{interval_examples}
\begin{itemize}
\item Let $(A,\mu)$ be an atomless probability algebra. Let $a \in A$ with $\mu(a) = r$ and let $s \in [0,r]$. We use the axiom of choice to construct an element of measure $s$. Consider the set
\[
S := \{ b \leq a | \mu(b) \leq s \}.
\]
Since every chain has a supremum, we can use Zorn's lemma to get a maximal element $b \in S$. Now consider the set
\[
T := \{ b' \leq a | b' \geq b\} .
\]
This has a minimal element $b'$ given by the meet of all elements of $T$. Note that $\mu(b') \geq s$ since $b' \geq b$. Thus, for all $c$ with $b \leq c \leq b'$, $c$ must either be $b$ or $b'$. This implies that $b' \wedge \neg b$ is an atom, or that $b' = b$. But the former is impossible due to the atomless hypothesis. Thus we have constructed an element of measure $s$, which means that $(A,\mu)$ is an interval.
\item Let $I$ denote the boolean probability algebra defined by the boolean algebra of Borel-subsets of the interval modulo the ideal of null-sets. Note that we can equivalently divide out the null-sets out of the boolean algebra of Lebesgue-subsets of the interval. Let $(I, \lambda)$ denote this boolean algebra equipped with the Lebesgue measure, and call $(I, \lambda)$ the Lebesgue interval. This is an atomless measure algebra, so the Lebesgue interval $(I, \lambda)$ is actually an interval.
\item More generally, any radon measure gives rise to an atomless measure algebra and thus also gives rise to an interval.
\item Note that not all intervals are atomless probability algebras. Consider the subalgebra
\[
A = \{(x_i) \in \prod_{i=1}^{\infty} I | \text{ finitely many } x_i \neq 0 \text{ or finitely many } x_i \neq 1 \}
\]
of the product of boolean algebras $\prod_{i \in \mathbb{N}} I$, where $(I, \lambda)$ is the Lebesgue interval. For some intuition on product boolean algebras, see \ref{partitions}. $A$ is the boolean algebra generated by elements that are everywhere zero except at one index. Note that $A$ is not complete and we have a measure on this boolean algebra defined by
\[
\mu((x_i)) := \sum_{i=1}^{\infty} 2^{-i} \lambda(x_i) ,
\]
where $\lambda$ denotes the Lebesgue measure on the $i$th Lebesgue interval. It can be easily seen that the defined boolean probability algebra is actually an interval.
\end{itemize}
\end{example}


\begin{theorem} \label{classifying}
The topos $Sh(FinProb,J_{at})$ classifies the theory $\mathbb{T}_{int}$. Moreover, $U$ is the universal model that gives us the required equivalence.
\end{theorem}
\begin{proof}
We use \cite{caramello_book}, corollary 8.1.14 and \ref{classifying_presheaf} in order to get that $Sh(FinProb,J_{at})$ classifies $\mathbb{T}_{bpalg}$ together with an axiom
\[
\phi_{\alpha}^{\vec{b}} \vdash_{\vec{b}} (\exists \vec{a}) \theta_f^{\vec{a},\vec{b}}
\]
for each morphism $f: \alpha \to \beta$ in $FinProb$. One can easily see that the axioms
\[
\phi_{U_{r+s,t}}^{\vec{b}} \vdash_{\vec{b}} (\exists \vec{a}) \theta_f^{\vec{a},\vec{b}}
\]
suffice, where $f: U_{r,s,t} \to U_{r+s,t}$ joins the first two elements. Note that $r,s$ and $t$ denote any elements in $[0,1]$. Now, the axioms above are precisely reformulations of the interval axioms.

Now we compute the universal model. By the way that the equivalence in \cite{caramello_book}, corollary 8.1.14 is constructed \footnote{One can use the commutative square in theorem 8.1.3 to see this, with a similar argument as in the remark below.}, the universal model is the sheafification on $U$. But we can show that $U$ is already a sheaf by using \ref{sheaf_condition_weak}. This tells us that $p_1^{-1}(a) = p_2^{-1}(a)$, which means that
IT IS A SHEAF BY ATOM NOTATION! % Explain why we don't need to sheafify coproducts!!!
\[
\forall x,y \text{ such that } f(x) = f(y): x \in a \Leftrightarrow y \in a .
\]
This is equivalent to the fact that
\[
\forall x \in X: f^{-1}(x) \cap a \text{ is } \emptyset \text{ or } f^{-1}(x) .
\]
But this means, that we can lift the subset $a \in U(\alpha)$ to a subset $b \in U(\beta)$, and the subset clearly must be unique.

Thus we can conclude that $U$ is in fact the universal model in $Sh(FinProb, J_{at})$.
\end{proof}

\begin{remark} \label{classifying_equiv_data}
Using the commutative square(it only commutes up to isomorphism) for any Grothendieck topos $\mathcal{E}$
\[
\begin{tikzcd}
\mathbb{T}_{int}\text{-}mod(\mathcal{E}) \arrow[d] \arrow[r, "\simeq"] & {Geom(\mathcal{E},Sh(FinProb,J_{at}))} \arrow[d, "j \circ -"] \\
\mathbb{T}_{bpalg}\text{-}mod(\mathcal{E}) \arrow[r, "\simeq"]         & {Geom(\mathcal{E},Set^{FinProb^{op}})}                       
\end{tikzcd}
\]
in theorem 8.1.3 in \cite{caramello_book}, one can extract more information about how to compute the equivalence. Here $j$ denotes the sheafification functor. First, note that the inclusion on the left hand side is fully faithful and that the functor on the bottom is given by the functor in \ref{inverse}. Thus we can choose the equivalence on the top such that it is precisely defined by the interpretation in \ref{inverse}.

Thus, we can explicitly describe the equivalence of categories
\[
    \mathbb{T}_{int}\text{-}mod(\mathcal{E}) \simeq Geom(\mathcal{E},Sh(FinProb,J_{at}))
\]
by giving the functor going to the right as the interpretation in \ref{inverse} and the functor going to the left by Yoneda embedding the universal model $U$.

In particular, if we have a model $(A,\mu)$ of $\mathbb{T}_{int}$ in $Set$, we can view it as a geometric morphism $Set \to Sh(FinProb, J_{at})$ by specifying it as the $J_{at}$-flat functor $FinProb \to Set$ given by sending a finite probability space $(X,\nu)$ to the set
\[
\{(a_i)_{i \in X} | a_i \in A \text{ are pairwise disjoint, } \mu(a_i) = \nu(i) \}
\]
and by sending a map $(X,\nu_1) \to (Y,\nu_2)$ the map
\[
(a_j)_{j \in X} \mapsto \big (\bigvee_{f(j) = i} a_j \big )_{i \in Y} .
\]
\end{remark}


\subsection{Completeness and quantifier elimination}

TODO: THIS SECTION IS UBERSCUFFED RIGHT NOW
\begin{corollary}
Every infinitary first-order formula over the empty context over the theory $\mathbb{T}_{int}$ is provably equivalent to $\top$ or $\bot$ in $\mathbb{T}_{int}$.
\end{corollary}
\begin{proof}
    Since we know that infinitary first-order formulas can be internalized in $\mathfrak{Prob}$ [cite sth], we only need to remark that a formula over the empty context invernalizes to a subobject of the subobject classifier. Because the subobject classifier only has two subobjects, the claim follows.
    
    We need to talk about infinitary first-order logic sites(or use claims about those in the literature) in order to be more precise.
\end{proof}
% This result is particularly remarkable. The study of the geometric logic of $Sh(FinSet, J_{at})$ corresponds to the study of geometric statements over the boolean probability algebra signature on $(I, \lambda)$. Thus $\mathbb{T}_{int}$ can be thought as a synthetic context for studying geometric properties of the measure-theoretic interval.

% All this should be defined much more carefully
\begin{corollary}
    Let $\{ \vec{x} . \psi\}$ be a formula in context over the theory $\mathbb{T}_{int}$, where $\vec{x} = x_1, \cdots x_n$. Then it is provably equivalent to a a formula of the form $\{\vec{y} . \bigvee_j \phi_{U_{r_i^j}} \}$, where each of the $r_i^j$ in the family is in $P^1_{2^n}$ and $\vec{y} = y_1,\cdots,y_{2^n}$.
\end{corollary}
\begin{proof}
    Let $\{ \vec{x} . \psi\}$ such a formula in context, where $\vec{x} = x_1, \cdots x_n$. Then it internalizes to a subobject of the iterated cartesian product $U^n$, where $n$ is the length of the context. Since we can compute $U^n$ using multiproducts to be $\langle * | t_{i_1,\cdots i_n} \in P^n_{2,\cdots 2} \rangle$, we know that $\{ \vec{x} . \psi\}$ is a join of the subobjects given by atoms. But the subobjects given by the atoms are precisely the $\phi_{X,\mu}$, so the claim follows.

    Here in reality we also need some results about infinitary first order logic sites, if we want to be precise.
\end{proof}

This is a form of quantifier elimination, only that this is a bit different than traditional quantifier elimination in that we can't guarantee that the equivalent quantifier-free formula has only finite joins. Moreover, our formulas aren't even over the same context.


\subsection{Simple functions} \label{simple_functions}

In this section we aim to illustrate how we can use $\mathfrak{Prob}$ in order to look at problems in probability theory that have a more combinatorial and less analytic nature. 

% TODO: We should throughly explain why stuff like L^0 doesn't work and the philosophical ramifications of this. Because it is very nonobvious and philosophically interpreting Prob has been and still is one of the hardest problems we have faced. It would be retarded not to write about it.

\begin{definition}
    Define the presheaf $\mathcal{S}$ of simple functions on $FinProb$ to be defined by sending $(X,\mu)$ to the set of maps of sets $\mathbb{R}^X$ and by sending maps between finite probablitiy spaces to the corresponding precomposition maps.
\end{definition}

We show that $\mathcal{S}$ is a sheaf by showing that $\mathcal{S}$ is a coproduct of atoms.

\begin{proposition}
    We have that
    \[
        \mathcal{S} \cong \langle \{y_1 < \cdots < y_n | y_i \in \mathbb{R} \} | (r_1, \cdots, r_n) \in \mathcal{A}^{re} \rangle
    \]
    and in particular, $\mathcal{S}$ is a sheaf.
\end{proposition}
\begin{proof}
    The essential observation is that we can describe any $s \in \mathbb{R}^X$ by looking at the ordered set of values in $\mathbb{R}$ that the function $s$ takes.
\end{proof}


The point of this chapter is convincing the reader that for a model $F: \mathcal{E} \to \mathfrak{Prob}$, $F^*(\mathcal{S})$ is a suitable definition for the simple functions over $F$ in $\mathcal{E}$. We will prove that we can recover the simple functions over a $\sigma$-algebra with this construction. Of course, for proving meaningful statements, we want to equip $\mathcal{S}$ with suitable structure.

\begin{definition}
    Define the theory of expectation algebras to be the geometric theory of $\mathbb{R}$-algebras together with a unary relation symbol $E_r$ for each $r \in \mathbb{R}$, adding the following geometric sequents:
    \begin{enumerate}
        \item \textit{$E_r$ form a partition}. For all $r, s \in \mathbb{R}$ with $r \neq s$ we have an axiom
        \[
        E_r(a)  \wedge E_s(a) \vdash \bot
        \]
        and we also have an axiom
        \[
        \top \vdash \bigvee_{r \in \mathbb{R}} E_r(a).
        \]
        \item \textit{Linearity}. For all $r, s \in \mathbb{R}$, we require the sequents
        \[
        E_r(a) \wedge E_s(a) \vdash E_{r+s}(a + b)
        \]
        and for all $r \in \mathbb{R}$ and $\lambda \in \mathbb{R}$, we also need
        \[
        E_r(a) \vdash E_{\lambda r} (\lambda \cdot a) .
        \]
        \item \textit{Positivity}.
        \[
            \top \vdash \bigvee_{r \geq 0} E_r a^2
        \]
        \item \textit{Expectation}.
        \[
            \top \vdash E_1 1
        \]
        \item \textit{No nullsets}.
        \[
            E_0 (a^2) \vdash a = 0 % We need to be careful what we write here, since a priori I don't see why our algebra should be an integral domain.
        \]
    \end{enumerate}
    %     \item Define expectation algebra structure on $\mathcal{S}$.
    %     \item Let $\alpha$ be a model of the theory of intervals in a topos $\mathcal{E}$, i.e. a geometric morphism $\mathcal{E} \to \mathfrak{Prob}$. Then we define the simple functions over $\alpha$ to be the expectation algebra that the inverse image functor sends $\mathcal{S}$ to.
    % \end{enumerate}
\end{definition}

Here we made use of the same trick we used when defining the theory of boolean probability algebras. We used unary relation symbols to encode a function. The thing that now is different, is that if we have a real $\lambda \in \mathbb{R}$, we get again a canonical element of our $\mathbb{R}$-algebra, since we can consider $\lambda \cdot 1$. This means that if $A$ is an $\mathbb{R}$-algebra in any topos, we get a canonical operator $\mathbb{E}: A \to A$, which can be thought of an expectation operator.

% TODO: Is this even true?
Now under the usual functional-analytic correspondence of finitely additive measures and linear operators to $\mathbb{R}$, the fact that a measure is non-negative corresponds to our \emph{positivity} axiom. The fact that a measure is a probability measure, corresponds to our \emph{expectation} axiom. The \emph{no nullsets} axiom corresponds to the fact that there is only one element of measure zero in a boolean probability algebra. Note that we could have also axiomatized the operator $\mathbb{E}$ directly, although that wouldn't necessarily have been easier.

% TODO: ref this:https://terrytao.wordpress.com/2014/06/28/algebraic-probability-spaces/

We can now define expectation algebra structure on $\mathcal{S}$. Note that we do not yet check the axioms, for now we will only think of $\mathcal{S}$ as a structure over the signature of the theory of expectation algebras.

\begin{definition}
    \begin{enumerate}
        \item Define $+: \mathcal{S} \times \mathcal{S} \to \mathcal{S}$ on the components of the natural transformation by pointwise addition of the $s \in \mathbb{R}^X$.
        \item Define $\cdot: \mathcal{S} \times \mathcal{S} \to \mathcal{S}$ on the components of the natural transformation by pointwise multiplication of the $s \in \mathbb{R}^X$.
        \item Define $E_r \xrightarrow{} \mathcal{S}$ to be the subsheaf that on an object $(X,\mu)$ consists of the $s \in \mathbb{R}^X$ with $\sum_{i \in X} s(i) = r$.
    \end{enumerate}
\end{definition}

Our aim is to send $\mathcal{S}$ and its structure through inverse image functors. Thus it is imperative to figure out how our structure behaves on the atoms. The first step is decomposing $\mathcal{S} \times \mathcal{S}$:

\begin{align*}
    S \times S &\cong \langle \{y_1 < \cdots < y_n | y_i \in \mathbb{R} \} | (r_1, \cdots, r_n) \in \mathcal{A}^{re} \rangle^2 \\
    &\cong \langle \{y_1 < \cdots < y_n, z_1 < \cdots < z_m | y_i, z_j \in \mathbb{R} \} | (t_{ij})_{1 \leq i \leq n, 0 \leq j \leq m} \in \mathcal{A}^{re} \rangle
\end{align*}

Now we can use \ref{atom_coprod_maps} to specify our structure on the elements of this set of atoms:

\begin{proposition}
    \begin{enumerate}
        \item We calculate addition on an element $(t_{ij}, y_i, z_j)$. Let $x_1 < x_2 < \cdots < x_k$ denote the elements of $\{y_i + z_j | i,j \}$. Then addition is given on elements by
        \[
            (t_{ij},y_i,z_j) \mapsto (\sum_{y_i + z_j = x_k} t_{ij}, x_k) 
        \]
        with the corresponding map on atoms
        \[
            U_{t_{ij}} \to U_{\sum_{y_i + z_j = x_k} t_{ij}}
        \]
        defined to be the join the two pairs $(i,j)$, $(i',j')$ if the equality $y_i + z_j = y_{i'} + z_{j'}$ holds.
        \item We calculate multiplication on an element $(t_{ij}, y_i, z_j)$. Let $x_1 < x_2 < \cdots < x_k$ denote the elements of $\{y_i \cdot z_j | i,j \}$. Then we multiplication is given on elements by
        \[
            (t_{ij},y_i,z_j) \mapsto (\sum_{y_i \cdot z_j = x_k} t_{ij}, x_k) 
        \]
        with the corresponding map on atoms
        \[
            U_{t_{ij}} \to U_{\sum_{y_i \cdot z_j = x_k} t_{ij}}
        \]
        defined to be the join the two pairs $(i,j)$, $(i',j')$ if the equality $y_i \cdot z_j = y_{i'} \cdot z_{j'}$ holds.
        \item $E_r \to \mathcal{S}$ is the subobject
        \[
            \langle \{y_1 < \cdots < y_n | y_i \in \mathbb{R}, \sum r_i y_i = r \} | (r_1, \cdots, r_n) \in \mathcal{A}^{re} \rangle
        \]
        of $\mathcal{S}$.
    \end{enumerate}
\end{proposition}

Having defined the simple functions in $\mathfrak{Prob}$, we can define simple functions in great generality.

\begin{definition}
    Let $F: \mathcal{E} \to \mathfrak{Prob}$ be an interval in $\mathcal{E}$. Then we can define the simple functions over $F$ to be $F^*(\mathcal{S})$ equipped with the corresponding expectation algebra structure.
\end{definition}

For the sake of comparing this unusual definition of the set of simple functions to the more standard one, we recall the following:

\begin{definition}
    Define the expectation algebra of simple functions $S(X,\Sigma, \mu)$ on a probability space $(X, \Sigma, \mu)$ to be the set of measurable maps $X \to \mathbb{R}$ of finite image modulo equality almost everywhere equipped with pointwise addition, pointwise multiplication and expectation.
\end{definition}

\begin{proposition}
    Let $(X, \Sigma, \mu)$ be a probability space such that the corresponding measure algebra is atomless. Then $S(X,\Sigma,\mu)$ is isomorphic to the expectation algebra over the corresponding interval.
\end{proposition}
\begin{proof}
    The atomless measure algebra of $(X, \Sigma, \mu)$ is an inteval and thus can be viewed as a geometric morphism $F: Set \to \mathfrak{Prob}$. $F^*$ sends an atom $U_{r_i}$ to the set of partitions of the interval with measures $r_1,\cdots,r_n$. Thus, since $F^*$ is colimit preserving, $\mathcal{S}$ gets sent to
    \[
        \coprod_{\substack{r_1, \cdots r_n \in \mathcal{A}^{re} \\ x_1 < \cdots < x_n}} F^*(U_{r_1\cdots r_n}) .
    \]
    It should be clear that this corresponds to the traditional set of simple functions. It is a straightforward calculation that expectation, addition and multiplication are the correct ones. The necessary setup has already been done, since addition and multiplication have already been decomposed into their components on atoms.
\end{proof}

This proof ilustrates one of the most fascinating things about the set of atoms notation(the same goes for the $(FinProb, J_{at})$ site). Partitions are treated on a very abstract level, where it does not even make sense to ask \emph{where} the different parts of the partitions are located. There is simply no data about the location of the partition, only how big it is. The way we defined the simple functions, we never had to deal with issues about \emph{where} exactly a simple function took a specific value, but instead just specified the measure of the preimages.

Applying the inverse image functors of models inserts that missing location information(similarly when passing to the group action sites). The sets we deal with are suddently much, much bigger. The surprising thing, is that for the purposes of calculating with simple functions, that data is fully irrelevant.

\begin{theorem}
    \begin{enumerate}
    \item $\mathcal{S}$ is an expectation algebra.
    \item The simple functions over an interval are all infinitary first order equivalent as expectation algebras.
    \end{enumerate}
\end{theorem}
\begin{proof}
    Use that the topos is two-valued.
\end{proof}

% TODO: Say that poset structure also matches, since x \leq y iff y - x is a square.

say the following
\begin{enumerate}
    \item Legitimizes(to a certain degree) the belief that the base $\sigma$-algebra does not matter
    \item Extremely interesting: This technique is not at all specific to $\mathfrak{Prob}$. One can imagine proving similar results in a wide variety of other contexts. Classical Model theory could not prove this kind of stuff?
\end{enumerate}

\section{$\mathfrak{Prob}$ as a topos of continuous group actions}

We seek to apply the following result due to O.Caramello:

\begin{theorem}\label{olivia}
Let $\mathcal{C}$ be a small, inhabited category satisfying the amalgamation and joint-embedding properties, and let $u$ be a $\mathcal{C}$-universal and $\mathcal{C}$-ultrahomogeneous object in $Ind(\mathcal{C})$. Then the collection $\mathcal{I}_{\mathcal{C}}$ of sets of the form $\mathcal{I}_{\chi}:=\{f:u\overset{\sim}{\rightarrow} u| f\circ \chi=\chi\} $, for an arrow $\chi:c\rightarrow u$, form an object $c$ of $\mathcal{C}$ to $u$ defines an algebraic base for the group of automorphisms of $u$ in $Ind(\mathcal{C})$, and, denoted by $Aut_\mathcal{C}$ the resulting topological group, we have an equivalence of toposes
\[\text{Sh}(\mathcal{C}^{op},J_{at})\simeq \text{Cont}(Aut_\mathcal{C}) \]
induced by the functor $F:\mathcal{C}^{op}\rightarrow \text{Cont}(Aut_{\mathcal{C}})$ which sends any object $c$ of $\mathcal{C}$ to the set $Hom_{Ind(\mathcal{C})}(c,u)$ equipped with the action by post-composition and any arrow $f:c\rightarrow d$ in $\mathcal{C}$ to pre-composition by $f$.
\end{theorem}

In our context we set $\mathcal{C}=BPAlg_f$ and will show that the Lebesgue interval is $BPAlg_f$-universal and $BPAlg_f$-ultrahomogeneous. But before we do that, we need some remarks that will be used in our proof.

\begin{remark}\label{partitions}
For an element $a \in B$ of a boolean algebra, we will denote the ideal of elements of $B$ that are less than or equal to $a$ by $I(a)$.
\begin{enumerate}
\item In the category of boolean algebras, if one has a \\ boolean algebra $A$, we get the following correspondence between decompositions $A \cong B \times C$ and partitions $a,b$ (i.e. pairs of elements $a,b$ with $a \vee b = 1$ and $a \wedge b = 0$). A decomposition $B \times C$ induces the partition $(1,0), (0,1)$ on $A$ and conversely the partition $a,b$ induces the decomposition \\ $A \cong I(a) \times I(b)$. This lets us interpret the product of boolean algebras as some sort of disjoint union.
\item The interesting thing about this description of products, is that it shows that if we have a map $A \to B$ of boolean algebras and we have a decomposition $A \cong A_1 \times A_2$, then this induces a decomposition of $B$.
\item Given two boolean probability algebras $(A, \mu)$ and $(B, \nu)$, there is a measure $(\mu + \nu)(x,y) := \mu(x) + \nu(y)$ on $A \times B$. Unfortunately, this can't be the product in $BPAlg$, because $\mu + \nu$ is not a probability measure nor are the projections measure-preserving.
\end{enumerate}
\end{remark}

We could now start proving that the Lebesgue interval satisfies the required properties, but in order to emphasize that the Lebesgue interval is not really special, we will will prove that a well-known more general class of measure algebras is $BPAlg_f$-universal and $BPAlg_f$-ultrahomogeneous. The reader can ignore this and pretend that he is dealing with the Lebesgue interval.

\begin{definition} \label{maharam_type_homogeneous}
% TODO: Maharam-type homogeneous should be emphazised less by intead always requiring the 'ultrahomogeneous' hypothesis.
\begin{enumerate}
\item Let $A$ be a complete boolean algebra. We say that a subset $S \subset A$ generates $A$ if $A$ is the only complete boolean subalgebra of $A$ containing $S$.
\item Let $A$ be a complete boolean algebra. We say that the Maharam type of $A$ is the smallest possible cardinality of a generating set.
\item We moreover say that $A$ is Maharam-type-homogeneous if the Maharam type of every nonzero principal ideal $I(a)$ is the same.
\item Call a measure algebra Maharam-type-homogeneous if its underlying boolean algebra is Maharam-type homogeneous.
\end{enumerate}
\end{definition}

For more information on Maharam-type-homogeneous measure algebras, see chapter 33 of \cite{fremlin}. The crucial fact about Maharam-type-homogeneous measure algebras, is they are isomorphic if and only if they have the same Maharam type and the top element $1$ has the same measure on both measure algebras(see 331I of \cite{fremlin}). Moreover, there is a surprising theorem by Maharam (see 332J in \cite{fremlin}) that lets us decompose any atomless measure algebra into Maharam-type-homogeneous measure algebras.

Now we actually show that homogeneous-Maharam-type probability algebras are $BPAlg_f$-universal and $BPAlg_f$-ultrahomogeneous. More concretely, we prove the following for a Maharam-type-homogeneous probability algebra $(M, \alpha)$:

\begin{lemma}\begin{enumerate}
\item $FinProb$ has a terminal object, proving the joint embedding property.
\item $FinProb$ fulfills the right Ore condition.
\item For any $(A,\mu),(B,\nu)$ in $BPAlg_f$ , an arrow $f:(A,\mu)\rightarrow (B,\nu)$ in \\
 $BPAlg_f$, and arrows $\chi_1:(A,\mu)\rightarrow (M, \alpha)$ as well as $\chi_2:(B,\nu)\rightarrow (M, \alpha)$ in $BPAlg$ there exists an isomorphism $j':(M, \alpha) \rightarrow (M, \alpha)$ such that $j'\circ \chi_1=\chi_2\circ j$:
 \begin{center}
 \begin{tikzcd}
{(A,\mu)} \arrow[r, "\chi_1"] \arrow[d, "j"'] & {(M, \alpha)} \arrow[d, "j'", dotted] \\
{(B,\nu)} \arrow[r, "\chi_2"']                & {(M, \alpha)}                        
\end{tikzcd}
 \end{center}
\item For any object $(A,\mu)$ of $BPAlg_f$ there exists an arrow $\chi:(A,\mu)\rightarrow (M, \alpha)$ in $BPAlg$.
\end{enumerate}
\end{lemma}
\begin{proof} 
\begin{enumerate}
\item The one-element set $\{*\}$ with with measure $\mu(\star)=1$ is the terminal object. Its underlying set the terminal object in $Set$ and the universal map is tautologically measure preserving.
\item We have already shown this in \ref{pullback_measure}.
\item
Now, given boolean probability algebras as in the claim above, we see that $(A, \mu)$ has a partition into atoms $x_i$. Crucially, if we apply a map of boolean algebras to this partition, we get a partition again. This means we can decompose our problem(by \ref{partitions}) into finding a measure-preserving map $j'$ as below:
\[
\begin{tikzcd}
2 \arrow[d, "j"'] \arrow[r, "\chi_1"]  & I(\chi_1 x_i) \arrow[d, "j'", dotted] \\
I(j x_i) \arrow[r, "\chi_2"'] & I(\chi_2 j x_i)                      
\end{tikzcd}
\]
Since $2 := \{0, 1\}$ is the initial object in boolean algebras, it suffices to show that we have an isomorphism of measure algebras
\[
I(\chi_1 x_i) \cong I(\chi_2 j x_i)
\]
for each $i$. Now both of these measure algebras are Maharam-type-homogeneous and have the same Maharam type, since $(M, \alpha)$ was Maharam-type-homogeneous. Moreover, the top element $1$ has the same measure in both algebras, so we can now use 331I in \cite{fremlin} in order to get our isomorphism.

\item A measure-preserving map $\chi:(\mathcal{P} X,\mu)\rightarrow (A,\mu)$ consists of precisely a partition of $(A,\mu)$ into finitely many elements of predetermined measure. But this is precisely the interval property for atomless measure algebras, see \ref{interval_examples}.

% \item $f_1(\mathcal{B}_1)$ and $f_2(\mathcal{B}_2)$ are subalgebras of $I$, so we may generate the smallest subalgebra of them, containing both. Define $\mathcal{B}_3=\langle f_1(\mathcal{B}_1),f_2(\mathcal{B}_2) \rangle $ with the measure induced by the Lebesgue measure. As $f_1(\mathcal{B}_1)$ and $f_2(\mathcal{B}_2)$ are isomorphism to $\mathcal{B}_1$ resp. $\mathcal{B}_2$, the diagram commutes. It remains to show that $\mathcal{B}_3$ is finite (resp. at most countable). This is obvious, however any element of it may be represented as the unions of intersections of atoms $b_1\wedge b_2$ of $b_1\in \mathcal{B}_1$, $b_2\in\mathcal{B}_2$.
\end{enumerate}
\end{proof}

\begin{remark}
Notice that by using 331I in \cite{fremlin} we have implicitly used the axiom of choice.
\end{remark}

\begin{corollary}\label{Galois} Let $(M, \alpha)$ be a homogeneous-Maharam-type probability algebra. Let $G$ be the group of automorphisms of $(M, \alpha)$ topologised via an algebraic base given by collections $\mathcal{M}_{\chi}:=\{f:u\overset{\sim}{\rightarrow} u| f\circ \chi=\chi\} $ of automorphisms fixing a finite partition $\chi: (A,\mu)\rightarrow (M, \alpha)$. Then we get an equivalence of toposes, which is induced as in \ref{olivia}:
\[\text{Sh}(FinProb, J_{at})\simeq \text{Cont}(G)\]
\end{corollary}
\begin{remark} In the case of the Lebesgue interval, its automorphisms are commonly known as \emph{measure-preserving dynamical systems}. This hints at a connection to ergodic theory.
\end{remark}
%It follows that the atoms of the topos correspond to open subgroups of $G$. We shall classify them. %give ref
\begin{proposition} The automorphism group of a homogeneous-Maharam-type probability algebra is simple by 383Ib \cite{fremlin}. In particular, all topos-theoretic invariants involving any sort of normal subgroup listed in \cite{caramello_lafforgue} are trivial.
\end{proposition}

Another feature of this description is that toposes of continuous group actions are quite well understood. The interest in researching them comes from their connection to set theory and representation theory. So called \emph{permutation models} are one of the main tools of forcing, and they will also appear later in this paper as another interpretation of $\mathfrak{Prob}$. In a totally separate field of mathematics, a representation of a topological group on a $k$-vector space (with discrete topology) is nothing but an internal $k$-vector space \cite{XYZ} i.e. a sheaf of $k$-vector spaces in the topos of continuous group actions of that group.

Now that we have proved a non-trivial \emph{bridge}, we briefly discuss an application. We show that the universal model in $\mathfrak{Prob}$ has not only finite meets and joins, but all meets and joins, in a sense to be defined.

\begin{definition} A sheaf $L$ of posets with finite meets and top element is called an \emph{internal locale} if the map 
\[I: L\rightarrow \mathcal{P}(L) \]
sending ... has a right adjoint. An \emph{internal complete boolean algebra} is accordingly a sheaf of boolean algebras that is an internal locale.
\end{definition}

Our surprising result now follows by glueing some theorems from the literature.

\begin{theorem} The universal model of $\mathbb{T}_{int}$ is an internal complete boolean algebra.
\end{theorem}
\begin{proof} 
We use the following equivalence of categories:
\[ \text{Cont}_\tau(\text{Aut}_{BPAlg}(I,\lambda))\simeq \text{Set}[\mathbb{T}_{int}]  \]
We can use Theorem 7.3 (and remark 7.2) \cite{caramello_lafforgue} %is this the correct ref?
 to see $(I,\lambda)$ is a special model of $\mathbb{T}_{int}$ and thus the universal model in $\text{Cont}_\tau(\text{Aut}(I,\lambda))$ is $(I,\lambda)$ with the canonical continuous group action.\newline 
\indent Thus $U_{\mathbb{T}_{int}}$ is a complete boolean algebra acting on itself via automorphisms.  By C2.5.8(e) \cite{elephant} this proves that the universal model is an internal locale. Hence it is a complete boolean algebra.
\end{proof}

This theorem is remarkable as we get some completeness condition from definitions, which essentially only use statements about finite sets of variables. Nevertheless, we feel like it needs to be commented that the statement of this result might be a bit misleading at first sight. The reason is, that we will see in \ref{choice_failture}, that infinite families of variables often fail to exist inside $\mathfrak{Prob}$.


\section{The atoms of $\mathfrak{Prob}$ }
Sheaves on sites are a very complicated data type. Not only does one need to give a set for each object in the site, one also has to specify functions between these set for any morphism in the site. On top of that, all this has to satisfy the sheaf condition. Similarly convoluted is the data of a morphism of sheaves.\newline
\indent Almost miraculously, this complexity can be reduced to next to non. This will require quite a lot of work though. We will see that any sheaf decomposes into a coproduct of \emph{atoms} and morphisms of sheaves are coproducts of maps between these atoms.
\begin{definition} An \emph{atom} of a topos is an object whose only two subobjects are trivial or itself. Note that constant sheaf of the empty set is not an atom.
\end{definition}

\begin{definition} Given a topos, the \emph{category of atoms} of a topos is the full subcategory of objects, which are atoms.
\end{definition}
\begin{theorem}
Given an atomic topos $\mathcal{E}$ and its category of atoms $\mathcal{E}_{at}$, then $\mathcal{E}_{at}$ fulfils the right Ore condition and we have
\[\text{Sh}(\mathcal{E}_{at},J_{at})\simeq \mathcal{E} \]
More concretely, $\mathcal{E}$ is the $\infty$-positivisation of $\mathcal{E}_{at}$. This means any sheaf is a coproduct of atoms and any morphism of sheaves $f: F\rightarrow G$, where $F=\bigsqcup_{i\in M} A_i$ and $G=\bigsqcup_{j\in N} B_j$ for $A_i,B_j\in ob\mathcal{E}_{at}$, is a coproduct of maps $A_i\rightarrow B_{g(i)}$ in $\mathcal{E}_{at}$ for some function $g:M\rightarrow N$.
\end{theorem}
\begin{proof}
The statement is Proposition 4.21 of \cite{caramello}. % TODO: Why is this the same statement? Why is the topology on \mathcal{E}_{at} the atomic topology? There is at least some sort of commentary necessary here. Also, I don't like the usage of undefined terms like infinity positivasation and free completion, because it is not clear what that is even supposed to mean.
\end{proof}
We can quickly give a first description of the category of atoms in our case. But this will be not very workable.
\begin{proposition} Given a topological group $(G,\tau)$, the category of atoms of the topos $\text{Cont}_\tau (G)$ is equivalent to its subcategory of transitive, continuous actions. \cite{XYZ}
\end{proposition}
As our topos is equivalent to $\text{Cont}_\tau(\text{Aut}_{BPAlg}(I,\lambda))$, this immediately gives a description of its atoms.
But again, it would be nice to have a more combinatorial, workable interpretation of these objects. First we need to classify the atoms (as sheaves on the atomic site on $FinProb$) and thereby inadvertently the open subgroups of our topological groups.
\newline
\indent We have already seen some of the atoms: $y(X,\mu)$ for any finite probability space $(X,\mu)$. Any morphism $y(X,\mu)\rightarrow A$ for an atom $A$ is necessarily surjective, else its image would be a third subobject. As $A$ is not constantly $\emptyset$ and by the Yoneda lemma, such a map exists. Toposes are effective categories by IV.7.8 \cite{sheaves_geometry_logic}, so there exists an equivalence relation $R$ such that the following fork is a coequalizer diagram:
\begin{center}

\begin{tikzcd}
R \arrow[r, hook] & {y(X,\mu)\times y(X,\mu)} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & {y(X,\mu)}\arrow[r]&A
\end{tikzcd}
\end{center}

To exploit this, we will utilize the combinatorial method outlined in \cite{caramello_lafforgue} Prop 6.7. For this, we will need to understand internal equivalence relations on the sheaves $yU_{r_1\cdots r_n}$. We use \ref{multiproduct} to yield the following description of an equivalence relation. \newline
\indent A relation is a subobject 
\[R\hookrightarrow yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n}=\bigsqcup_{\substack{\sum_i t_{ij}=r_j \\ \sum_j t_{ij}=r_i}  }yU_{t_{ij}}\]
As these representable functors are atoms, this is equivalent to giving a subset of the set $S_{r_1\cdots r_n}:=\{(t_{ij})_{0\leq i,j \leq n} | \sum_i t_{ij}=r_j,\, \sum_j t_{ij}=r_i \}$ of matrices whose rows and columns sum to the $r_i$'s. We use Definition 6.5 (iii) \cite{caramello_lafforgue} to see that a relation is an equivalence relation iff it fulfils the following conditions:
\begin{enumerate}
\item Reflexivity:  The element induced by the diagonal $\Delta: yU_{r_1\cdots r_n}\rightarrow $\linebreak $ yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n}$ is in $R$ i.e. the following matrix is in $R$:
\[ \begin{bmatrix}
    r_{1}       & 0 & \dots & 0 \\
    0      & r_2 &  \dots &0 \\
    \vdots & \vdots &  \ddots& \vdots\\
    0       & 0& \dots & r_n
\end{bmatrix} \] 
\item Symmetry: $R$ is invariant under swapping the factors of the product $ yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n}$ i.e. if $T\in R$ then so is its conjugate $T^\top$.
\item Transitivity: Given $(t^{(1)}_{ij})\in R$ and $(t^{(2)}_{jk})\in R$ and $(t_{ijk})$ corresponding to an atom of $yU_{r_1\cdots r_n}\times yU_{r_1\cdots r_n} \times yU_{r_1\cdots r_n}$ such that its images in the product of the first resp. last two components are $(t^{(1)}_{ij})$ resp. $(t^{(2)}_{jk})$ i.e.:
\[\sum_k t_{ijk}=t^{(1)}_{ij} \quad \sum_i t_{ijk}=t^{(2)}_{jk} \]
Then its image in the product of the first and third component lies in $R$ i.e.:
\[(t^{(3)}_{ik})\in R \text{ where }t^{(3)}_{ik}:=\sum_j t_{ijk}    \]
Geometrically:
%Geometrically, this means that for every $3$-dimensional matrix with values in $\mathbb{R}_{\geq 0}$, if the sums of the entries in two of the directions are  matrices in $R$, then so is the third:
\end{enumerate}
\begin{center}
\begin{tikzcd}[row sep=small, column sep= small]
             & t^{(2)}_{n1}                                  &              & t^{(2)}_{nn}                                                     &              &                                               &              \\
t^{(3)}_{n1} & t_{n11} \arrow[l, "\sum"'] \arrow[u, "\sum"'] & \cdots       & t_{n1n} \arrow[u, "\sum"']                                       &              &                                               &              \\
             & \vdots                                        & \ddots       & t_{11}^{(2)}                                                     & \ddots       & t^{(2)}_{1n}                                  &              \\
t^{(3)}_{nn} & t_{nn1} \arrow[l, "\sum"']                    & t^{(3)}_{11} & t_{111} \arrow[rd, "\sum"] \arrow[l, "\sum"'] \arrow[u, "\sum"'] & \cdots       & t_{11n} \arrow[rd, "\sum"] \arrow[u, "\sum"'] &              \\
             &                                               & \ddots       & \vdots                                                           & t^{(1)}_{11} & \vdots                                        & t^{(1)}_{1n} \\
             &                                               & t^{(3)}_{1n} & t_{1n1} \arrow[rd, "\sum"] \arrow[l, "\sum"']                    & \cdots       & t_{1nn} \arrow[rd, "\sum"]                    &              \\
             &                                               &              &                                                                  & t^{(1)}_{n1} &                                               & t^{(1)}_{nn}
\end{tikzcd}
\end{center}
\indent One can generate an equivalence relation by intersecting all those, which contain a given set of the matrices. This can be seen as some kind of \emph{game}, where on starts with some matrices and then constructs all other possible ones with these $3$ "moves".


\begin{remark} 
$3$-dimensional non-negative real matrices whose rows sum to three prescribed matrices on the sides have been investigated in combinatorics literature under the name "\emph{3-way axial transportation polytope}", which they form as a subset of $\mathbb{R}^{n\times n\times n}$. See for instance \cite{3way}.\end{remark}%Do we need this?


\begin{definition} Given a non-negative real matrix $M\in \mathbb{R}^{n^2}_{\geq 0}$, define the \emph{graph }$\Gamma(M)$\emph{ of }$M$ as the bipartite graph on $\{1, \cdots, n\}\sqcup \{1, \cdots, n\}$ with an edge between $i$ and $j$ iff $M_{ij}\neq 0$. One can also interpret this as a $(0,1)$-matrix.
\end{definition}
\begin{lemma}\label{2x2x2} Given $0<r_1<1$, setting $r_2=1-r_1$, and  a matrix $\begin{bmatrix}
r_1-a & a\\
a &r_2-a
\end{bmatrix}$ with $0\neq a \leq r_1,r_2$, $a\neq 1/2$, the equivalence relation on $yU_{r_1 r_2}$ generated by it are already all matrices in $S_{r_1r_2}$. 
\end{lemma}
\begin{proof} WLOG $r_1\geq r_2$. All matrices in $S_{r_1r_2}$ are of the form as in the statement of the lemma (without the restrictions $a\neq 0,a\neq  1/2$). If we set $t^{(1)}_{ij}=t^{(2)}_{jk}=\begin{bmatrix}
r_1-a & a\\
a &r_2-a
\end{bmatrix}$ then the matrix $t_{ijk}$ has to be if the following form:
\[t_{i1k}=\begin{bmatrix}
r_1-a-b & b\\
b & a-b
\end{bmatrix} \quad t_{i2k}=\begin{bmatrix}
a-c & c\\
c & r_2-a-c 
\end{bmatrix}\]
for $b\leq \min \{a, r_1-a \}$, $c\leq \min \{a,r_2-a\}$. Hence:
\[ t_{ik}^{(3)}=\begin{bmatrix}
r_1-b-c &b+ c\\
b+c & r_2-b-c 
\end{bmatrix}
\]
Setting $a'=b+c$, these are precisely all the matrices such that $a'\leq \min\{2a, r_1, r_2, r_1+r_2-2a   \}=\min \{2a,r_2, 1-2a \}$. We will iteratively expand the set of  values $a$ such that the equivalence relation generated by them is $S_{r_1r_2}$. 
Clearly this holds for all $a\in [\frac{r_2}{2},\frac{ r_1}{2}  ]$ (and $a\leq r_2$ we will always implicitly assume this condition in what follows).\newline
\indent For $n\geq 1$ and $a\in [\frac{r_2}{2^{n+1}},\frac{r_2}{2^n})\cup (\frac{1}{2}-\frac{r_2}{2^n}, \frac{1}{2}-\frac{r_2}{2^{n+1}}] $, choose $a'=\frac{r_2}{2^n}$. Thus for any starting point $a\in (0,\frac{1}{2})$, we can generate, after finitely many steps, some $a\in  [\frac{r_2}{2},\frac{ r_1}{2}  ]$ and hence everything. 
\end{proof}
\begin{theorem}
The atoms of the topos $\mathfrak{Prob}$ correspond to tuples $(M, \mu, H)$ where $(M,\mu)$ is a finite probability space and $H\leq Aut(M,\mu)$ a subgroup of its automorphism group.
\end{theorem}
\begin{proof}
Given an equivalence relation $R$ on $yU_{r_1\cdots r_n},$ we will conclude the proof via a sequence of reduction steps.\newline
\newline
\emph{Step 1.} If there exists a matrix $M\in R$ such that the associated $(0,1)$-matrix is not a permutation matrix then there exists a node $l\in \{1,\cdots,n\} \sqcup\{1,\cdots,n\}$in its graph with at least two neighbours, WLOG, by reordering, the nodes $1$ and $2$. By symmetry, we may assume $l$ lies in the first component. Setting, as in the description of transitivity as before, $t^{(1)}_{ij}=M$, $t^{(2)}_{jk}=M^\top$, we seek to find an appropriate $n\times n \times n$-matrix for some matrix $L$ in the following block diagonal form
\[ \begin{bmatrix}
    a_{11}      & a_{12} & 0&\dots & 0 \\
    a_{21}     & a_{22} &  0&\dots &0 \\
    0 & 0& r_3 &\dots & 0\\
    \vdots & \vdots & \vdots &  \ddots& \vdots\\
    0       & 0& 0 & \dots & r_n
\end{bmatrix} \] 
such that $a_{ij}\neq 0$. One can achieve this by setting for $j\neq l$: $t_{ijk}=\begin{cases}  m_{ij} &\text{if }i=k \\ 0 & \text{else}  \end{cases}$ and $(t_{ilk})_{0\leq i,k\leq n}$ to be the following matrix for some $\min\{m_{1l},m_{2l}\}>\epsilon> 0$:
\[ \begin{bmatrix}
    m_{1l}-\epsilon  & \epsilon & 0&\dots & 0 \\
  \epsilon     &m_{2l}-\epsilon &  0&\dots &0 \\
    0 & 0& m_{3l} &\dots & 0\\
    \vdots & \vdots & \vdots &  \ddots& \vdots\\
    0       & 0& 0 & \dots & m_{nl}
\end{bmatrix} \] 
$L$ is then defined to be the sum of these matrices.
\newline
\newline
\emph{Step 2.} Now we can generate the smallest equivalence relation containing $L$. We set $t_{ij}^{(1)}=t^{(2)}_{jk}=L$ and construct all 3-dimensional matrices $t_{ijk}$ with these faces. Clearly, for tuples $ijk$ such that at least one $i>2$, $j>2$ or $k>2$, we must have $t_{ijk}=\begin{cases} r_i &\text{if }i=j=k \\ 0 &\text{else}  \end{cases}$. Hence the problem reduces (up to scaling) to the statement of the previous lemma \ref{2x2x2}. It is applicable as non of the entries are zero and hence the $a$, in the notation of the lemma, is neither $0$ nor $\frac{1}{2}$. The smallest equivalence relation containing $L$ is thus the set of all matrices in the same block-diagonal form as $L$. This can easily be seen to be the equivalence relation $R_{1,2}$ associated the quotient map  $yU_{r_1\cdots r_n}\rightarrow yU_{(r_1+r_2),r_3\cdots r_n}$ sending $1, 2\mapsto 1$ and $j\mapsto j-1$ for $j> 2$.
\newline
\newline
\emph{Step 3.} Replace $R$ on $yU_{r_1\cdots r_n}$ by  the equivalence relation $\tilde{R}$ on $yU_{(r_1+r_2),r_3\cdots r_n}$ defined as what is left over after quotienting out $R_{1,2}$. Repeat these steps until the condition of step 1 is no longer fulfilled. This will terminate as $n$ is finite.\newline
\newline
\emph{Step 4.} The $(0,1)$-matrices of all matrices in $R$ are permutation matrices. The conditions on matrices in $S$ impose that these matrices are automorphisms of $U_{r_1\cdots r_n}$. It remains to prove that they form a subgroup of $S_n$. One can check that $\sigma^\top=\sigma^{-1}$ and the only matrix that can appear as $t^{(3)}_{ik}$ if we set $t^{(1)}_{ij}=\sigma$ and $t^{(2)}_{jk}=\tau$, is $\sigma \tau^{-1}$. It also contains the unit of $S_n$ by reflexivity. Hence it is a subgroup.
\newline
\newline
This concludes the proof as all atoms are quotients of equivalence relations and the relations. The representable functors appear as $(X,\mu, \{id\})$.
\end{proof}

\begin{lemma} \label{atoms_are_sheaves} Given a finite probability space $(X,\mu)$ and a subgroup $H$ of its automorphism group, we compute the sheaf-theoretic quotient of the corresponding equivalence relation in $\text{Sh}(FinProb,J_{at})$ to be:
\[ \mathcal{F} :(N,\nu)\mapsto\text{FinProb}((N,\nu), (X,\mu))/\sim  \]
where $f\sim g$ if there exists $\sigma\in H$ with $ \sigma\circ f=g$. These are partitions up to permutation by elements in $H$.
\end{lemma}
\begin{proof}
One calculates coequalizers in sheaf topoi by calculating the section-wise coequalizer and then sheafifying. The quotient the equivalence relation $R$ associated to $U$ is given by the coequalizer of the composition of the maps
% TODO: Maybe explain previously what they quotients of equivalence relations are
\begin{center}

\begin{tikzcd}
\bigsqcup_{\sigma \in H}y(X,\mu) \arrow[r, hook] & {y(X,\mu)\times y(X,\mu)} \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & {y(X,\mu)}
\end{tikzcd}
\end{center}
Here the components on the left are included as permutation matrices. These compositions are coproducts of the Yoneda embeddings of $id: (X,\mu)\rightarrow (X,\mu)$ resp. $\sigma: (X,\mu)\rightarrow (X,\mu)$. Thus the quotient presheaf is the sheaf described in the statement.\newline
\indent Sheafification is not needed in our case however as the presheaf given in the statement is a sheaf:  We seek to apply the criterion \ref{sheaf_condition_weak}. We need to check that the following is an equalizer diagram for any $f:(Z,\lambda)\rightarrow (Y,\nu)$:
\[
\begin{tikzcd} \mathcal{F} (Y,\nu) \arrow[r, "\mathcal{F}f"] & \mathcal{F} (Z,\lambda) \arrow[r, "\pi_1", shift left] \arrow[r, "\pi_2"', shift right] & \mathcal{F} (Z \times_f Z,\bar{\lambda})
\end{tikzcd} ,
\]

First notice that $\mathcal{F} f$ is injective and its image consists of precisely the $[s] \in \mathcal{F}(Z,\lambda)$ such that $s$ is constant on each fiber of $f$. We want to prove that these elements are precisely the ones with $\pi_1([s]) = \pi_2([s])$.

Since the diagram above is always a fork, we just need to to prove that the elements $[s] \in \mathcal{F}(Z,\lambda)$ such that for some $\sigma \in H$, $s \circ \pi_1 = \sigma \circ s \circ \pi_2$, are already constant on the fibers of $f$. Elementwise, our assumption on $s$ is that for all $x,y$ with $f(x) = f(y)$ we have that
\[
    s (x) = \sigma (s y) .
\]

Notice that this immediately implies that $s$ must be constant on the fibers of $f$.
\end{proof}

\begin{remark} The automorphism groups aren't all that complicated. Note that $\text{Aut}(X,\mu)\simeq \prod_{r\in (0,1)} S_{\{x\in X| \mu(x)=r \}}$.
\end{remark}

Now we are able to describe the category of atoms of $\mathfrak{Prob}$ in a very combinatorial manner. 

\begin{theorem} The category $\mathfrak{Prob}_{at}$ is equivalent to the following category. \begin{enumerate}
\item Objects are given by tuples $(M,\mu, V)$ where $(M,\mu)$ is a finite probability space and $V$ is a subgroup of its automorphism group. 
\item Morphisms $[f]:(M,\mu, V)\rightarrow (N,\nu, U)$ are given by equivalence classses of measure-preserving functions $f:(M,\mu)\rightarrow (N,\nu)$ such that for any $\sigma\in V$ there exists a $\psi\in U$ with $f\circ \sigma =\psi\circ f $; with $f\sim g$ if there exists $\sigma\in U$ with $f=\sigma\circ g$.
\end{enumerate}
\end{theorem}
\begin{proof}
%We use Theorem 6.7 of \cite{caramello_lafforgue}.
We can Yoneda embed $\mathfrak{Prob}_{at}$ into $\mathfrak{Prob}$.  By the Yoneda lemma, a morphism $y(M,\mu)\rightarrow y(N,\nu)/U$ corresponds to an element of $(y(N,\nu)/U)(M,\mu)$. This has been computed to be maps $(M,\mu)\rightarrow (N,\nu)$ up to permutation by $\sigma\in U$. A morphism $y(M,\mu)/V \rightarrow y(N,\nu)/U$ is simply a morphism such that $y(M,\mu)\rightarrow y(N,\nu)/U$ factors over the quotient map $y(M,\mu)\rightarrow y(M,\mu)/V$. This means it is a morphism $f:(X,\mu)\rightarrow (Y,\nu)$ such that for any $\sigma\in V$ there exists a $\psi\in U$ such that $f\circ \sigma =\psi\circ f $. Hence the statement follows.
\end{proof}

\begin{remark} This shows, in particular that the atoms $y(X,\mu)/U$, $y(X,\mu)/V$ for different subgroups $U$ and $V$, which are not conjugated to each other, are non-isomorphic. % is this true?
\end{remark}

\begin{definition} Denote the category given above by $\mathfrak{Prob}_{at}$ and call it the atomic completion of $FinProb$ in accordance with notation in \cite{caramello_lafforgue}.
\end{definition}
This yields a new site presentation, which we will see is extremely easy to work with.
\begin{corollary} \label{coprod_representation}
    $\mathfrak{Prob}\simeq \text{Sh}(\mathfrak{Prob}_{at},J_{at})$. More concretely, $\mathfrak{Prob}$ is the $\infty$-positivisation of $\mathfrak{Prob}_{at}$. % TODO: What is this even supposed to mean???
\end{corollary}



%TODO: Insert subsection on group-action perspective on all of this here.


\section{$\mathfrak{Prob}$ as a set-theoretical universe}
The findings of the last chapter are so striking, that they allow us to reformulate our constructions, which heavily featured topos theory, in such a way as to not mention topoi in any way whatsoever. The notation introduced there already hints to this possibility. We hope that this makes our theory understandable to a far greater audience. So this chapter is concerned with outlining a translation into the language of set theory.
\begin{definition}[ZFA]  A model of Zermelo-Fraenkel set theory with atoms (or urelements) is a model of the single-sorted first order language with equality relation $=$, membership relation $\in$ and a constant $A$, the set of atoms, with the following axioms:
\begin{center}\begin{tabular}{ |p{3.5 cm}|p{7.5 cm}| }
\hline
Decidability&  $\forall x. (x\in A\vee \neg(x\in A))$  \\ % This seems to be obsolete in classical interpretations
\hline
Set & $\forall y. (\exists x.x\in y\implies \neg (y\in A))$\\
\hline
Extensionality & $\forall x,y. \neg(x\in A)\wedge \neg(y\in A)\implies [ x=y\iff \forall z.(z\in x \iff z\in y) ] $\\
\hline
Pairing & $\forall x,y \exists z. (x\in z \wedge y\in z)$ \\
\hline
Separation & $\forall x \exists y. \neg (y\in A)  \wedge\exists z. (z\in y\iff z\in x \wedge \phi)$ for $x$ not free in $\phi$. \\
\hline
Union &$\forall x \exists y\forall z. (z\in y\iff \exists w\in x.z\in w)$ \\
\hline
Power-set &$\forall x\exists y \forall z. (z\in y\iff \forall w\in z.w\in x)$ \\
\hline
Infinity & $\exists x(\exists y.y\in x\wedge \forall y\in x.\exists w\in x.y\in w)$\\
\hline
$\in$-induction &$\forall x.(\forall y\in x. \phi(y)\implies \phi(x))\implies \forall x.\phi(x)$ \\
\hline
Collection & $\forall x (\forall y\in x\exists w.\phi\implies \exists z\forall y\in x \exists w\in z. \phi)$\\
\hline 
\end{tabular}%what is phi?
\end{center}
\end{definition}
\begin{proposition}\label{ZFA} The internal language of a two-valued atomic topos is a classical model of ZFA.
\end{proposition}
\begin{proof} 
This is essentially proved in \cite{set_theory}.
Let $A$ be the coproduct of all the atoms (i.e. one of each isomorphism class).
 Equality is equality but constructing a global membership relation from the datum of a topos is a bit less easy.\newline
\indent We can get bounded membership relations $\in_X\hookrightarrow X\times \Omega^X$ using the cartesian closed structure of our topos.\newline
\indent Now one uses an analogue of the cumulative hierarchy, starting with the set of atoms and then taking power objects and directed colimits just as one would in set-theory. The details can be found in \cite{set_theory}.
\end{proof}
\begin{remark} Models of ZFA like the one given by $\mathfrak{Prob}$ are known as \emph{Fraenkel-Mostowski models} or \emph{permutation models}.
\end{remark}
%Maybe remark that this datum of a set theory is equivalent to that of a topos. Quote the paper corresponding to this fact
\begin{theorem}
In the combinatorial interpretation of our topos we have that $A$ is interpreted as \\\[\bigsqcup_{\substack{0<r_1\leq  \cdots\leq r_n \\ \sum_i r_i=1 \\ [V]\text{ conjugacy class of subgroup }V\subset Aut(U_{r_1\cdots r_n})}} yU_{r_1\cdots r_n}/V\]%it would be better to choose one subgroup per conjugacy class
 with element-hood relation and equality given as in \ref{ZFA}.
 \end{theorem}
 This puts the previous intuition that our topos consists of \emph{sets parametrized by partitions of unity (with subgroups of permutations)} on a firm footing.
\begin{remark}[Non-standard probability theory] We can also use language analogous to that used in the set theoretic constructions of non-standard analysis here \cite{XYZ} . One may call sets containing only elements of the form $yU_1$ \emph{standard sets} and these containing at least one different atom \emph{non-standard}. This works well as the following theorem shows. %Maybe also define "standard parts" of a set as the global sections i.e. the yU1 part. This preserves at least finite limits. Also one asign to an internal set its set of atoms i.e the left adjoint to the inclusion of standard sets. This doesn't preserve finite limits however.
\end{remark}
\begin{theorem} If there is any statement of higher order logic $\phi$ where all quantification is bounded over \emph{standard} sets then $\mathfrak{Prob}\vDash \phi \iff \text{Set}\vDash \phi$.
\end{theorem}
\begin{proof}
We essentially use that the topos $\mathfrak{Prob}$ is atomic. This means, that the inverse image functor $\Delta: \text{Set}\rightarrow \mathfrak{Prob}$ of the global sections functor is logical. This means it preserves higher order logic \cite{XYZ}. Now we use the site $\mathfrak{Prob}\simeq \text{Sh}(FinProb,J_{at})$. Given a set $A$, $\Delta(A)$ is the sheafification of the constant presheaf with values $A$ by \cite{XYZ}. This presheaf can be given as $\bigsqcup_{a\in A}yU_1$, which is already a sheaf as the site is subcanonical.
Hence an object in $\mathfrak{Prob}$ is in its essential image iff it is a standard set. 
\end{proof}
This means, dealing with standard sets is really cheap and easy. Quite the contrast to the monstrous descriptions of e.g. power sets of non-standard sets we have seen above. This has some immediate applications.
\begin{example} The natural numbers $\mathbb{N}$ of $\mathfrak{Prob}$ are a standard set. In particular, all of arithmetic works just the same. %Is the same true for reals? I believe so.
\end{example}
\begin{proof}
The natural numbers object of a Grothendieck topos is always the constant sheaf with value $\mathbb{N}$. \cite{XYZ}.
\end{proof}
Given a probability interval $(\mathcal{B},\mu)$, we get an interpretation (is this the right word?) of $\mathfrak{Prob}$ in $\text{Set}$. %Do this properly with proper language
\begin{proposition}\label{choice_failture} The internal language of our topos proves the negation of countable choice.
\end{proposition}
\begin{proof} We construct a countable product of non-empty objects, which is empty. Take $yU_{1/n}$ to be the representable functors of the finite probability space with two elements and measure $1/n$ on one of them. Then the multi-limit of this family is empty as there is no finite probability space with a sequence of elements $x_n$ with measures $1/n$. We conclude $\prod_n yU_{1/n}=0$.
\end{proof}

This proof can, in fact be adapted in many situations, to suggest that most countable products of objects are empty. So there is really not much hope to extend the transfer principle to statements containing countably infinitely many variables or more.
\begin{remark} All this is not too exotic, so in practice one may just pretend to work formally in ZFA as one usually pretends to do so in ZFC. The only thing one has to be vary of is the failure of the axiom of choice. But as the proof of the last proposition suggests, the failure of the axiom of choice can be strictly controlled using fairly straight forward multi-product calculations.
\end{remark}


\section{Outlook for further research}

Sheaves and shit maybe? The Grothendieck construction and shit. I don't know how much of it we should mention. We could give the explicit site description and say we think it has all the nice properties. But the technical difficulties are too big and would take up too much time to give them in this paper etc.

Thinks that should go in here:
\begin{enumerate}
    \item $\mathfrak{Rand}$ and the Grothendieck construction. 'Random vectors spaces', 'random groups', etc. as vectors spaces, groups, etc. internal to $\mathfrak{Rand}$.
    \item Difficulties in looking at $L^0$, despite internal completeness. Discussion of the failture of the axiom of choice. Non-open stabilizers.
    \item Philosophically, argue for a solution using internal sheaves over the simple functions, cite Vickers(and maybe someone else) and his ideas in formal topology(this must be explained very well). He does geometric mathematics in 'A monad of valuation locales' and also uses simple functions as a proxy for $L^0$.
    \item Far future: One might expect our 'canonical' framework for probability theory to have much better formal properties than models by intervals in $Set$. Thus, geometry might be better behaved when using the universal $L^0$ as a base for 'random field stuff'(cite the random fields book!)
    \item A sure bet: Repeat the logical analysis in this paper for many other atomic topoi. More conceptual proofs for algebraically closed fields and real closed fields? Quantifier elimination in infinitary logic as a weaker version of usual q-elim.
    \item The technique that we use for proving that the simple functions are all geometrically equivalent looks extremely easy to reproduce in other contexts. E.g. free modules over algebraically closed fields?
\end{enumerate}

We will now investigate even further what can be said in the theory of expectation algebras about simple functions on probability intervals.
\begin{lemma} Any atomic formula in $\mathbb{T}_{exp}$ is $\mathbb{T}_{exp}$-provably equivalent to one of the form $x_1,\cdots, x_n. E_0(f(x_1,\cdots,x_n))$ where $f\in \mathbb{R}[X_1,\cdots, X_n]$ is a real polynomial. 
\end{lemma}
\begin{proof}
\[ E_r(f(x_1,\cdots, x_n))\dashv \vdash E_0(f(x_1,\cdots, x_n)-r\cdot 1)    \]
\[ f(x_1,\cdots, x_n)=g(x_1,\cdots ,x_n)\dashv\vdash E_0((f(x_1,\cdots, x_n)-g(x_1,\cdots ,x_n))^2)  \]
\end{proof}
\subsection{Transfer results for $L^p$-spaces}
We will now try to transfer statements between $L^p(X,\mu)$ for probability intervals $(X,\mu)$. The key insight is that we know how to transfer statements about simple functions and simple functions are dense in the metric spaces $L^p$. Another insight is, that every bounded, measurable function on a probability space is integrable. So $L^\infty(X,\mu)$ is an expectation algebra, in particular, for any probability interval $(X,\mu)$ in Set.
\begin{definition} For a expectation algebra $S$ we define:
\begin{enumerate}
\item $f\geq g$ if $\exists h. h^2=f-g$
\item For $p$ an even integer, $||f||_p=r$ if $E_{r^p}(f^p)$
\item $||f||_\infty=r$ if $\bigwedge_{k\in\mathbb{N}}\bigvee_{N\in\mathbb{N}}\bigwedge_{n\geq N}\bigvee_{-1/k\leq s\leq 1/k}||f||_{2n}=r+s$
\end{enumerate}
\end{definition}
The last definition is motivated by the fact that for the algebras simple functions and bounded functions, we have
\[  \lim_{n\rightarrow \infty} ||f||_n=||f||_\infty. \]
Note that the fact that all statements of the previous definition are infinitary first order, we can transfer statements using them between algebras of simple functions. The next step will be to give a suitable notion of a statement that "spreads out" as to allow one to only check in on simple functions. Be not afraid of the complicated looking formulas that follow.
\begin{definition} Given a quantifier free infinitary first order formula\linebreak $\Phi(f_1,\cdots, f_n)$ in the theory of expectation algebras. Then we call $\Phi$ \emph{spreading} if 
\[\forall f_1\cdots \forall f_n.( \Phi(f_1,\cdots, f_n)\implies \bigvee_{k\in \mathbb{N}}\forall g_1,\cdots, \forall g_n.(\bigwedge_{i=1}^n\bigvee_{\epsilon\leq 1/k}||f_i-g_i||_{\infty}=\epsilon\implies \Phi(g_1,\cdots g_n))) \]
holds in $\mathcal{S}$.\newline
\indent  Given an infinitary first order formula $\Phi(f_1,\cdots, f_n)$ in the theory of expectation algebras, written it in prenex normal form
\[\forall x_1\cdots \forall x_n \exists y_1\cdots \exists y_m \forall x_{n+1}\cdots \forall x_{n+l}\cdots \Psi(f_1,\cdots f_n, x_1,\cdots, x_N, y_1\cdots y_M) \]
for $\Psi$ quantifier free. Then we call $\Phi$ \emph{spreading} if $\Psi$ is spreading.
\end{definition}
This should be interpreted as stating that, given $\Phi$ holds for some simple functions, it holds for all simple function in a small $L^\infty$-neighbourhood around them. Note also that the statement that a formula spreads is stated in infinitary first order language, so it can be transferred. In particular, it suffices to check it for some algebra of simple functions in Set. In that case, we see that it reduces to check the aforementioned statement without having to think about the complicated formulation we state above.
\begin{theorem}
Given a spreading formula $\Phi(f_1,\cdots,f_n)$, then for all probability intervals $(X,\mu)$ and $(Y,\nu)$ in Set, we have:
\[(L^\infty(X,\mu)\vDash \Phi)\iff(L^\infty(Y,\nu)\vDash\Phi)  \] 
\end{theorem}
\begin{proof}
$(L^\infty(X,\mu)\vDash \Phi)\iff (\mathcal{S}\vDash \Phi)$ as $\Phi$ is spreading and $S(X,\mu)$ is dense. Then apply the transfer lemma. PROVE THIS
\end{proof}


\section{Appendix: Models in Set}

NOTE: THIS SECTION SHOULD PROBABLY BE KILLED

In this section, we show that the $Set$-based models of $Sh(FinProb, J_{at})$ are precisely certain infinite boolean probability algebras(in the sense defined below). This will be useful for the reader that is uninterested in seeing the general result about models in an arbitrary topos proved, since the proof here is easier to understand.


The models we want to compute are given by the $J_{at}$-flat functors\linebreak
 $Flat_{J_{at}}(FinProb, Set)$, so first we will use 
\[
Flat(FinProb, Set) \simeq Ind(FinProb^{op})
\]
to show that the flat functors consist precisely of the boolean probability algebras.

\begin{definition}
\begin{enumerate}
\item Let $B$ be a boolean algebra. We say a map $\mu: B \to \mathbb{R}_{\geq 0}$ is a measure if for elements $a,b \in B$, the following holds:
\begin{itemize}
\item $\mu(a) = 0$ if and only if $a = 0 $,
\item $\mu(a) + \mu(b) = \mu(a \vee b) + \mu(a \wedge b)$.
\end{itemize}
We will call a pair $(B, \mu)$ of a boolean measure and a measure a boolean measure algebra. If moreover $\mu(1) = 1$, we say that $\mu$ is a  probability measure and $(B,\mu)$ a boolean probability algebra.
\item We define a measure-preserving map $(B, \mu) \to (C, \nu)$ between boolean measure algebras to be a map of boolean algebras $f: B \to C$ satisfying
\[
\nu(f(x)) = \mu(x)
\]
for all $x \in B$. We will denote the category of boolean probability algebras with measure-preserving maps by $BPAlg$.
\item Denote the full subcategory of $BPAlg$ given by the finite boolean probability algebras by $BPAlg_f$.
\end{enumerate}
\end{definition}

% The reader will immediately notice that we are not considering any sort of $\sigma$-additivity. At first this will seem a bit unfamiliar, but by 416Qb in \cite{fremlin}, our measures on boolean algebras correspond precisely to Radon measures on the corresponding Stone space(without nontrivial sets of measure zero). This means that we should think about boolean probability algebras as a very special subset of the probability spaces traditionally considered in probability theory.  Whether this is to be interpreted as an indication of insufficiency of interesting probability theory is up to the readers judgement.

Note that we do not allow any nontrivial elements of measure zero. Moreover, the one-element boolean algebra cannot be made into a boolean probability algebra.

Before we get to prove anything interesting, we need to get the following out of the way:

\begin{proposition} We have an equivalence of categories
\[
FinProb^{op} \simeq BPAlg_f
\]
defined by sending a finite probability space $(X, \mu)$ to the finite boolean probability algebra $(\mathcal{P} X, \bar{\mu})$, where
\[
\bar{\mu}(S) := \sum_{x \in S} \mu(x).
\]
A map in $FinProb$ is sent to the preimage map on powersets.
\end{proposition}
\begin{proof}
    First we show a measure-preserving map $f: (X,\mu) \to (Y,\nu)$ in $FinProb$ is sent to a measure-preserving map $f^{-1}: (\mathcal{P}X, \bar{\mu}) \to (\mathcal{P}Y, \bar{\nu})$. So let $S \in \mathcal{P} Y$.
    \begin{align*}
    \bar{\mu}(f^{-1} S) &= \sum_{x \in f^{-1} S} \mu x \\
    &= \sum_{y \in S} \sum_{x \in f^{-1} y} \mu x \\
    &= \sum_{y \in S} \nu y \\
    &= \bar{\nu} S
    \end{align*}

    The facts that this functor is full, faithful and essentially surjective on objects are instantly verified.
\end{proof}

From now on we will implicitly use this equivalence and use $FinProb$ or $BPAlg_f$ depending on which variance more convenient.
For computing the $Ind$-completion of $FinProb^{op} \simeq BPAlg_f$ , first notice that for Lawvere theories we have that the forgetful functor into $Set$ creates filtered colimits. This is a special case of theorem 5.6.5 ii) in \cite{riehl}, if one uses the well-known correspondence between finitary monads and Lawvere theories. Using this explicit description of the underlying set of a filtered colimit of boolean algebras, we can define filtered colimits in $BPAlg$:

\begin{theorem} 
If $(B_i, \mu_i)$ is a filtered diagram of boolean probability algebras and $B := colim_i B_i$ is the colimit of the underlying boolean algebras, we have that
\[
colim_i (B_i, \mu_i) \cong (B, \mu),
\]
where for $a \in B_i$, $\mu([a]) := \mu_i(a)$.
\end{theorem}
\begin{proof}
First note that $\mu$ is well-defined, because the maps in the diagram preserve the measure. Moreover, we can check the axioms of a measure WLOG for $a,b \in B_i$:
\begin{itemize}
\item $\mu([a]) = 0 \Leftrightarrow \mu_i(a) = 0 \Leftrightarrow a = 0$
\item $\mu(1) = \mu_i(1) = 1$
\item \begin{align*}
\mu([a] \vee [b]) + \mu([a] \wedge [b]) &= \mu([a \vee b]) + \mu([a \wedge b]) \\
&= \mu_i(a \vee b) + \mu_i(a \wedge b) \\
&= \mu_i(a) + \mu_i(b) \\
&= \mu([a]) + \mu([b])
\end{align*}
\end{itemize}
To see that this is actually a colimit, let $(C, \nu)$ be a boolean probability algebra and $f_i : (B_i, \mu_i) \to (C, \nu)$ be maps suitably commuting with the filtered diagram. We need to show that these maps factor through the inclusions into $(B, \mu)$ uniquely. First notice, that by looking at the underlying boolean algebras, we certainly get a unique map $\psi: B \to C$.  It only remains to show it is measure-preserving, so let $a \in B_i$.
\[
\nu(\psi [a]) = \nu(f_i a) = \nu_i(a) = \mu_i(a) = \mu([a]),
\]
so we have shown how to construct filtered colimits.
\end{proof}

Now we are ready to prove the following fact:

\begin{theorem} \label{ind} We have an equivalence of categories
\[
Ind(BPAlg_f) \simeq BPAlg
\]
given by sending a formal filtered colimit to the corresponding filtered colimit of boolean probability algebras.
\end{theorem}
\begin{proof}
Morphisms between two diagrams $F$, $G$ in $BPAlg_f$ in the $Ind$-completion are defined by
\[
lim_d colim_c BPAlg_f(F d, G c).
\]
In order to define the equivalence on morphisms, we would like to construct an isomorphism
\[
lim_d colim_c BPAlg_f(F d, G c) \cong BPAlg(colim F, colim G).
\]
We do this by showing compactness of the finite probability algebras. Let $(C, \mu)$ be a finite probability algebra and $(B_i, \mu_i)$ be a filtered diagram with colimit $(B, \mu)$. We want to show that the map
\[
\kappa: colim_i Hom((C, \nu), (B_i, \nu_i)) \to Hom((C,\nu), (B,\mu))
\]
is in fact a bijection.

To show it is injective, let $\kappa([f]) = \kappa([g])$ with WLOG $f,g \in Hom((C,\nu), (B_i, \nu_i))$. This means we have a fork
\[
\begin{tikzcd}
{(C,\nu)} \arrow[r, "f", shift left] \arrow[r, "g"', shift right] & {(B_i,\mu_i)} \arrow[r] & {(B,\mu)},
\end{tikzcd}
\]
which of course gives us a fork
\[
\begin{tikzcd}
C \arrow[r, "f", shift left] \arrow[r, "g"', shift right] & B_i \arrow[r] & B,
\end{tikzcd}
\]
which by compactness of $C$ implies that $[f] = [g]$ in $colim_i Hom(C,B_i)$ and thus also in $colim_i Hom((C,\nu), (B_i, \nu_i))$. This shows injectivity.

To prove surjectivity, let $f:(C, \nu) \to (B,\mu)$ be a map. By compactness of $C$, it factors through an inclusion:
\[
\begin{tikzcd}
{(C,\nu)} \arrow[r, "\hat{f}" description, dotted] \arrow[rd, "f"'] & {(B_i,\mu_i)} \arrow[d, "\iota_i"] \\
                                                                & {(B,\mu)}                         ,
\end{tikzcd}
\]
where in fact $\hat{f}$ is measure-preserving since $\mu_i(\hat{f} x) = \mu(\iota \hat{f} x) = \nu x$. This concludes the proof of surjectivity and thus we have proven that we have a fully faithful functor $Ind(BPAlg_f) \to BPAlg$.

In order to show this functor is essentially surjective on objects, we need to show that every boolean probability algebra is a filtered colimit of finite probability algebras. So let $(B, \mu)$ be a boolean probability algebra. Certainly, we can write the underlying boolean algebra as a filtered colimit of finite boolean algebras
\[
B \cong colim_i B_i.
\]
Then the inclusions $\iota_i: B_i \to B$ let us induce a measure $\mu_i$ on $B_i$ ($\mu_i(x) := \mu(\iota_i x)$). To show that this is a diagram in $BPAlg$, notice that for an arrow $f: i \to j$ in the indexing category, we get a commutative diagram
\[
\begin{tikzcd}
{(B_i,\mu_i)} \arrow[r, "B_f"] \arrow[rd, "\iota_i"'] & {(B_j,\mu_j)} \arrow[d, "\iota_j"] \\
                                                      & {(B,\mu)}                         ,
\end{tikzcd}
\]
where in fact, $B_f$ is measure-preserving since $\iota_i$ and $\iota_j$ are measure-preserving.

Now the colimit of the $(B_i, \mu_i)$ is in fact $(B, \mu)$ by the previous theorem. This concludes the proof.
\end{proof}

Before the reader reads the next proof, he is advised to read the remarks about boolean probability algebras in \ref{partitions}.

\begin{theorem} The category of points of the topos $\textbf{Sh}(FinProb,J_{at})$ is equivalent to the full subcategory of $BPAlg$ of boolean probability algebras $(B,\mu)$ such that for each $r\in (0,1)$ and each $b\in B$ there exist $b', b''\in B$ with $b'\vee b''=b$, $b'\wedge b''=0$ and $\mu(b')=r\mu(b)$.\end{theorem}
\begin{proof} The category of points is given by the category of $J_{at}$-flat functors $Flat_{J_{at}}(FinProb, Set)$.  The equivalence 
\[
Flat(BPAlg_f^{op}, Set) \simeq Ind(BPAlg_f) \simeq BPAlg
\]
shows that the flat functors are precisely the $BPAlg(-,(B,\nu))$ for a boolean probability algebra $(B,\nu)$. As the covering sieves consist of single morphisms, the $J_{at}$-flat functors will consist of the $BPAlg(-,(B,\nu))$ for which all maps in $BPAlg_f$ are sent to epimorphisms. This is equivalent to the existence of measure-preserving lifts:
\begin{center}
\begin{tikzcd}
{(A_1, \mu_1)} \arrow[r, "g"] \arrow[rd, "f"'] & {(A_2,\mu_2)} \arrow[d, "\bar{f}" description, dotted] \\
                                               & {(B,\nu)}                                 
\end{tikzcd}
\end{center}
for any $(A_1,\mu_1), (B_1,\mu_1)$ in $BPAlg_f$ and measure-preserving maps $f,g$. The atoms $a_i$ in $A_1$ give us a partition that gets preserved by $f$ and $g$. Thus we get decompositions (see \ref{partitions}) of $A_2$ and $B$ and our problem decomposes into finding measure-preserving lifts

\begin{center}
\begin{tikzcd}
2 \arrow[r] \arrow[rd] & I(g a_i) \arrow[d, "\bar{f}^i" description, dotted] \\
                                               & I(f a_i)
\end{tikzcd}.
\end{center}
But $2 := \{0, 1\}$ can be ignored. Furthermore, $I(g a_i)$ is finite, so by $\ref{partitions}$, such a map $\bar{f}^i$ is precisely a partition $x_1, \cdots, x_m$ of $B^i$ into a fixed number of elements that have a predetermined measure.

We can summarize our findings as follows: $BPAlg(-, (B,\nu))$ is $J_{at}$-flat if and only if every $x \in B$ and numbers $p_1, \cdots, p_m \in \mathbb{R}_{>0}$ such that $p_1 + \cdots + p_m = \nu(x)$, there exists a partition of $I(x)$ into elements $x_i$ of measure $p_i$. Of course, the binary case suffices and we get our claim.
\end{proof}


\begin{thebibliography}{9}
\bibitem{sheaves_geometry_logic} 
Saunders Mac Lane, Ieke Moerdijk. \textit{Sheaves in Geometry and Logic} A First Introduction to Topos Theory.
\bibitem{elephant}
ELEPHANT
\bibitem{caramello_book}

\bibitem{fremlin}
FREMLIN
\bibitem{riehl}
Category theory in context
\bibitem{caramello_lafforgue}
Caramello, Olivia, and Laurent Lafforgue. "Some aspects of topological Galois theory." Journal of Geometry and Physics 142 (2019): 287-317.
\bibitem{caramello}
 Caramello, Olivia. "Topological Galois Theory". arXiv e-prints (2013):  1301.0300
\bibitem{set_theory}
Michael P. Fourman. "Sheaf models for set theory". Journal of Pure and Applied Algebra 19 (1980): 91 - 101
\bibitem{matrix}
Brualdi, R."Combinatorial Matrix Classes".Encyclopedia of Mathematics and its Applications. Cambridge  (2006): Cambridge University Press.
\bibitem{3way} Jess A. De Loera and Edward D. Kim and Shmuel Onn and Francisco Santos. "Graphs of transportation polytopes". Journal of Combinatorial Theory, Series A 116 8 (2009): 1306-1325
\end{thebibliography}




\end{document}